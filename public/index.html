<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Lashroom by Kalancha CRM</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="robots" content="noindex, nofollow">
    <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
    
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core/locales/uk.global.js'></script>

    <style>
        :root {
            --main-bg: #f4f7fa;
            --panel-bg: #ffffff;
            --text-color: #1a1a1a;
            --gray-text: #6c757d;
            --border-color: #e9ecef;
            --primary-color: #2c3e50;
            --primary-hover: #34495e;
            --danger-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12; 
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        body { font-family: 'Inter', Arial, sans-serif; background: var(--main-bg); margin: 0; padding: 0; color: var(--text-color); font-size: 16px; }
        * { box-sizing: border-box; }
        .auth-bg { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);}
        .auth-card { background: var(--panel-bg); padding: 40px 32px; border-radius: 12px; box-shadow: var(--shadow); width: 360px; max-width: 96vw; text-align: center; }
        .auth-card h1 { font-size: 1.8rem; margin: 0 0 24px 0; }
        .auth-card input { width: 100%; margin-bottom: 16px; padding: 12px 14px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; outline: none; transition: border-color .2s; }
        .auth-card input:focus { border-color: var(--primary-color); }
        .auth-card button { width: 100%; background: var(--primary-color); color: #fff; border: none; font-weight: 600; transition:.2s; cursor:pointer; padding: 12px 14px; border-radius: 8px; font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px;}
        .auth-card button:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .error-msg { color: var(--danger-color); margin-bottom: 12px; min-height: 1.2em; font-weight: 600;}
        
        .crm-layout { display: flex; height: 100vh; }
        .crm-nav { background: var(--primary-color); color: #ecf0f1; width: 240px; flex-shrink: 0; display: flex; flex-direction: column; padding: 1.5rem 0; box-shadow: 5px 0px 15px rgba(0,0,0,0.05); z-index: 10; }
        .crm-nav h1 { font-size: 1.5rem; text-align: center; margin: 0 0 2rem 0; color: #fff; letter-spacing: 1px; }
        .crm-nav ul { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
        .crm-nav li { padding: 1rem 1.5rem; cursor: pointer; border-left: 4px solid transparent; transition: all .2s; }
        .crm-nav li:hover { background-color: rgba(255,255,255,0.05); }
        .crm-nav li.active { background-color: rgba(255,255,255,0.1); border-left-color: var(--success-color); font-weight: 600; }
        .crm-nav .user-info { padding: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); text-align: center; }
        .crm-nav .user-info span { display: block; word-wrap: break-word; font-size: 0.9rem; margin-bottom: 1rem; }
        .crm-nav .user-info button { width: 100%; background: rgba(255,255,255,0.1); border: 1px solid #fff; color: #fff; padding: 0.75rem; border-radius: 6px; cursor: pointer; }
        .crm-nav .user-info button:hover { background: var(--danger-color); border-color: var(--danger-color); }

        .crm-main { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .crm-header { background: var(--panel-bg); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .crm-header h2 { font-size: 1.5rem; margin: 0; }
        .crm-content { flex-grow: 1; padding: 2rem; overflow-y: auto; display: flex; justify-content: center; }
        .content-wrapper { width: 100%; max-width: 1200px; }

        .content-card { background: var(--panel-bg); padding: 2rem; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 2rem; }
        .content-card h2, .content-card h3 { margin-top: 0; color: var(--primary-color); }
        .item-list { padding: 0; list-style: none; margin: 0; }
        .item-list li { display: flex; justify-content: space-between; align-items:center; padding: 1rem; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s; }
        .item-list li:hover { background-color: #f8f9fa; }
        .item-list li.is-frozen { opacity: 0.5; background-color: #f8f9fa; }
        .item-list li:last-child { border-bottom: none; }
        .actions { display: flex; gap: 0.5rem; align-items: center; }
        
        .btn, button { font-family: 'Inter', Arial, sans-serif; cursor: pointer; border-radius: 6px; padding: 0.5rem 1rem; font-weight: 600; text-decoration: none; display: inline-block; text-align: center; transition: all .2s; }
        .btn-edit, .btn-delete { border: 1px solid; background-color: transparent; }
        .btn-edit { color: var(--gray-text); border-color: var(--gray-text); }
        .btn-edit:hover { background-color: var(--gray-text); color: #fff; }
        .btn-delete { color: var(--danger-color); border-color: var(--danger-color); }
        .btn-delete:hover { background-color: var(--danger-color); color: #fff; }
        .btn-complete-payment { background-color: transparent; color: var(--success-color); border-color: var(--success-color); }
        .btn-complete-payment:hover { background-color: var(--success-color); color: #fff; }
        
        .form-group { margin-bottom: 1.5rem; }
        .form-group input, .form-group select { appearance: none; -webkit-appearance: none; width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; background-color: #fff; transition: border-color .2s; }
        .form-group select { background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%236c757d%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto; padding-right: 2.5em; }
        .form-group input:focus, .form-group select:focus { border-color: var(--primary-color); outline: none; }
        .form-row { display: flex; gap: 1rem; align-items: flex-end; }
        form button[type="submit"] { background: var(--primary-color); color: #fff; border: none; }
        form button[type="submit"]:hover { background: var(--primary-hover); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-panel { background: #fff; padding: 2rem; border-radius: 8px; width: 450px; max-width: 90vw; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h2 { margin: 0; }
        .close-btn { font-size: 1.5rem; background: none; border: none; cursor: pointer; }
        
        .payment-summary p { margin: 0.5rem 0; display: flex; justify-content: space-between; font-size: 1.1rem;}
        .payment-summary p.total { font-weight: bold; font-size: 1.2rem; border-top: 1px solid var(--border-color); padding-top: 0.5rem; margin-top: 0.5rem;}
        .payment-summary p.remaining { color: var(--danger-color); font-weight: bold; font-size: 1.3rem;}

        .services-layout { display: grid; grid-template-columns: 300px 1fr; gap: 2rem; align-items: start; }
        .category-list-item { cursor: pointer; }
        .category-list-item.selected { font-weight: bold; background-color: var(--main-bg); }
        .price-display { text-align: right; } .price-display .old-price { text-decoration: line-through; color: var(--gray-text); margin-right: 0.5rem; font-size: 0.9em; } .price-display .new-price { font-weight: bold; }
        
        .category-checkbox-group { max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); padding: 1rem; border-radius: 8px; }
        .category-checkbox-group label { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; font-weight: normal; }
        .category-checkbox-group input[type="checkbox"] { appearance: auto; -webkit-appearance: auto; width: auto; }
        
        #final-price-display { font-size: 1.5rem; font-weight: bold; text-align: right; margin-top: 1rem; padding-top: 1rem; border-top: 2px solid var(--primary-color);}
        
        .salary-report-card { background: #fff; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .salary-report-card h3 { margin: 0 0 1rem 0; }
        .salary-report-card p { margin: 0.5rem 0; display: flex; justify-content: space-between; }
        .salary-report-card .total-salary { font-weight: bold; font-size: 1.2rem; color: var(--danger-color); border-top: 1px solid var(--border-color); padding-top: 0.5rem; margin-top: 0.5rem;}
        
        .status-badge { padding: 0.2em 0.6em; border-radius: 10px; font-size: 0.8em; color: white; }
        .status-completed { background-color: var(--success-color); }
        .status-upcoming { background-color: var(--gray-text); }
        .status-partially-paid { background-color: var(--warning-color); }

        #calendar-container { display: flex; flex-direction: column; gap: 1rem; }
        #calendar { height: 80vh; }
        .fc-event { font-size: 0.8em; cursor: pointer; }
        .fc-event-main-frame { text-wrap: wrap; }
        .fc-event.past-event { background-color: #dbe4f0 !important; border-color: #dbe4f0 !important; color: #6c757d;}
        .fc-event-title { font-weight: 600; }
        .fc-event-service { font-size: 0.9em; opacity: 0.8; }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 1.5rem; } th, td { text-align: left; padding: 0.75rem; border-bottom: 1px solid var(--border-color); } th { background-color: var(--main-bg); }
        
        .client-search-container { position: relative; }
        #client-search-results { position: absolute; background: white; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; width: 100%; z-index: 100; max-height: 200px; overflow-y: auto; }
        #client-search-results div { padding: 0.75rem; cursor: pointer; }
        #client-search-results div:hover { background-color: var(--main-bg); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;}
        .stat-card { background-color: var(--main-bg); padding: 1.5rem; border-radius: 8px; text-align: center;}
        .stat-card .value { font-size: 2rem; font-weight: 600; color: var(--primary-color); }
        .stat-card .label { font-size: 0.9rem; color: var(--gray-text); }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1.5rem;
            text-align: center;
        }
        .summary-card {
            background-color: var(--main-bg);
            padding: 1rem;
            border-radius: 8px;
        }
        .summary-card .value {
            font-size: 2rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        .summary-card .label {
            font-size: 0.9rem;
            color: var(--gray-text);
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
<div id="app"></div>

<div class="modal-overlay" id="payment-modal">
    <div class="modal-panel">
        <div class="modal-header">
            <h2>–í–Ω–µ—Å—Ç–∏ –æ–ø–ª–∞—Ç—É</h2>
            <button class="close-btn">&times;</button>
        </div>
        <div id="payment-summary" class="payment-summary">
            <p><span>–ü–æ–≤–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å:</span> <strong id="payment-total-price">0 z≈Ç</strong></p>
            <p><span>–í–∂–µ —Å–ø–ª–∞—á–µ–Ω–æ:</span> <strong id="payment-total-paid">0 z≈Ç</strong></p>
            <p class="remaining"><span>–ó–∞–ª–∏—à–∏–ª–æ—Å—å –¥–æ —Å–ø–ª–∞—Ç–∏:</span> <strong id="payment-remaining">0 z≈Ç</strong></p>
        </div>
        <hr style="margin: 1.5rem 0;">
        <form id="payment-form">
            <input type="hidden" id="payment-appointment-id">
            <div class="form-row">
                <div class="form-group" style="flex:2;">
                    <label for="payment-amount">–°—É–º–∞ –¥–æ —Å–ø–ª–∞—Ç–∏ –∑–∞—Ä–∞–∑</label>
                    <input type="number" id="payment-amount" required min="0.01" step="any">
                </div>
                <div class="form-group" style="flex:1;">
                    <label for="payment-modal-type">–¢–∏–ø –æ–ø–ª–∞—Ç–∏</label>
                    <select id="payment-modal-type">
                        <option value="cash">–ì–æ—Ç—ñ–≤–∫–∞</option>
                        <option value="card">–ö–∞—Ä—Ç–∫–∞</option>
                        <option value="blik">Blik</option>
                    </select>
                </div>
            </div>
            <button type="submit">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –æ–ø–ª–∞—Ç—É</button>
        </form>
    </div>
</div>

<div class="modal-overlay" id="appointment-action-modal">
    <div class="modal-panel">
        <div class="modal-header">
            <h2 id="action-modal-title">–î–µ—Ç–∞–ª—ñ –∑–∞–ø–∏—Å—É</h2>
            <button class="close-btn">&times;</button>
        </div>
        <div id="action-modal-details">
        </div>
        <div id="action-modal-buttons" style="margin-top: 1.5rem; display: flex; flex-direction: column; gap: 0.5rem;">
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, updateDoc, getDocs, getDoc, Timestamp, setDoc, query, where, arrayUnion, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";

    const firebaseConfig = { apiKey: "AIzaSyBoGeREvdgrVSm-S4f3cW0HyB7Us9yh_us", authDomain: "bykalancha.firebaseapp.com", projectId: "bykalancha", storageBucket: "bykalancha.appspot.com", messagingSenderId: "196166318613", appId: "1:196166318613:web:0067f9de531e290e43ec1c", measurementId: "G-V72ECFLKFE" };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const functions = getFunctions(app, 'europe-central2');
    const appContainer = document.getElementById('app');

    let state = {
        user: null,
        salons: [],
        expenses: [],
        selectedCategoryId: null,
        categories: [],
        services: [],
        masters: [],
        appointments: [],
        clients: [],
        settings: { salaryTiers: [] },
        currentView: 'calendar',
        preselectedAppointment: null,
        calendarSelectedMasterId: 'all',
        calendarSelectedSalonId: 'all',
        editingAppointmentId: null,
        editingTierIndex: null,
        selectedClientForAppointment: null,
        viewingClientId: null,
        viewingMasterId: null,
        viewingMasterAdvances: [],
        appointmentsPage: 1,
        appointmentsListDate: new Date(),
    };

    let listenersAreActive = false;
    let masterAdvancesUnsubscribe = null;
    
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            if (listenersAreActive) return;
            appContainer.innerHTML = '<h1>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</h1>';
            
            const userDocRef = doc(db, "users", user.uid);
            const userDocSnap = await getDoc(userDocRef);
            state.user = { 
                uid: user.uid, 
                email: user.email, 
                role: userDocSnap.exists() ? userDocSnap.data().role : 'master',
                salonId: userDocSnap.exists() ? userDocSnap.data().salonId : null
            };

            renderAppLayout(state.user);
            setupRealtimeListeners();
        } else {
            renderLoginView();
            if(masterAdvancesUnsubscribe) masterAdvancesUnsubscribe();
            listenersAreActive = false;
        }
    });

    function setupRealtimeListeners() {
        if (listenersAreActive) return;
        const collections = { 
            salons: 'salons',
            categories: 'serviceCategories', 
            services: 'services', 
            masters: 'masters',
            appointments: 'appointments', 
            clients: 'clients',
            expenses: 'expenses'
        };
        Object.entries(collections).forEach(([stateKey, colName]) => {
            onSnapshot(collection(db, colName), snapshot => {
                state[stateKey] = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                if (stateKey === 'categories') {
                    state.categories.sort((a,b) => a.name.localeCompare(b.name));
                }
                if (state.user) {
                    renderView(state.currentView);
                }
            });
        });
        
        if (state.user.role === 'admin' || state.user.role === 'salon_admin') {
            onSnapshot(doc(db, 'settings', 'salaryRules'), (doc) => {
                state.settings.salaryTiers = doc.exists() ? (doc.data().tiers || []) : [];
                if (state.user && state.currentView === 'settings') {
                    renderView('settings');
                }
            });
        }
        listenersAreActive = true;
    }

    // #region Core App Logic
    function renderLoginView() {
        appContainer.innerHTML = `<div class="auth-bg"><div class="auth-card"><h1>–í—Ö—ñ–¥ —É CRM</h1><div id="login-error" class="error-msg"></div><input id="email" type="email" placeholder="Email" autocomplete="username" autofocus><input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password"><button id="login-btn">–£–≤—ñ–π—Ç–∏</button></div></div>`;
        document.getElementById('login-btn').onclick = handleLogin;
    }

    function renderAppLayout(user) {
        const isAdmin = user.role === 'admin' || user.role === 'salon_admin';
        const adminTabs = `
            <li data-view="salary">–ó–∞—Ä–ø–ª–∞—Ç–∞</li>
            <li data-view="expenses">–í–∏—Ç—Ä–∞—Ç–∏</li>
            <li data-view="settings">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</li>
        `;

        appContainer.innerHTML = `
        <div class="crm-layout">
            <nav class="crm-nav" id="main-nav">
                <h1>Lashroom CRM</h1>
                <ul>
                    <li data-view="calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä</li>
                    <li data-view="appointments">–ó–∞–ø–∏—Å</li>
                    <li data-view="clients">–ö–ª—ñ—î–Ω—Ç–∏</li>
                    <li data-view="services">–ü–æ—Å–ª—É–≥–∏</li>
                    <li data-view="masters">–ú–∞–π—Å—Ç—Ä–∏</li>
                    ${isAdmin ? adminTabs : ''}
                </ul>
                <div class="user-info">
                    <span>${user.email} (${user.role})</span>
                    <button id="logout-btn" class="btn">–í–∏–π—Ç–∏</button>
                </div>
            </nav>
            <main class="crm-main">
                <header class="crm-header">
                    <h2 id="header-title"></h2>
                </header>
                <div class="crm-content">
                    <div class="content-wrapper" id="content-wrapper"></div>
                </div>
            </main>
        </div>`;
        
        document.getElementById('logout-btn').onclick = () => {
            listenersAreActive = false;
            if(masterAdvancesUnsubscribe) masterAdvancesUnsubscribe();
            signOut(auth);
        };
        document.getElementById('main-nav').onclick = (event) => {
            const target = event.target.closest('li');
            if (target) renderView(target.dataset.view);
        };
        document.getElementById('payment-modal').querySelector('.close-btn').onclick = () => {
            document.getElementById('payment-modal').style.display = 'none';
        };
        document.getElementById('payment-form').onsubmit = handleConfirmPayment;
        
        const actionModal = document.getElementById('appointment-action-modal');
        if(actionModal) {
            actionModal.querySelector('.close-btn').onclick = () => {
                actionModal.style.display = 'none';
            };
        }
        renderView(state.currentView);
    }

    function renderView(viewName) {
        if (!state.user) return;
        if (!(state.user.role === 'admin' || state.user.role === 'salon_admin') && ['salary', 'settings', 'expenses'].includes(viewName)) {
            viewName = 'calendar';
        }
        if (state.currentView === 'appointments' && viewName !== 'appointments') {
            state.editingAppointmentId = null;
        }
        state.currentView = viewName;
        
        if(viewName !== 'clientDetail') { state.viewingClientId = null; }
        if(viewName !== 'masterDetail') {
            if (masterAdvancesUnsubscribe) {
                masterAdvancesUnsubscribe();
                masterAdvancesUnsubscribe = null;
            }
            state.viewingMasterId = null;
        }
        if(viewName !== 'appointments') { state.appointmentsPage = 1; }

        const headerTitle = document.getElementById('header-title');
        if(headerTitle) {
            const viewTitles = { calendar: '–ö–∞–ª–µ–Ω–¥–∞—Ä', appointments: '–ó–∞–ø–∏—Å', clients: '–ö–ª—ñ—î–Ω—Ç–∏', services: '–ü–æ—Å–ª—É–≥–∏ —Ç–∞ –ö–∞—Ç–µ–≥–æ—Ä—ñ—ó', masters: '–ú–∞–π—Å—Ç—Ä–∏', salary: '–ó–∞—Ä–ø–ª–∞—Ç–∞', expenses: '–í–∏—Ç—Ä–∞—Ç–∏', settings: '–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è', clientDetail: '–Ü—Å—Ç–æ—Ä—ñ—è –ö–ª—ñ—î–Ω—Ç–∞', masterDetail: '–ö–∞—Ä—Ç–∫–∞ –ú–∞–π—Å—Ç—Ä–∞' };
            headerTitle.textContent = viewTitles[viewName] || 'Dashboard';
        }

        const navList = document.querySelector('#main-nav ul');
        if (!navList) return;
        navList.querySelectorAll('li').forEach(li => li.classList.remove('active'));
        const activeView = ['clientDetail', 'masterDetail'].includes(viewName) ? viewName.replace('Detail', 's') : viewName;
        const activeLi = navList.querySelector(`li[data-view="${activeView}"]`);
        if(activeLi) activeLi.classList.add('active');
        
        const contentWrapper = document.getElementById('content-wrapper');
        if(!contentWrapper) return;
        
        switch (viewName) {
            case 'calendar': renderCalendarView(contentWrapper); break;
            case 'appointments': renderAppointmentsView(contentWrapper); break;
            case 'clients': renderClientsView(contentWrapper); break;
            case 'clientDetail': renderClientDetailView(contentWrapper); break;
            case 'services': renderServicesView(contentWrapper); break;
            case 'masters': renderMastersView(contentWrapper); break;
            case 'masterDetail': renderMasterDetailView(contentWrapper); break;
            case 'salary': renderSalaryView(contentWrapper); break;
            case 'expenses': renderExpensesView(contentWrapper); break;
            case 'settings': renderSettingsView(contentWrapper); break;
            default:
                contentWrapper.innerHTML = `<h2>–ù–µ–≤—ñ–¥–æ–º–∏–π —Ä–æ–∑–¥—ñ–ª</h2>`;
        }
    }
    // #endregion

    function renderDailySummary() {
        const dateInput = document.getElementById('summary-date-picker');
        const salonInput = document.getElementById('summary-salon-filter');
        if (!dateInput || !salonInput) return;

        // Take date as a string to avoid timezone issues, then construct date objects
        const selectedDateStr = dateInput.value;
        const selectedDate = new Date(selectedDateStr);
        const selectedSalonId = salonInput.value;

        const startOfDay = new Date(selectedDate);
        startOfDay.setHours(0, 0, 0, 0);
        
        const endOfDay = new Date(selectedDate);
        endOfDay.setHours(23, 59, 59, 999);
        
        let relevantAppointments = state.appointments.filter(app => {
            if (!app.dateTime) return false;
            const appointmentDate = app.dateTime.toDate();
            return appointmentDate >= startOfDay && appointmentDate <= endOfDay;
        });
        
        if (selectedSalonId !== 'all') {
            relevantAppointments = relevantAppointments.filter(app => app.salonId === selectedSalonId);
        }

        let total = 0, cash = 0, card = 0, blik = 0;
        let servicesWithPayment = 0;

        relevantAppointments.forEach(app => {
            if (app.payments && app.payments.length > 0) {
                servicesWithPayment++;
                app.payments.forEach(p => {
                    total += p.amount;
                    if(p.type === 'cash') cash += p.amount;
                    else if(p.type === 'card') card += p.amount;
                    else if(p.type === 'blik') blik += p.amount;
                });
            }
        });

        document.getElementById('summary-total').textContent = `${total.toFixed(0)} z≈Ç`;
        document.getElementById('summary-cash').textContent = `${cash.toFixed(0)} z≈Ç`;
        document.getElementById('summary-card').textContent = `${card.toFixed(0)} z≈Ç`;
        document.getElementById('summary-blik').textContent = `${blik.toFixed(0)} z≈Ç`;
        document.getElementById('summary-services-count').textContent = servicesWithPayment;
    }

    // #region Calendar View
    function renderCalendarView(container) {
        const salonOptions = state.salons.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

        container.innerHTML = `
            <div class="content-card">
                <div id="calendar-container">
                    <div class="form-row">
                        <div class="form-group" style="flex:1;">
                            <label for="calendar-master-filter">–ú–∞–π—Å—Ç–µ—Ä:</label>
                            <select id="calendar-master-filter"></select>
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label for="calendar-salon-filter">–°–∞–ª–æ–Ω:</label>
                            <select id="calendar-salon-filter">
                                <option value="all">–í—Å—ñ —Å–∞–ª–æ–Ω–∏</option>
                                ${salonOptions}
                            </select>
                        </div>
                    </div>
                    <div id="calendar"></div>
                </div>
            </div>
            <div class="content-card">
                <h2>–ü—ñ–¥—Å—É–º–æ–∫ –∑–∞ –¥–µ–Ω—å</h2>
                <div class="form-row" style="margin-bottom: 2rem;">
                    <div class="form-group" style="flex:1;">
                        <label for="summary-date-picker">–û–±–µ—Ä—ñ—Ç—å –¥–∞—Ç—É</label>
                        <input type="date" id="summary-date-picker">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label for="summary-salon-filter">–û–±–µ—Ä—ñ—Ç—å —Å–∞–ª–æ–Ω</label>
                        <select id="summary-salon-filter">
                            <option value="all">–í—Å—ñ —Å–∞–ª–æ–Ω–∏</option>
                            ${salonOptions}
                        </select>
                    </div>
                </div>
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="value" id="summary-total">0 z≈Ç</div>
                        <div class="label">–ó–∞–≥–∞–ª—å–Ω–∏–π –¥–æ—Ö—ñ–¥</div>
                    </div>
                    <div class="summary-card">
                        <div class="value" id="summary-cash">0 z≈Ç</div>
                        <div class="label">üíµ –ì–æ—Ç—ñ–≤–∫–æ—é</div>
                    </div>
                    <div class="summary-card">
                        <div class="value" id="summary-card">0 z≈Ç</div>
                        <div class="label">üí≥ –ö–∞—Ä—Ç–∫–æ—é</div>
                    </div>
                    <div class="summary-card">
                        <div class="value" id="summary-blik">0 z≈Ç</div>
                        <div class="label">üì± Blik</div>
                    </div>
                     <div class="summary-card">
                        <div class="value" id="summary-services-count">0</div>
                        <div class="label">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –æ–ø–ª–∞—Ç</div>
                    </div>
                </div>
            </div>`;
        
        const calendarEl = document.getElementById('calendar');
        const masterFilter = document.getElementById('calendar-master-filter');
        const salonFilter = document.getElementById('calendar-salon-filter');
        
        const activeMasters = state.masters.filter(m => !m.isFrozen);
        masterFilter.innerHTML = '<option value="all">–í—Å—ñ –º–∞–π—Å—Ç—Ä–∏</option>' + activeMasters.map(m => `<option value="${m.id}" ${state.calendarSelectedMasterId === m.id ? 'selected' : ''}>${m.name}</option>`).join('');
        salonFilter.value = state.calendarSelectedSalonId;

        if (!calendarEl || !masterFilter || !salonFilter) return;

        const colorPalette = ['#3788d8', '#e25141', '#4caf50', '#ff9800', '#9c27b0', '#795548', '#607d8b'];
        
        const calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'uk', initialView: 'timeGridWeek',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'timeGridWeek,timeGridDay' },
            editable: false, selectable: true, nowIndicator: true,
            events: function(fetchInfo, successCallback, failureCallback) {
                let filteredAppointments = state.appointments;

                if (state.calendarSelectedMasterId !== 'all') {
                    filteredAppointments = filteredAppointments.filter(app => app.masterId === state.calendarSelectedMasterId);
                }

                if (state.calendarSelectedSalonId !== 'all') {
                    filteredAppointments = filteredAppointments.filter(app => app.salonId === state.calendarSelectedSalonId);
                }

                const events = filteredAppointments.map(app => {
                    const masterIndex = state.masters.findIndex(m => m.id === app.masterId);
                    const endTime = new Date(app.dateTime.toDate().getTime() + (app.duration || 60) * 60000);
                    
                    let backgroundColor = colorPalette[masterIndex % colorPalette.length];
                    if (app.status === 'completed') {
                        backgroundColor = 'var(--success-color)';
                    } else if (app.status === 'partially_paid') {
                        backgroundColor = 'var(--warning-color)';
                    }

                    return { 
                        id: app.id,
                        start: app.dateTime.toDate(), 
                        end: endTime, 
                        resourceId: app.masterId,
                        backgroundColor: backgroundColor,
                        borderColor: backgroundColor,
                        extendedProps: { appointment: app }
                    };
                });
                successCallback(events);
            },
            eventContent: function(arg) {
                const appointment = arg.event.extendedProps.appointment;
                const service = state.services.find(s => s.id === appointment.serviceId);
                const salon = state.salons.find(s => s.id === appointment.salonId);

                const html = `
                    <div class="fc-event-main-frame">
                        <div class="fc-event-title">${appointment.clientName}</div>
                        <div class="fc-event-service">${service?.name || ''}</div>
                        <div class="fc-event-service" style="opacity: 0.7;"><strong>${salon?.name || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</strong></div>
                    </div>
                `;
                return { html: html };
            },
            eventDidMount: function(info) {
                if (info.event.start < new Date() && info.event.extendedProps.appointment.status !== 'completed') {
                    info.el.style.opacity = '0.6';
                }
            },
            eventClick: function(info) {
                const appointment = info.event.extendedProps.appointment;
                if (appointment) {
                    showActionModal(appointment);
                }
            },
            select: function(selectionInfo) {
                state.preselectedAppointment = { dateTime: selectionInfo.start };
                if (state.calendarSelectedMasterId !== 'all') { state.preselectedAppointment.masterId = state.calendarSelectedMasterId; }
                renderView('appointments');
            }
        });
        calendar.render();
        masterFilter.onchange = (e) => { state.calendarSelectedMasterId = e.target.value; renderView('calendar'); };
        salonFilter.onchange = (e) => { state.calendarSelectedSalonId = e.target.value; renderView('calendar'); };

        const summaryDatePicker = document.getElementById('summary-date-picker');
        const summarySalonFilter = document.getElementById('summary-salon-filter');
        summaryDatePicker.valueAsDate = new Date(); 
        summaryDatePicker.onchange = renderDailySummary;
        summarySalonFilter.onchange = renderDailySummary;
        renderDailySummary(); 
    }

    function openPaymentModal(appointment) {
        const totalPrice = appointment.finalPrice || 0;
        const totalPaid = appointment.totalPaid || 0;
        const remaining = totalPrice - totalPaid;

        document.getElementById('payment-appointment-id').value = appointment.id;
        document.getElementById('payment-total-price').textContent = `${totalPrice.toFixed(0)} z≈Ç`;
        document.getElementById('payment-total-paid').textContent = `${totalPaid.toFixed(0)} z≈Ç`;
        document.getElementById('payment-remaining').textContent = `${remaining.toFixed(0)} z≈Ç`;
        
        const amountInput = document.getElementById('payment-amount');
        amountInput.value = remaining > 0 ? remaining.toFixed(2) : '0.00';
        amountInput.max = remaining.toFixed(2);
        
        document.getElementById('payment-modal').style.display = 'flex';
    }

    function showActionModal(appointment) {
        const modal = document.getElementById('appointment-action-modal');
        const detailsEl = document.getElementById('action-modal-details');
        const buttonsEl = document.getElementById('action-modal-buttons');
        
        const client = state.clients.find(c => c.id === appointment.clientId);
        const service = state.services.find(s => s.id === appointment.serviceId);
        const master = state.masters.find(m => m.id === appointment.masterId);
        const salon = state.salons.find(s => s.id === appointment.salonId);

        let statusText = '–û—á—ñ–∫—É—î –æ–ø–ª–∞—Ç–∏';
        if (appointment.status === 'completed') {
            statusText = '–û–ø–ª–∞—á–µ–Ω–æ';
        } else if (appointment.status === 'partially_paid') {
            const remaining = (appointment.finalPrice || 0) - (appointment.totalPaid || 0);
            statusText = `–ß–∞—Å—Ç–∫–æ–≤–æ –æ–ø–ª–∞—á–µ–Ω–æ (–∑–∞–ª–∏—à–∏–ª–æ—Å—å ${remaining.toFixed(0)} z≈Ç)`;
        }

        detailsEl.innerHTML = `
            <p><strong>–ö–ª—ñ—î–Ω—Ç:</strong> ${appointment.clientName} (${client?.phone || '–Ω–µ –≤–∫–∞–∑–∞–Ω–æ'})</p>
            <p><strong>–ü–æ—Å–ª—É–≥–∞:</strong> ${service?.name || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ—Å–ª—É–≥–∞'}</p>
            <p><strong>–ú–∞–π—Å—Ç–µ—Ä:</strong> ${master?.name || '–ù–µ–≤—ñ–¥–æ–º–∏–π –º–∞–π—Å—Ç–µ—Ä'}</p>
            <p><strong>–°–∞–ª–æ–Ω:</strong> ${salon?.name || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</p>
            <p><strong>–î–∞—Ç–∞:</strong> ${appointment.dateTime.toDate().toLocaleString('uk-UA')}</p>
            <p><strong>–°—É–º–∞:</strong> ${appointment.finalPrice.toFixed(0)} z≈Ç</p>
            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${statusText}</p>
        `;

        let buttonsHtml = '';
        if (appointment.status !== 'completed') {
            buttonsHtml += `<button class="btn btn-complete-payment" data-action="pay">–í–Ω–µ—Å—Ç–∏ / –î–æ–¥–∞—Ç–∏ –æ–ø–ª–∞—Ç—É</button>`;
        }
        
        buttonsHtml += `<button class="btn btn-edit" data-action="edit">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ / –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏</button>`;
        buttonsHtml += `<button class="btn btn-delete" data-action="cancel">–°–∫–∞—Å—É–≤–∞—Ç–∏ –∑–∞–ø–∏—Å</button>`;
        
        buttonsEl.innerHTML = buttonsHtml;
        
        buttonsEl.onclick = function(event) {
            const button = event.target.closest('button');
            if (!button) return;

            const action = button.dataset.action;

            if (action === 'pay') {
                openPaymentModal(appointment);
                document.getElementById('appointment-action-modal').style.display = 'none';
            } else if (action === 'edit') {
                handleEditAppointment(appointment.id);
            } else if (action === 'cancel') {
                handleCancelAppointment(appointment.id);
            }
        };
        
        modal.querySelector('.close-btn').onclick = () => modal.style.display = 'none';
        modal.style.display = 'flex';
    }

    async function handleCancelAppointment(appointmentId) {
        if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ —Å–∫–∞—Å—É–≤–∞—Ç–∏ —Ü–µ–π –∑–∞–ø–∏—Å? –¶—é –¥—ñ—é –Ω–µ –º–æ–∂–Ω–∞ –±—É–¥–µ —Å–∫–∞—Å—É–≤–∞—Ç–∏.')) {
            try {
                await deleteDoc(doc(db, 'appointments', appointmentId));
                document.getElementById('appointment-action-modal').style.display = 'none';
                alert('–ó–∞–ø–∏—Å —É—Å–ø—ñ—à–Ω–æ —Å–∫–∞—Å–æ–≤–∞–Ω–æ.');
            } catch (e) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å–∫–∞—Å—É–≤–∞–Ω–Ω—ñ –∑–∞–ø–∏—Å—É: ", e);
                alert('–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–∞—Å—É–≤–∞—Ç–∏ –∑–∞–ø–∏—Å.');
            }
        }
    }

    function handleEditAppointment(appointmentId) {
        state.editingAppointmentId = appointmentId;
        document.getElementById('appointment-action-modal').style.display = 'none';
        renderView('appointments');
    }
    // #endregion
    
    // #region Clients Views
    function renderClientsView(container) {
        container.innerHTML = `<div class="content-card"><h2>–ë–∞–∑–∞ –∫–ª—ñ—î–Ω—Ç—ñ–≤</h2><div class="form-group"><input type="text" id="client-search" placeholder="–ü–æ—à—É–∫ –∑–∞ —ñ–º–µ–Ω–µ–º –∞–±–æ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º..."></div><ul id="clients-list" class="item-list"></ul></div>`;
        const searchInput = document.getElementById('client-search');
        searchInput.oninput = () => displayClients(searchInput.value);
        displayClients();
    }
    function displayClients(searchTerm = '') {
        const listEl = document.getElementById('clients-list');
        if (!listEl) return;
        const normalizedSearch = searchTerm.toLowerCase().trim();
        const filteredClients = searchTerm ? state.clients.filter(client => client.name.toLowerCase().includes(normalizedSearch) || (client.phone && client.phone.includes(normalizedSearch))) : state.clients;
        listEl.innerHTML = filteredClients.length > 0 ? '' : '<li>–ö–ª—ñ—î–Ω—Ç—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.</li>';
        filteredClients.sort((a,b) => a.name.localeCompare(b.name)).forEach(client => {
            const li = document.createElement('li');
            li.innerHTML = `<div><strong>${client.name}</strong><br><small>${client.phone || '–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ –≤–∫–∞–∑–∞–Ω–æ'}</small></div><div><button class="btn-edit btn-view-history" data-id="${client.id}">–Ü—Å—Ç–æ—Ä—ñ—è</button></div>`;
            listEl.appendChild(li);
        });
        listEl.onclick = (e) => {
            if(e.target.classList.contains('btn-view-history')) {
                state.viewingClientId = e.target.dataset.id;
                renderView('clientDetail');
            }
        };
    }
    function renderClientDetailView(container) {
        const client = state.clients.find(c => c.id === state.viewingClientId);
        if(!client) {
            container.innerHTML = `<div class="content-card"><h2>–ö–ª—ñ—î–Ω—Ç–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</h2><p><button id="back-to-clients-btn" class="btn">–ù–∞–∑–∞–¥ –¥–æ —Å–ø–∏—Å–∫—É</button></p></div>`;
            document.getElementById('back-to-clients-btn').onclick = () => renderView('clients');
            return;
        }
        const clientAppointments = state.appointments.filter(app => app.clientId === client.id).sort((a,b) => b.dateTime.toDate() - a.dateTime.toDate());
        const totalVisits = clientAppointments.length;
        const totalSpent = clientAppointments.reduce((sum, app) => sum + (app.totalPaid || (app.status === 'completed' ? app.finalPrice : 0)), 0);
        const firstVisit = totalVisits > 0 ? clientAppointments[clientAppointments.length - 1].dateTime.toDate().toLocaleDateString('uk-UA') : '–ù–µ–º–∞—î –≤—ñ–∑–∏—Ç—ñ–≤';
        let historyHtml = clientAppointments.map(app => {
            const service = state.services.find(s => s.id === app.serviceId);
            const master = state.masters.find(m => m.id === app.masterId);
            const salon = state.salons.find(s => s.id === app.salonId); 
            const date = app.dateTime.toDate().toLocaleString('uk-UA', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            
            let statusBadge;
            if (app.status === 'completed') {
                statusBadge = `<span class="status-badge status-completed">–û–ø–ª–∞—á–µ–Ω–æ</span>`;
            } else if (app.status === 'partially_paid') {
                const remaining = (app.finalPrice || 0) - (app.totalPaid || 0);
                statusBadge = `<span class="status-badge status-partially-paid">–ß–∞—Å—Ç–∫–æ–≤–æ (—â–µ ${remaining.toFixed(0)} z≈Ç)</span>`;
            } else {
                statusBadge = `<span class="status-badge status-upcoming">–û—á—ñ–∫—É—î</span>`;
            }

            return `<tr><td>${date}</td><td>${service?.name || '–ù/–î'}</td><td>${master?.name || '–ù/–î'}</td><td>${salon?.name || '–ù/–î'}</td><td>${app.finalPrice.toFixed(0)} z≈Ç</td><td>${statusBadge}</td></tr>`;
        }).join('');
        container.innerHTML = `<div class="content-card"><button id="back-to-clients-btn" class="btn" style="margin-bottom: 2rem;">&larr; –ù–∞–∑–∞–¥ –¥–æ —Å–ø–∏—Å–∫—É –∫–ª—ñ—î–Ω—Ç—ñ–≤</button><h2>${client.name}</h2><p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${client.phone || '–Ω–µ –≤–∫–∞–∑–∞–Ω–æ'}</p><div class="stats-grid"><div class="stat-card"><div class="value">${totalVisits}</div><div class="label">–í—Å—å–æ–≥–æ –≤—ñ–∑–∏—Ç—ñ–≤</div></div><div class="stat-card"><div class="value">${totalSpent.toFixed(0)} z≈Ç</div><div class="label">–í—Å—å–æ–≥–æ –≤–∏—Ç—Ä–∞—á–µ–Ω–æ</div></div><div class="stat-card"><div class="value">${firstVisit}</div><div class="label">–ü–µ—Ä—à–∏–π –≤—ñ–∑–∏—Ç</div></div></div></div><div class="content-card"><h3>–Ü—Å—Ç–æ—Ä—ñ—è –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—å</h3><table><thead><tr><th>–î–∞—Ç–∞</th><th>–ü–æ—Å–ª—É–≥–∞</th><th>–ú–∞–π—Å—Ç–µ—Ä</th><th>–°–∞–ª–æ–Ω</th><th>–°—É–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead><tbody>${historyHtml.length > 0 ? historyHtml : `<tr><td colspan="6" style="text-align:center;">–Ü—Å—Ç–æ—Ä—ñ—è –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—å –ø–æ—Ä–æ–∂–Ω—è.</td></tr>`}</tbody></table></div>`;
        document.getElementById('back-to-clients-btn').onclick = () => renderView('clients');
    }
    // #endregion

    // #region Appointments View
    function renderAppointmentsView(container) {
        const isEditMode = !!state.editingAppointmentId;
        let appointmentToEdit = null;
        if (isEditMode) {
            appointmentToEdit = state.appointments.find(a => a.id === state.editingAppointmentId);
        }
        
        const salonOptions = state.salons.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

        container.innerHTML = `
            <div class="content-card">
                <h2 id="appointment-form-title">${isEditMode ? '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∑–∞–ø–∏—Å' : '–ù–æ–≤–∏–π –∑–∞–ø–∏—Å'}</h2>
                <form id="appointment-form">
                    <div class="form-group client-search-container">
                        <label for="client-search-input">–ü–æ—à—É–∫ / –Ü–º'—è –∫–ª—ñ—î–Ω—Ç–∞</label>
                        <input type="text" id="client-search-input" autocomplete="off" required ${isEditMode ? 'disabled' : ''}>
                        <div id="client-search-results" style="display: none;"></div>
                    </div>
                    <div class="form-group" id="client-phone-group" style="display: ${isEditMode ? 'block' : 'none'};">
                        <label for="client-phone-input">–¢–µ–ª–µ—Ñ–æ–Ω –Ω–æ–≤–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞</label>
                        <input type="tel" id="client-phone-input" ${isEditMode ? 'disabled' : ''}>
                    </div>
                    <div class="form-group">
                        <label for="appointment-datetime">–î–∞—Ç–∞ —ñ —á–∞—Å</label>
                        <input type="datetime-local" id="appointment-datetime" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex:1;">
                            <label for="appointment-category">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è –ø–æ—Å–ª—É–≥</label>
                            <select id="appointment-category" required></select>
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label for="appointment-service">–ü–æ—Å–ª—É–≥–∞</label>
                            <select id="appointment-service" required></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="appointment-master">–ú–∞–π—Å—Ç–µ—Ä</label>
                        <select id="appointment-master" required></select>
                    </div>
                    <div class="form-group">
                        <label for="appointment-salon">–°–∞–ª–æ–Ω</label>
                        <select id="appointment-salon" required>
                           <option value="">–û–±–µ—Ä—ñ—Ç—å —Å–∞–ª–æ–Ω</option>
                           ${salonOptions}
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex:2;">
                            <label for="manual-discount-value">–î–æ–¥–∞—Ç–∫–æ–≤–∞ –∑–Ω–∏–∂–∫–∞</label>
                            <input type="number" id="manual-discount-value" placeholder="0" min="0">
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label for="manual-discount-type">–¢–∏–ø</label>
                            <select id="manual-discount-type">
                                <option value="percent">%</option>
                                <option value="fixed">z≈Ç</option>
                            </select>
                        </div>
                    </div>
                    <div id="final-price-display">–°—É–º–∞ –¥–æ –æ–ø–ª–∞—Ç–∏: 0 z≈Ç</div>
                    <button type="submit" id="appointment-submit-btn" class="btn" style="margin-top: 1rem;">${isEditMode ? '–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏' : '–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Å'}</button>
                    ${isEditMode ? `<button type="button" id="appointment-cancel-edit-btn" class="btn" style="margin-top: 0.5rem; background-color: var(--gray-text);">–°–∫–∞—Å—É–≤–∞—Ç–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è</button>` : ''}
                </form>
            </div>
            ${!isEditMode ? `
            <div class="content-card" style="margin-top: 2rem;">
                <h2>–ù–µ–∑–∞–≤–µ—Ä—à–µ–Ω—ñ –∑–∞–ø–∏—Å–∏</h2>
                <div class="form-group">
                    <label for="appointments-date-filter">–û–±–µ—Ä—ñ—Ç—å –¥–∞—Ç—É</label>
                    <input type="date" id="appointments-date-filter">
                </div>
                <ul id="daily-appointments-list" class="item-list"></ul>
                <div id="pagination-controls" style="text-align: center; margin-top: 1rem;"></div>
            </div>` : ''}
        `;
        setupAppointmentsLogic();

        if (isEditMode && appointmentToEdit) {
            const client = state.clients.find(c => c.id === appointmentToEdit.clientId);
            document.getElementById('client-search-input').value = client?.name || appointmentToEdit.clientName;
            document.getElementById('client-phone-input').value = client?.phone || '';
            
            const d = new Date(appointmentToEdit.dateTime.toDate().getTime() - (appointmentToEdit.dateTime.toDate().getTimezoneOffset() * 60000));
            document.getElementById('appointment-datetime').value = d.toISOString().slice(0, 16);
            
            document.getElementById('manual-discount-value').value = appointmentToEdit.manualDiscount?.value || 0;
            document.getElementById('manual-discount-type').value = appointmentToEdit.manualDiscount?.type || 'percent';

            const service = state.services.find(s => s.id === appointmentToEdit.serviceId);
            if (service) {
                const categorySelect = document.getElementById('appointment-category');
                categorySelect.value = service.categoryId;
                categorySelect.dispatchEvent(new Event('change'));

                setTimeout(() => {
                    document.getElementById('appointment-service').value = appointmentToEdit.serviceId;
                    document.getElementById('appointment-master').value = appointmentToEdit.masterId;
                    if (appointmentToEdit.salonId) {
                        document.getElementById('appointment-salon').value = appointmentToEdit.salonId;
                    }
                    updateFinalPrice();
                }, 100);
            }
        } else if (state.preselectedAppointment) {
            const { dateTime, masterId } = state.preselectedAppointment;
            const d = new Date(dateTime.getTime() - (dateTime.getTimezoneOffset() * 60000));
            document.getElementById('appointment-datetime').value = d.toISOString().slice(0, 16);
            if (masterId) {
                const master = state.masters.find(m => m.id === masterId);
                const firstCategoryId = master?.categoryIds?.[0];
                if (firstCategoryId) {
                    const categorySelect = document.getElementById('appointment-category');
                    categorySelect.value = firstCategoryId;
                    categorySelect.dispatchEvent(new Event('change'));
                    setTimeout(() => {
                        document.getElementById('appointment-master').value = masterId;
                    }, 100);
                }
            }
            state.preselectedAppointment = null;
        } else {
            const dateFilter = document.getElementById('appointments-date-filter');
            dateFilter.valueAsDate = state.appointmentsListDate;
            dateFilter.onchange = () => {
                state.appointmentsListDate = dateFilter.valueAsDate;
                state.appointmentsPage = 1;
                renderDailyAppointmentsList();
            };
            renderDailyAppointmentsList();
        }
    }

    function setupAppointmentsLogic() {
        document.getElementById('appointment-form').onsubmit = handleSaveAppointment;

        if (state.editingAppointmentId) {
            document.getElementById('appointment-cancel-edit-btn').onclick = () => {
                state.editingAppointmentId = null;
                renderView('calendar');
            };
        } else {
            const searchInput = document.getElementById('client-search-input');
            const searchResultsEl = document.getElementById('client-search-results');
            const phoneGroup = document.getElementById('client-phone-group');
            const phoneInput = document.getElementById('client-phone-input');
            searchInput.oninput = () => {
                state.selectedClientForAppointment = null;
                phoneGroup.style.display = 'block'; phoneInput.required = true;
                const searchTerm = searchInput.value.toLowerCase().trim();
                if (searchTerm.length < 2) { searchResultsEl.style.display = 'none'; return; }
                const results = state.clients.filter(c => c.name.toLowerCase().includes(searchTerm) || (c.phone && c.phone.includes(searchTerm)));
                searchResultsEl.innerHTML = results.length > 0 ? results.map(c => `<div data-id="${c.id}" data-name="${c.name}" data-phone="${c.phone}">${c.name} - ${c.phone}</div>`).join('') : '';
                searchResultsEl.style.display = results.length > 0 ? 'block' : 'none';
            };
            searchResultsEl.onclick = (e) => {
                if(e.target.dataset.id) {
                    state.selectedClientForAppointment = { id: e.target.dataset.id, name: e.target.dataset.name, phone: e.target.dataset.phone };
                    searchInput.value = state.selectedClientForAppointment.name;
                    phoneInput.value = state.selectedClientForAppointment.phone;
                    searchResultsEl.style.display = 'none'; phoneGroup.style.display = 'block';
                }
            };
            searchInput.onblur = () => { setTimeout(() => searchResultsEl.style.display = 'none', 200); };
        }
        
        populateAppointmentFormDropdowns();

        const categorySelect = document.getElementById('appointment-category');
        categorySelect.onchange = () => {
            const categoryId = categorySelect.value;
            document.getElementById('appointment-service').innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –ø–æ—Å–ª—É–≥—É</option>' + state.services.filter(s => s.categoryId === categoryId).map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            const masterSelect = document.getElementById('appointment-master');
            const activeMasters = state.masters.filter(m => !m.isFrozen);
            const selectedCategoryName = state.categories.find(c => c.id === categoryId)?.name;
            const mastersForCategory = activeMasters.filter(m => (m.categoryIds?.includes(categoryId)) || (m.specialization && selectedCategoryName && Array.isArray(m.specialization) && m.specialization.includes(selectedCategoryName)));
            masterSelect.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –º–∞–π—Å—Ç—Ä–∞</option>' + mastersForCategory.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
            updateFinalPrice();
        };
        
        ['appointment-service', 'appointment-master', 'appointment-salon', 'manual-discount-value', 'manual-discount-type'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.oninput = updateFinalPrice;
        });
    }

    function renderDailyAppointmentsList() {
        const listEl = document.getElementById('daily-appointments-list');
        const paginationControls = document.getElementById('pagination-controls');
        if (!listEl) return;

        const selectedDate = state.appointmentsListDate;
        const startOfDay = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate());
        const endOfDay = new Date(startOfDay.getTime() + 24 * 60 * 60 * 1000 - 1);
        
        const dailyUnpaidAppointments = state.appointments.filter(app => {
            if (!app.dateTime) return false;
            const appDate = app.dateTime.toDate();
            return app.status !== 'completed' && appDate >= startOfDay && appDate <= endOfDay;
        }).sort((a, b) => a.dateTime.toDate() - b.dateTime.toDate());

        if (state.appointmentsPage === 1) {
            listEl.innerHTML = '';
            if (dailyUnpaidAppointments.length === 0) {
                listEl.innerHTML = '<li>–ù–∞ —Ü—é –¥–∞—Ç—É –Ω–µ–º–∞—î –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–∏—Ö –∑–∞–ø–∏—Å—ñ–≤.</li>';
                paginationControls.innerHTML = '';
                return;
            }
        }

        const itemsPerPage = 10;
        const startIndex = (state.appointmentsPage - 1) * itemsPerPage;
        const paginatedAppointments = dailyUnpaidAppointments.slice(startIndex, startIndex + itemsPerPage);

        paginatedAppointments.forEach(appointment => {
            const service = state.services.find(s => s.id === appointment.serviceId)?.name || '–ü–æ—Å–ª—É–≥–∞';
            const master = state.masters.find(m => m.id === appointment.masterId)?.name || '–ú–∞–π—Å—Ç–µ—Ä';
            const time = appointment.dateTime.toDate().toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });
            
            const remaining = (appointment.finalPrice || 0) - (appointment.totalPaid || 0);
            const priceText = appointment.status === 'partially_paid' ? `–ó–∞–ª–∏—à–∏–ª–æ—Å—å: ${remaining.toFixed(0)} z≈Ç` : `<strong>${appointment.finalPrice.toFixed(0)} z≈Ç</strong>`;
            
            const li = document.createElement('li');
            li.innerHTML = `<div><strong>${time} - ${appointment.clientName}</strong><br><small>${service} (${master})</small></div><div class="actions">${priceText}<button class="btn btn-complete-payment">–û–ø–ª–∞—Ç–∏—Ç–∏</button></div>`;
            
            li.querySelector('.btn-complete-payment').onclick = () => openPaymentModal(appointment);
            listEl.appendChild(li);
        });
        
        paginationControls.innerHTML = '';
        if (dailyUnpaidAppointments.length > startIndex + itemsPerPage) {
            const loadMoreBtn = document.createElement('button');
            loadMoreBtn.className = 'btn';
            loadMoreBtn.innerText = '–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —â–µ';
            loadMoreBtn.onclick = () => { 
                state.appointmentsPage++; 
                renderDailyAppointmentsList(); 
            };
            paginationControls.appendChild(loadMoreBtn);
        }
    }

    function populateAppointmentFormDropdowns() { 
        const categorySelect = document.getElementById('appointment-category'); 
        if (categorySelect) { 
            categorySelect.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</option>' + state.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        } 
    }

    function updateFinalPrice() { 
        const serviceId = document.getElementById('appointment-service').value; 
        const masterId = document.getElementById('appointment-master').value; 
        const manualDiscountValue = parseFloat(document.getElementById('manual-discount-value').value) || 0; 
        const manualDiscountType = document.getElementById('manual-discount-type').value; 
        const priceDisplay = document.getElementById('final-price-display'); 
        if (!serviceId || !masterId) { 
            priceDisplay.innerText = `–°—É–º–∞ –¥–æ –æ–ø–ª–∞—Ç–∏: 0 z≈Ç`; 
            return 0; 
        } 
        const service = state.services.find(s => s.id === serviceId); 
        const category = state.categories.find(c => c.id === service?.categoryId); 
        const master = state.masters.find(m => m.id === masterId); 
        let price = service.price; 
        const discountPercent = service.discount > 0 ? service.discount : (category?.discount || 0); 
        price *= (1 - discountPercent / 100); 
        const markupPercent = master.priceModifier || 0; 
        price *= (1 + markupPercent / 100); 
        if (manualDiscountType === 'percent') { 
            price *= (1 - manualDiscountValue / 100); 
        } else { 
            price -= manualDiscountValue; 
        } 
        priceDisplay.innerText = `–°—É–º–∞ –¥–æ –æ–ø–ª–∞—Ç–∏: ${price.toFixed(0)} z≈Ç`; 
        return price; 
    }

    async function handleSaveAppointment(event) {
        event.preventDefault();
        const isEditMode = !!state.editingAppointmentId;
        
        const serviceId = document.getElementById('appointment-service').value;
        const masterId = document.getElementById('appointment-master').value;
        const dateTimeString = document.getElementById('appointment-datetime').value;
        const salonId = document.getElementById('appointment-salon').value;

        if (!serviceId || !masterId || !dateTimeString || !salonId) {
            return alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è, –≤–∫–ª—é—á–Ω–æ –∑ —Å–∞–ª–æ–Ω–æ–º.");
        }

        const service = state.services.find(s => s.id === serviceId);
        const master = state.masters.find(m => m.id === masterId);
        if (!service || !master) {
            return alert("–ü–æ–º–∏–ª–∫–∞: –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –ø–æ—Å–ª—É–≥—É –∞–±–æ –º–∞–π—Å—Ç—Ä–∞!");
        }

        const priceModifier = master.priceModifier || 0;
        const salaryBase = service.price * (1 + priceModifier / 100);
        const finalPrice = updateFinalPrice(); 
        
        const appointmentData = {
            dateTime: Timestamp.fromDate(new Date(dateTimeString)),
            serviceId,
            masterId,
            salonId,
            duration: service.duration || 60,
            manualDiscount: {
                value: parseFloat(document.getElementById('manual-discount-value').value) || 0,
                type: document.getElementById('manual-discount-type').value
            },
            finalPrice,
            salaryBase: salaryBase
        };
        
        try {
            if (isEditMode) {
                await updateDoc(doc(db, 'appointments', state.editingAppointmentId), appointmentData);
                alert('–ó–∞–ø–∏—Å —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–æ!');
                state.editingAppointmentId = null;
                renderView('calendar');
            } else {
                let clientId;
                let clientName = document.getElementById('client-search-input').value.trim();
                let clientPhone = document.getElementById('client-phone-input').value.trim();
                if (state.selectedClientForAppointment) {
                    clientId = state.selectedClientForAppointment.id;
                    clientName = state.selectedClientForAppointment.name;
                } else {
                    if (!clientPhone) return alert("–î–ª—è –Ω–æ–≤–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –≤–∫–∞–∑–∞—Ç–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É.");
                    const normalizedPhone = clientPhone.replace(/[\s-()]/g, '');
                    const existingClient = state.clients.find(c => c.name.toLowerCase() === clientName.toLowerCase() && c.phone.replace(/[\s-()]/g, '') === normalizedPhone);
                    if (existingClient) {
                        clientId = existingClient.id;
                    } else {
                        const newClientRef = await addDoc(collection(db, 'clients'), { name: clientName, phone: clientPhone, createdAt: Timestamp.now() });
                        clientId = newClientRef.id;
                    }
                }
                
                const fullAppointmentData = {
                    ...appointmentData,
                    clientName,
                    clientId,
                    status: 'upcoming',
                    totalPaid: 0,
                    payments: [],
                    createdAt: Timestamp.now()
                };

                await addDoc(collection(db, 'appointments'), fullAppointmentData);
                alert('–ó–∞–ø–∏—Å —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ!');
                event.target.reset();
                document.getElementById('client-phone-group').style.display = 'none';
                updateFinalPrice();
            }
        } catch (e) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–∞–ø–∏—Å—É:", e);
            alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –∑–∞–ø–∏—Å.');
        }
    }
     
    async function handleConfirmPayment(event) {
        event.preventDefault();
        const appointmentId = document.getElementById('payment-appointment-id').value;
        const paymentType = document.getElementById('payment-modal-type').value;
        const amountToPay = parseFloat(document.getElementById('payment-amount').value);

        if (!appointmentId || !amountToPay || amountToPay <= 0) {
            alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É —Å—É–º—É.');
            return;
        }

        const appointmentRef = doc(db, 'appointments', appointmentId);

        try {
            const appointmentSnap = await getDoc(appointmentRef);
            if (!appointmentSnap.exists()) {
                throw new Error("–ó–∞–ø–∏—Å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ");
            }

            const appointmentData = appointmentSnap.data();
            const currentTotalPaid = appointmentData.totalPaid || 0;
            const finalPrice = appointmentData.finalPrice;
            
            if (amountToPay > (finalPrice - currentTotalPaid) + 0.01) { 
                if(!confirm(`–°—É–º–∞ –æ–ø–ª–∞—Ç–∏ (${amountToPay.toFixed(2)} z≈Ç) –±—ñ–ª—å—à–∞ –∑–∞ –∑–∞–ª–∏—à–æ–∫ (${(finalPrice - currentTotalPaid).toFixed(2)} z≈Ç). –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?`)){
                    return;
                }
            }

            const newPayment = {
                amount: amountToPay,
                type: paymentType,
                date: Timestamp.now()
            };

            const newTotalPaid = currentTotalPaid + amountToPay;
            const newStatus = newTotalPaid >= finalPrice ? 'completed' : 'partially_paid';
            
            await updateDoc(appointmentRef, {
                payments: arrayUnion(newPayment),
                totalPaid: increment(amountToPay),
                status: newStatus,
                ...(newStatus === 'completed' && !appointmentData.completedAt && { completedAt: Timestamp.now() })
            });

            document.getElementById('payment-modal').style.display = 'none';
        } catch (e) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –æ–ø–ª–∞—Ç–∏:", e);
            alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–æ–≤–µ—Å—Ç–∏ –æ–ø–ª–∞—Ç—É. –ü–æ–º–∏–ª–∫–∞: ' + e.message);
        }
    }
    // #endregion

    // #region Masters View
    function renderMastersView(container) { 
        container.innerHTML = `<div class="content-card"><h2>–î–æ–¥–∞—Ç–∏ –Ω–æ–≤–æ–≥–æ –º–∞–π—Å—Ç—Ä–∞</h2><form id="add-master-form"><div class="form-group"><label for="new-master-name">–Ü–º'—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ</label><input type="text" id="new-master-name" required></div><div class="form-row"><div class="form-group" style="flex:1;"><label for="new-master-tier">–†–∞–Ω–≥</label><input type="text" id="new-master-tier" placeholder="–Ω–∞–ø—Ä. –¢–æ–ø-–º–∞–π—Å—Ç–µ—Ä"></div><div class="form-group" style="flex:1;"><label for="new-master-modifier">–ù–∞—Ü—ñ–Ω–∫–∞ (%)</label><input type="number" id="new-master-modifier" value="0" min="0"></div></div><div class="form-group"><label>–°–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó</label><div id="new-master-categories" class="category-checkbox-group"></div></div><button class="btn" type="submit">–î–æ–¥–∞—Ç–∏ –º–∞–π—Å—Ç—Ä–∞</button></form></div><div class="content-card" style="margin-top: 2rem;"><h2>–°–ø–∏—Å–æ–∫ –º–∞–π—Å—Ç—Ä—ñ–≤</h2><ul id="masters-list" class="item-list"></ul></div><div class="modal-overlay" id="edit-master-modal"><div class="modal-panel"><div class="modal-header"><h2>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –º–∞–π—Å—Ç—Ä–∞</h2><button class="close-btn">&times;</button></div><form id="edit-master-form"><input type="hidden" id="edit-master-id"><div class="form-group"><label for="edit-master-name">–Ü–º'—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ</label><input type="text" id="edit-master-name" required></div><div class="form-row"><div class="form-group" style="flex:1;"><label for="edit-master-tier">–†–∞–Ω–≥</label><input type="text" id="edit-master-tier"></div><div class="form-group" style="flex:1;"><label for="edit-master-modifier">–ù–∞—Ü—ñ–Ω–∫–∞ (%)</label><input type="number" id="edit-master-modifier" min="0"></div></div><div class="form-group"><label>–°–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó</label><div id="edit-master-categories" class="category-checkbox-group"></div></div><div class="form-group category-checkbox-group" style="max-height: none; padding: 0.5rem;"><label><input type="checkbox" id="edit-master-frozen"> –ó–∞–º–æ—Ä–æ–∑–∏—Ç–∏ –º–∞–π—Å—Ç—Ä–∞ (–ø—Ä–∏—Ö–æ–≤–∞—Ç–∏ –∑ —Ñ–æ—Ä–º)</label></div><button type="submit" class="btn">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏</button></form></div></div>`; 
        document.getElementById('add-master-form').onsubmit = handleAddMaster; 
        document.querySelector('#edit-master-modal .close-btn').onclick = () => document.getElementById('edit-master-modal').style.display = 'none'; 
        document.getElementById('edit-master-form').onsubmit = handleUpdateMaster; 
        populateCategoryCheckboxes('new-master-categories'); 
        const listEl = document.getElementById('masters-list'); 
        listEl.innerHTML = state.masters.length > 0 ? '' : '<li>–ù–µ–º–∞—î –º–∞–π—Å—Ç—Ä—ñ–≤.</li>'; 
        state.masters.sort((a,b) => a.name.localeCompare(b.name)).forEach(master => { 
            const categories = (master.categoryIds || []).map(id => state.categories.find(c => c.id === id)?.name || '').filter(Boolean).join(', '); 
            const li = document.createElement('li'); 
            li.className = master.isFrozen ? 'is-frozen no-hover' : 'no-hover'; 
            li.innerHTML = `
                <div class="master-info-clickable" data-id="${master.id}" style="flex-grow: 1; cursor: pointer;">
                    <strong>${master.name}</strong> ${master.tier ? `(${master.tier})` : ''} ${master.priceModifier > 0 ? `<strong style="color:var(--danger-color)">+${master.priceModifier}%</strong>` : ''}<br>
                    <small>${categories || '–ë–µ–∑ —Å–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó'}</small>
                </div>
                <div class="actions">
                    <button class="btn btn-edit" data-id="${master.id}" data-action="edit-profile">–†–µ–¥.</button>
                </div>`;
            listEl.appendChild(li); 
        }); 
        listEl.onclick = (event) => { 
            const button = event.target.closest('button[data-action="edit-profile"]');
            if (button) { 
                event.stopPropagation();
                showEditMasterModal(button.dataset.id); 
            } else { 
                const masterItem = event.target.closest('.master-info-clickable'); 
                if (masterItem) { 
                    state.viewingMasterId = masterItem.dataset.id; 
                    renderView('masterDetail'); 
                } 
            } 
        };
    }

    function renderMasterDetailView(container) {
        const masterId = state.viewingMasterId;
        const master = state.masters.find(m => m.id === masterId);

        if (!master) {
            container.innerHTML = `<div class="content-card"><h2>–ú–∞–π—Å—Ç—Ä–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</h2><p><button id="detail-view-back-btn" class="btn">–ù–∞–∑–∞–¥ –¥–æ —Å–ø–∏—Å–∫—É</button></p></div>`;
            container.onclick = (event) => {
                if (event.target.id === 'detail-view-back-btn') {
                    renderView('masters');
                }
            };
            return;
        }

        const categoriesList = (master.categoryIds || [])
            .map(id => state.categories.find(c => c.id === id)?.name)
            .filter(Boolean).join(', ') || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ';

        container.innerHTML = `
            <div class="content-card">
                <button id="detail-view-back-btn" class="btn" style="margin-bottom: 2rem; width: auto; background-color: var(--gray-text);">&larr; –ù–∞–∑–∞–¥ –¥–æ —Å–ø–∏—Å–∫—É –º–∞–π—Å—Ç—Ä—ñ–≤</button>
                <h2>${master.name} ${master.tier ? `(${master.tier})` : ''}</h2>
                <p><strong>–°–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó:</strong> ${categoriesList}</p>
            </div>
            <div class="content-card">
                <h3>–í–∏–¥–∞—á–∞ –∞–≤–∞–Ω—Å—É</h3>
                <form id="add-advance-form" class="form-row">
                    <div class="form-group" style="flex:1;">
                        <label for="advance-amount">–°—É–º–∞ –∞–≤–∞–Ω—Å—É (z≈Ç)</label>
                        <input type="number" id="advance-amount" min="1" required>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn">–í–∏–¥–∞—Ç–∏ –∞–≤–∞–Ω—Å</button>
                    </div>
                </form>
            </div>
            <div class="content-card">
                <h3>–Ü—Å—Ç–æ—Ä—ñ—è –∞–≤–∞–Ω—Å—ñ–≤</h3>
                <ul id="master-advances-list" class="item-list"><li>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</li></ul>
            </div>
        `;

        container.onclick = function(event) {
            if (event.target.closest('#detail-view-back-btn')) {
                renderView('masters');
                return;
            }
            const deleteButton = event.target.closest('.btn-delete-advance');
            if (deleteButton) {
                handleDeleteAdvance(deleteButton.dataset.id);
                return;
            }
        };
        
        document.getElementById('add-advance-form').onsubmit = handleAddAdvance;

        const advancesCollectionRef = collection(db, 'masters', masterId, 'advances');
        masterAdvancesUnsubscribe = onSnapshot(advancesCollectionRef, (snapshot) => {
            state.viewingMasterAdvances = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const listEl = document.getElementById('master-advances-list');
            if (listEl) {
                const sortedAdvances = state.viewingMasterAdvances.sort((a, b) => b.date.toDate() - a.date.toDate());
                listEl.innerHTML = sortedAdvances.length === 0 ? '<li>–ê–≤–∞–Ω—Å—ñ–≤ —â–µ –Ω–µ –±—É–ª–æ.</li>' : sortedAdvances.map(adv => `
                    <li>
                        <span>${adv.date.toDate().toLocaleString('uk-UA')}</span>
                        <div class="actions">
                            <strong>${adv.amount} z≈Ç</strong>
                            <button class="btn btn-delete btn-delete-advance" data-id="${adv.id}">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                        </div>
                    </li>
                `).join('');
            }
        });
    }

    async function handleAddAdvance(event) {
        event.preventDefault();
        const masterId = state.viewingMasterId;
        const amountInput = document.getElementById('advance-amount');
        const amount = parseFloat(amountInput.value);
        if (!masterId || !amount || amount <= 0) {
            alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É —Å—É–º—É.');
            return;
        }
        try {
            await addDoc(collection(db, 'masters', masterId, 'advances'), {
                amount: amount,
                date: Timestamp.now()
            });
            amountInput.value = '';
        } catch (e) {
            console.error("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞—Ç–∏ –∞–≤–∞–Ω—Å: ", e);
            alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞—á—ñ –∞–≤–∞–Ω—Å—É.");
        }
    }

    async function handleDeleteAdvance(advanceId) {
        const masterId = state.viewingMasterId;
        if (!masterId || !advanceId) return;
        if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∞–≤–∞–Ω—Å? –¶—é –¥—ñ—é –Ω–µ –º–æ–∂–Ω–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏.')) {
            try {
                await deleteDoc(doc(db, 'masters', masterId, 'advances', advanceId));
            } catch (e) {
                console.error("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ –∞–≤–∞–Ω—Å: ", e);
                alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ –∞–≤–∞–Ω—Å—É.");
            }
        }
    }

    function populateCategoryCheckboxes(elementId, checkedIds = []) { const container = document.getElementById(elementId); if (!container) return; container.innerHTML = state.categories.length ? '' : '–°–ø–æ—á–∞—Ç–∫—É –¥–æ–¥–∞–π—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó'; state.categories.forEach(category => { const isChecked = checkedIds.includes(category.id); container.innerHTML += `<label><input type="checkbox" value="${category.id}" ${isChecked ? 'checked' : ''}> ${category.name}</label>`; }); }
    async function handleAddMaster(event) { event.preventDefault(); const name = document.getElementById('new-master-name').value.trim(); const tier = document.getElementById('new-master-tier').value.trim(); const priceModifier = parseFloat(document.getElementById('new-master-modifier').value) || 0; const categoryIds = Array.from(document.querySelectorAll('#new-master-categories input:checked')).map(el => el.value); if (!name) return alert("–í–≤–µ–¥—ñ—Ç—å —ñ–º'—è –º–∞–π—Å—Ç—Ä–∞."); try { await addDoc(collection(db, 'masters'), { name, tier, priceModifier, categoryIds, isFrozen: false }); event.target.reset(); } catch (e) { alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –¥–æ–¥–∞—Ç–∏ –º–∞–π—Å—Ç—Ä–∞.'); } }
    function showEditMasterModal(id) { const master = state.masters.find(m => m.id === id); if (!master) return alert('–ú–∞–π—Å—Ç—Ä–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!'); const modal = document.getElementById('edit-master-modal'); modal.style.display = 'flex'; document.getElementById('edit-master-id').value = id; document.getElementById('edit-master-name').value = master.name; document.getElementById('edit-master-tier').value = master.tier || ''; document.getElementById('edit-master-modifier').value = master.priceModifier || 0; document.getElementById('edit-master-frozen').checked = master.isFrozen || false; populateCategoryCheckboxes('edit-master-categories', master.categoryIds || []); }
    async function handleUpdateMaster(event) { event.preventDefault(); const id = document.getElementById('edit-master-id').value; const name = document.getElementById('edit-master-name').value.trim(); const tier = document.getElementById('edit-master-tier').value.trim(); const priceModifier = parseFloat(document.getElementById('edit-master-modifier').value) || 0; const categoryIds = Array.from(document.querySelectorAll('#edit-master-categories input:checked')).map(el => el.value); const isFrozen = document.getElementById('edit-master-frozen').checked; if (!name) return alert("–Ü–º'—è –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ–º."); try { await updateDoc(doc(db, 'masters', id), { name, tier, priceModifier, categoryIds, isFrozen }); document.getElementById('edit-master-modal').style.display = 'none'; } catch(e) { alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏.'); } }
    // #endregion

    // #region Services View
    function renderServicesView(container) { container.innerHTML = `<div class="services-layout"><div class="content-card"><h2>–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó</h2><form id="add-category-form" class="form-group"><input type="text" id="new-category-name" placeholder="–ù–æ–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è..." required><button class="btn" type="submit" style="width:100%; margin-top:0.5rem;">–î–æ–¥–∞—Ç–∏</button></form><ul id="categories-list" class="item-list"></ul></div><div id="services-container"><div class="content-card"><p>–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é –∑–ª—ñ–≤–∞.</p></div></div></div><div class="modal-overlay" id="edit-category-modal"><div class="modal-panel"><div class="modal-header"><h2>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</h2><button class="close-btn">&times;</button></div><form id="edit-category-form"><input type="hidden" id="edit-category-id"><div class="form-group"><label for="edit-category-name">–ù–∞–∑–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</label><input type="text" id="edit-category-name" required></div><div class="form-group"><label for="edit-category-discount">–ê–∫—Ü—ñ–π–Ω–∞ –∑–Ω–∏–∂–∫–∞ (%)</label><input type="number" id="edit-category-discount" min="0" max="100" value="0"></div><button type="submit">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏</button></form></div></div><div class="modal-overlay" id="edit-service-modal"><div class="modal-panel"><div class="modal-header"><h2 id="service-modal-title">–ü–æ—Å–ª—É–≥–∞</h2><button class="close-btn">&times;</button></div><form id="edit-service-form"><input type="hidden" id="edit-service-id"><div class="form-group"><label for="edit-service-name">–ù–∞–∑–≤–∞</label><input type="text" id="edit-service-name" required></div><div class="form-row"><div class="form-group" style="flex:1;"><label for="edit-service-duration">–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å (—Ö–≤)</label><input type="number" id="edit-service-duration" required min="0"></div><div class="form-group" style="flex:1;"><label for="edit-service-price">–¶—ñ–Ω–∞ (z≈Ç)</label><input type="number" id="edit-service-price" required min="0"></div></div><div class="form-group"><label for="edit-service-discount">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞ –∑–Ω–∏–∂–∫–∞ (%)</label><input type="number" id="edit-service-discount" min="0" max="100" value="0"></div><button type="submit">–ó–±–µ—Ä–µ–≥—Ç–∏</button></form></div></div>`; setupCategoriesLogic(); if (state.selectedCategoryId) { renderServicesForCategory(); } }
    function setupCategoriesLogic() { document.getElementById('add-category-form').onsubmit = handleAddCategory; document.getElementById('edit-category-modal').querySelector('.close-btn').onclick = () => document.getElementById('edit-category-modal').style.display = 'none'; document.getElementById('edit-category-form').onsubmit = handleUpdateCategory; const categoriesListEl = document.getElementById('categories-list'); categoriesListEl.innerHTML = state.categories.length > 0 ? '' : '<li>–ù–µ–º–∞—î –∫–∞—Ç–µ–≥–æ—Ä—ñ–π.</li>'; state.categories.forEach(category => { const li = document.createElement('li'); li.className = 'category-list-item'; li.dataset.id = category.id; if (category.id === state.selectedCategoryId) li.classList.add('selected'); li.innerHTML = `<span>${category.name} ${category.discount ? `<strong style="color:var(--danger-color);">-`+category.discount+'%</strong>' : ''}</span><div class="actions"><button class="btn btn-edit" data-id="${category.id}" data-name="${category.name}" data-discount="${category.discount || 0}">‚úèÔ∏è</button><button class="btn btn-delete" data-id="${category.id}">üóëÔ∏è</button></div>`; categoriesListEl.appendChild(li); }); categoriesListEl.onclick = (event) => { const target = event.target; if (target.closest('.btn-delete')) { handleDeleteCategory(target.closest('.btn-delete').dataset.id); } else if (target.closest('.btn-edit')) { const btn = target.closest('.btn-edit'); showEditCategoryModal(btn.dataset.id, btn.dataset.name, btn.dataset.discount); } else if (target.closest('.category-list-item')) { state.selectedCategoryId = target.closest('.category-list-item').dataset.id; renderView('services'); } }; }
    function renderServicesForCategory() { const categoryId = state.selectedCategoryId; const servicesContainer = document.getElementById('services-container'); const category = state.categories.find(c => c.id === categoryId); const categoryName = category ? category.name : ''; servicesContainer.innerHTML = `<div class="content-card"><div style="display:flex; justify-content:space-between; align-items:center;"><h2>–ü–æ—Å–ª—É–≥–∏: ${categoryName}</h2><button id="add-service-btn" class="btn">–î–æ–¥–∞—Ç–∏ –ø–æ—Å–ª—É–≥—É</button></div><ul id="services-list" class="item-list"></ul></div>`; document.getElementById('add-service-btn').onclick = () => showServiceModal(); const servicesListEl = document.getElementById('services-list'); const filteredServices = state.services.filter(s => s.categoryId === categoryId).sort((a,b)=>a.name.localeCompare(b.name)); servicesListEl.innerHTML = filteredServices.length > 0 ? '' : '<li>–ù–µ–º–∞—î –ø–æ—Å–ª—É–≥ –≤ —Ü—ñ–π –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó.</li>'; filteredServices.forEach(service => { const finalDiscount = (service.discount > 0) ? service.discount : (category?.discount || 0); const discountedPrice = service.price * (1 - finalDiscount / 100); const li = document.createElement('li'); li.innerHTML = `<div><strong>${service.name}</strong><br><small>${service.duration || 'N/A'} —Ö–≤. ${service.discount > 0 ? `(–ó–Ω–∏–∂–∫–∞ ${service.discount}%)` : ''}</small></div><div class="price-display">${finalDiscount > 0 ? `<span class="old-price">${service.price} z≈Ç</span>` : ''}<span class="new-price">${discountedPrice.toFixed(0)} z≈Ç</span></div><div class="actions"><button class="btn-edit btn-edit-service" data-id="${service.id}" data-name="${service.name}" data-duration="${service.duration}" data-price="${service.price}" data-discount="${service.discount || 0}">‚úèÔ∏è</button><button class="btn-delete btn-delete-service" data-id="${service.id}">üóëÔ∏è</button></div>`; servicesListEl.appendChild(li); }); servicesListEl.onclick = (event) => { const target = event.target.closest('button'); if (!target) return; if (target.classList.contains('btn-delete-service')) handleDeleteService(target.dataset.id); if (target.classList.contains('btn-edit-service')) { showServiceModal(target.dataset.id, target.dataset); }}; }
    async function handleAddCategory(event) { event.preventDefault(); const nameInput = document.getElementById('new-category-name'); const name = nameInput.value.trim(); if (!name) return; try { await addDoc(collection(db, 'serviceCategories'), { name, discount: 0 }); nameInput.value = ''; } catch (e) { alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –¥–æ–¥–∞—Ç–∏.'); } }
    async function handleDeleteCategory(id) { if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é —Ç–∞ –≤—Å—ñ –ø–æ—Å–ª—É–≥–∏ –≤ –Ω—ñ–π?')) return; try { const q = query(collection(db, 'services'), where('categoryId', '==', id)); const snapshot = await getDocs(q); const deletePromises = []; snapshot.forEach(doc => deletePromises.push(deleteDoc(doc.ref))); await Promise.all(deletePromises); await deleteDoc(doc(db, 'serviceCategories', id)); if (state.selectedCategoryId === id) { state.selectedCategoryId = null; } } catch (e) { alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏.'); } }
    function showEditCategoryModal(id, name, discount) { const modal = document.getElementById('edit-category-modal'); modal.style.display = 'flex'; document.getElementById('edit-category-id').value = id; document.getElementById('edit-category-name').value = name; document.getElementById('edit-category-discount').value = discount || 0; }
    async function handleUpdateCategory(event) { event.preventDefault(); const id = document.getElementById('edit-category-id').value; const name = document.getElementById('edit-category-name').value.trim(); const discount = parseFloat(document.getElementById('edit-category-discount').value) || 0; if (!name) return alert('–ù–∞–∑–≤–∞ –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—å–æ—é.'); try { await updateDoc(doc(db, 'serviceCategories', id), { name, discount }); document.getElementById('edit-category-modal').style.display = 'none'; } catch(e) { alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏.'); } }
    function showServiceModal(id = null, data = {}) { const modal = document.getElementById('edit-service-modal'); modal.style.display = 'flex'; modal.querySelector('h2').textContent = id ? '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø–æ—Å–ª—É–≥—É' : '–î–æ–¥–∞—Ç–∏ –Ω–æ–≤—É –ø–æ—Å–ª—É–≥—É'; document.getElementById('edit-service-id').value = id || ''; document.getElementById('edit-service-name').value = data.name || ''; document.getElementById('edit-service-duration').value = data.duration || ''; document.getElementById('edit-service-price').value = data.price || ''; document.getElementById('edit-service-discount').value = data.discount || 0; document.getElementById('edit-service-form').onsubmit = id ? handleUpdateService : handleAddService; document.querySelector('#edit-service-modal .close-btn').onclick = () => modal.style.display = 'none'; }
    async function handleAddService(event) { event.preventDefault(); if (!state.selectedCategoryId) return alert('–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é!'); const name = document.getElementById('edit-service-name').value.trim(); const duration = parseInt(document.getElementById('edit-service-duration').value); const price = parseFloat(document.getElementById('edit-service-price').value); const discount = parseFloat(document.getElementById('edit-service-discount').value) || 0; if (!name || !(duration>=0) || !(price>=0)) return alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ.'); try { await addDoc(collection(db, 'services'), { name, duration, price, discount, categoryId: state.selectedCategoryId }); document.getElementById('edit-service-modal').style.display = 'none'; } catch (e) { alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –¥–æ–¥–∞—Ç–∏.'); } }
    async function handleUpdateService(event) { event.preventDefault(); const id = document.getElementById('edit-service-id').value; const name = document.getElementById('edit-service-name').value.trim(); const duration = parseInt(document.getElementById('edit-service-duration').value); const price = parseFloat(document.getElementById('edit-service-price').value); const discount = parseFloat(document.getElementById('edit-service-discount').value) || 0; if (!name || !(duration>=0) || !(price>=0)) return alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ.'); try { await updateDoc(doc(db, 'services', id), { name, duration, price, discount }); document.getElementById('edit-service-modal').style.display = 'none'; } catch(e) { alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏.'); } }
    async function handleDeleteService(id) { if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ—Å–ª—É–≥—É?')) return; try { await deleteDoc(doc(db, 'services', id)); } catch (e) { alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏.'); } }
    // #endregion

    // #region Salary & Settings & Expenses
    function renderSalaryView(container) {
        const today = new Date();
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
        const todayStr = today.toISOString().split('T')[0];
        
        const masterOptions = state.masters
            .filter(m => !m.isFrozen)
            .map(m => `<option value="${m.id}">${m.name}</option>`)
            .join('');
            
        const salonOptions = state.salons.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

        container.innerHTML = `
            <div class="content-card">
                <h2>–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∑–∞—Ä–ø–ª–∞—Ç–∏</h2>
                <div class="form-row">
                    <div class="form-group" style="flex:1;">
                        <label for="salary-start-date">–ó</label>
                        <input type="date" id="salary-start-date" value="${firstDayOfMonth}">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label for="salary-end-date">–ü–æ</label>
                        <input type="date" id="salary-end-date" value="${todayStr}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex:1;">
                        <label for="salary-master-filter">–ú–∞–π—Å—Ç–µ—Ä</label>
                        <select id="salary-master-filter">
                            <option value="all">–í—Å—ñ –º–∞–π—Å—Ç—Ä–∏</option>
                            ${masterOptions}
                        </select>
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label for="salary-salon-filter">–°–∞–ª–æ–Ω</label>
                        <select id="salary-salon-filter">
                            <option value="all">–í—Å—ñ —Å–∞–ª–æ–Ω–∏ (–†–∞–∑–æ–º)</option>
                            ${salonOptions}
                        </select>
                    </div>
                </div>
                <button id="calculate-salary-btn" class="btn" style="width: 100%;">–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
            </div>
            <div id="salary-report" style="margin-top: 2rem;"></div>`;
        document.getElementById('calculate-salary-btn').onclick = handleCalculateSalary;
    }
    
    async function handleCalculateSalary() {
        const startDate = new Date(document.getElementById('salary-start-date').value);
        const endDate = new Date(document.getElementById('salary-end-date').value);
        endDate.setHours(23, 59, 59, 999);
        const reportContainer = document.getElementById('salary-report');
        reportContainer.innerHTML = '<p>–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫...</p>';
        const selectedMasterId = document.getElementById('salary-master-filter').value;
        const selectedSalonId = document.getElementById('salary-salon-filter').value;
        const salaryTiers = state.settings.salaryTiers.sort((a,b) => b.threshold - a.threshold);

        let appointmentsForSalary = state.appointments.filter(app => {
            const appointmentDate = app.dateTime.toDate();
            return app.status !== 'upcoming' && appointmentDate >= startDate && appointmentDate <= endDate;
        });
        
        if(selectedMasterId !== 'all'){
            appointmentsForSalary = appointmentsForSalary.filter(app => app.masterId === selectedMasterId);
        }

        if(selectedSalonId !== 'all'){
            appointmentsForSalary = appointmentsForSalary.filter(app => app.salonId === selectedSalonId);
        }
        
        const masterTotals = {};
        
        appointmentsForSalary.forEach(appointment => {
            const masterId = appointment.masterId;
            if (!masterTotals[masterId]) {
                const master = state.masters.find(m => m.id === masterId);
                masterTotals[masterId] = {
                    name: master ? master.name : '–ù–µ–≤—ñ–¥–æ–º–∏–π',
                    totalRevenue: 0,
                    totalSalaryBase: 0,
                    advances: 0,
                    byCash: 0,
                    byCard: 0,
                    byBlik: 0
                };
            }

            const salaryBaseForThisAppointment = typeof appointment.salaryBase === 'number' ? appointment.salaryBase : appointment.finalPrice;
            masterTotals[masterId].totalSalaryBase += salaryBaseForThisAppointment;
            
            (appointment.payments || []).forEach(p => {
                 masterTotals[masterId].totalRevenue += p.amount;
                 if (p.type === 'cash') masterTotals[masterId].byCash += p.amount;
                 else if (p.type === 'card') masterTotals[masterId].byCard += p.amount;
                 else if (p.type === 'blik') masterTotals[masterId].byBlik += p.amount;
            });
        });

        const masterIds = Object.keys(masterTotals);
        for(const masterId of masterIds) {
            const advancesSnap = await getDocs(query(collection(db, 'masters', masterId, 'advances'), where('date', '>=', startDate), where('date', '<=', endDate)));
            let totalAdvances = 0;
            advancesSnap.forEach(doc => {
                totalAdvances += doc.data().amount;
            });
            masterTotals[masterId].advances = totalAdvances;
        }

        if (Object.keys(masterTotals).length === 0) { reportContainer.innerHTML = '<p>–ó–∞ –æ–±—Ä–∞–Ω–∏–π –ø–µ—Ä—ñ–æ–¥ –Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É.</p>'; return; }

        reportContainer.innerHTML = '';
        for (const masterId in masterTotals) {
            const data = masterTotals[masterId];
            const applicableTier = salaryTiers.find(tier => data.totalSalaryBase >= tier.threshold) || { rate: 0 };
            const salaryRate = applicableTier.rate;
            const salary = data.totalSalaryBase * (salaryRate / 100);
            const finalPayout = salary - data.advances;
            
            const cardHTML = `
                <div class="salary-report-card">
                    <h3>${data.name}</h3>
                    <p><span>–í—Å—å–æ–≥–æ –∑–∞—Ä–æ–±–ª–µ–Ω–æ (–∫–∞—Å–∞):</span> <strong>${data.totalRevenue.toFixed(0)} z≈Ç</strong></p>
                    <p><span>–ë–∞–∑–∞ –¥–ª—è –Ω–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è –ó–ü:</span> <strong>${data.totalSalaryBase.toFixed(0)} z≈Ç</strong></p>
                    
                    <div style="padding-left: 1rem; font-size: 0.9em; color: var(--gray-text); border-top: 1px dashed var(--border-color); margin-top: 0.5rem; padding-top: 0.5rem;">
                        <p style="margin: 0.2rem 0;"><span>- –ì–æ—Ç—ñ–≤–∫–æ—é:</span> <span>${data.byCash.toFixed(0)} z≈Ç</span></p>
                        <p style="margin: 0.2rem 0;"><span>- –ö–∞—Ä—Ç–∫–æ—é:</span> <span>${data.byCard.toFixed(0)} z≈Ç</span></p>
                        <p style="margin: 0.2rem 0;"><span>- Blik:</span> <span>${data.byBlik.toFixed(0)} z≈Ç</span></p>
                    </div>

                    <p style="margin-top: 1rem;"><span>–ù–∞—Ä–∞—Ö–æ–≤–∞–Ω–∞ –ó–ü (${salaryRate}%):</span> <span>${salary.toFixed(0)} z≈Ç</span></p>
                    <p><span>–í–∏–¥–∞–Ω–æ –∞–≤–∞–Ω—Å—ñ–≤:</span> <span>-${data.advances.toFixed(0)} z≈Ç</span></p>
                    <p class="total-salary"><span>–î–æ –≤–∏–ø–ª–∞—Ç–∏:</span> <strong>${finalPayout.toFixed(0)} z≈Ç</strong></p>
                </div>`;
            reportContainer.innerHTML += cardHTML;
        }
    }

    function renderExpensesView(container) {
        container.innerHTML = `
            <div class="content-card">
                <h2>–î–æ–¥–∞—Ç–∏ –≤–∏—Ç—Ä–∞—Ç—É</h2>
                <form id="add-expense-form">
                    <div class="form-row">
                        <div class="form-group" style="flex:2;">
                            <label for="expense-description">–û–ø–∏—Å</label>
                            <input type="text" id="expense-description" required>
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label for="expense-amount">–°—É–º–∞ (z≈Ç)</label>
                            <input type="number" id="expense-amount" required min="0" step="0.01">
                        </div>
                         <div class="form-group" style="flex:1;">
                            <label for="expense-date">–î–∞—Ç–∞</label>
                            <input type="date" id="expense-date" required>
                        </div>
                    </div>
                    <button type="submit" class="btn">–î–æ–¥–∞—Ç–∏ –≤–∏—Ç—Ä–∞—Ç—É</button>
                </form>
            </div>
            <div class="content-card" style="margin-top:2rem;">
                <h2>–Ü—Å—Ç–æ—Ä—ñ—è –≤–∏—Ç—Ä–∞—Ç</h2>
                <ul id="expenses-list" class="item-list"></ul>
            </div>
        `;

        document.getElementById('add-expense-form').onsubmit = handleAddExpense;
        document.getElementById('expense-date').valueAsDate = new Date();
        
        const listEl = document.getElementById('expenses-list');
        listEl.innerHTML = '';
        const sortedExpenses = state.expenses.sort((a,b) => b.date.toDate() - a.date.toDate());
        if (sortedExpenses.length === 0) {
            listEl.innerHTML = '<li>–í–∏—Ç—Ä–∞—Ç —â–µ –Ω–µ –±—É–ª–æ.</li>';
        } else {
            sortedExpenses.forEach(expense => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <div>
                        <strong>${expense.description}</strong><br>
                        <small>${expense.date.toDate().toLocaleDateString('uk-UA')}</small>
                    </div>
                    <div class="actions">
                        <strong>${expense.amount.toFixed(2)} z≈Ç</strong>
                        <button class="btn btn-delete" data-id="${expense.id}">üóëÔ∏è</button>
                    </div>`;
                listEl.appendChild(li);
            });
        }
        
        listEl.onclick = (e) => {
            const deleteBtn = e.target.closest('.btn-delete');
            if (deleteBtn) {
                handleDeleteExpense(deleteBtn.dataset.id);
            }
        };
    }

    async function handleAddExpense(event) {
        event.preventDefault();
        const description = document.getElementById('expense-description').value.trim();
        const amount = parseFloat(document.getElementById('expense-amount').value);
        const date = document.getElementById('expense-date').value;

        if (!description || !amount || !date) {
            return alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è.");
        }

        try {
            await addDoc(collection(db, 'expenses'), {
                description,
                amount,
                date: Timestamp.fromDate(new Date(date))
            });
            event.target.reset();
            document.getElementById('expense-date').valueAsDate = new Date();
        } catch (e) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –≤–∏—Ç—Ä–∞—Ç–∏: ", e);
            alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –¥–æ–¥–∞—Ç–∏ –≤–∏—Ç—Ä–∞—Ç—É.");
        }
    }

    async function handleDeleteExpense(id) {
        if(confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –≤–∏—Ç—Ä–∞—Ç—É?')) {
            try {
                await deleteDoc(doc(db, 'expenses', id));
            } catch(e) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –≤–∏—Ç—Ä–∞—Ç–∏: ", e);
                alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ –≤–∏—Ç—Ä–∞—Ç—É.");
            }
        }
    }

    function renderSettingsView(container) {
        const tiers = state.settings.salaryTiers.sort((a,b) => a.threshold - b.threshold);
        let tableRows = tiers.map((tier, index) => `<tr><td>–í—ñ–¥ ${tier.threshold} z≈Ç</td><td>${tier.rate}%</td><td class="actions"><button class="btn-edit btn-edit-tier" data-index="${index}">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button><button class="btn-delete btn-delete-tier" data-index="${index}">–í–∏–¥–∞–ª–∏—Ç–∏</button></td></tr>`).join('');
        
        const salonOptions = state.salons.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

        container.innerHTML = `<div class="content-card"><h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≤—ñ–¥—Å–æ—Ç–∫—ñ–≤ –∑–∞—Ä–ø–ª–∞—Ç–∏</h2><table><thead><tr><th>–°—É–º–∞ –≤—ñ–¥ (–ø–æ—Ä—ñ–≥)</th><th>–í—ñ–¥—Å–æ—Ç–æ–∫</th><th>–î—ñ—è</th></tr></thead><tbody id="salary-tiers-table">${tableRows}</tbody></table><hr style="margin: 2rem 0;"><h3 id="tier-form-title">–î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π —Ä—ñ–≤–µ–Ω—å</h3><form id="tier-form" class="form-row"><div class="form-group" style="flex:1;"><label for="tier-threshold">–°—É–º–∞ –≤—ñ–¥ (z≈Ç)</label><input type="number" id="tier-threshold" min="0" required></div><div class="form-group" style="flex:1;"><label for="tier-rate">–í—ñ–¥—Å–æ—Ç–æ–∫ (%)</label><input type="number" id="tier-rate" min="0" max="100" required></div><div class="form-group"><button type="submit" id="tier-submit-btn" class="btn">–î–æ–¥–∞—Ç–∏</button><button type="button" id="tier-cancel-btn" class="btn" style="display:none; margin-left: 1rem; background-color: var(--gray-text)">–°–∫–∞—Å—É–≤–∞—Ç–∏</button></div></form></div><div class="content-card"><h2>–†—É—á–Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∞ –∑–≤—ñ—Ç—É</h2><p>–û–±–µ—Ä—ñ—Ç—å –ø–µ—Ä—ñ–æ–¥ —Ç–∞ —Å–∞–ª–æ–Ω, –∑–∞ —è–∫–∏–º –ø–æ—Ç—Ä—ñ–±–Ω–æ —Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –∑–≤—ñ—Ç —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –π–æ–≥–æ –Ω–∞ –ø–æ—à—Ç—É.</p><form id="manual-report-form"><div class="form-row"><div class="form-group" style="flex:1;"><label for="report-start-date">–î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É</label><input type="date" id="report-start-date" required></div><div class="form-group" style="flex:1;"><label for="report-end-date">–î–∞—Ç–∞ –∫—ñ–Ω—Ü—è</label><input type="date" id="report-end-date" required></div></div><div class="form-group"><label for="report-salon-filter">–°–∞–ª–æ–Ω</label><select id="report-salon-filter"><option value="all">–í—Å—ñ —Å–∞–ª–æ–Ω–∏ (–†–∞–∑–æ–º)</option>${salonOptions}</select></div><button type="submit" class="btn">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–≤—ñ—Ç</button></form></div>
<div class="content-card">
    <h2>–ó–º—ñ–Ω–∞ –ø–∞—Ä–æ–ª—é</h2>
    <p>–¢—É—Ç –≤–∏ –º–æ–∂–µ—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ —Å–≤—ñ–π –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥—É –≤ —Å–∏—Å—Ç–µ–º—É.</p>
    <form id="change-password-form">
        <div class="form-group">
            <label for="new-password">–ù–æ–≤–∏–π –ø–∞—Ä–æ–ª—å</label>
            <input type="password" id="new-password" required minlength="6" autocomplete="new-password">
        </div>
        <div class="form-group">
            <label for="confirm-password">–ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å –Ω–æ–≤–∏–π –ø–∞—Ä–æ–ª—å</label>
            <input type="password" id="confirm-password" required minlength="6" autocomplete="new-password">
        </div>
        <button type="submit" class="btn">–ó–º—ñ–Ω–∏—Ç–∏ –ø–∞—Ä–æ–ª—å</button>
        <p id="password-change-status" style="margin-top: 1rem; color: var(--gray-text);"></p>
    </form>
</div>`;
        document.getElementById('tier-form').onsubmit = handleSaveSalaryTier;
        document.getElementById('tier-cancel-btn').onclick = () => { state.editingTierIndex = null; renderView('settings'); };
        document.getElementById('salary-tiers-table').onclick = (e) => {
            if(e.target.classList.contains('btn-delete-tier')) { handleDeleteSalaryTier(parseInt(e.target.dataset.index)); }
            if(e.target.classList.contains('btn-edit-tier')) { handleEditSalaryTier(parseInt(e.target.dataset.index)); }
        };
        document.getElementById('manual-report-form').onsubmit = handleManualReport;
        document.getElementById('change-password-form').onsubmit = handleChangePassword;
    }
    function handleEditSalaryTier(index) {
        state.editingTierIndex = index;
        const tier = state.settings.salaryTiers[index];
        document.getElementById('tier-form-title').innerText = '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ä—ñ–≤–µ–Ω—å';
        document.getElementById('tier-threshold').value = tier.threshold;
        document.getElementById('tier-rate').value = tier.rate;
        document.getElementById('tier-submit-btn').innerText = '–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏';
        document.getElementById('tier-cancel-btn').style.display = 'inline-block';
    }
    async function handleSaveSalaryTier(event) {
        event.preventDefault();
        const threshold = parseInt(document.getElementById('tier-threshold').value);
        const rate = parseInt(document.getElementById('tier-rate').value);
        let newTiers = [...state.settings.salaryTiers];
        if (state.editingTierIndex !== null) { newTiers[state.editingTierIndex] = { threshold, rate }; } 
        else { newTiers.push({ threshold, rate }); }
        state.editingTierIndex = null;
        try { await setDoc(doc(db, 'settings', 'salaryRules'), { tiers: newTiers }); } 
        catch(e) { console.error("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ä—ñ–≤–Ω—è:", e); alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ —Ä—ñ–≤–µ–Ω—å.'); }
    }
    async function handleDeleteSalaryTier(index) {
        if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ä—ñ–≤–µ–Ω—å?')) return;
        const newTiers = state.settings.salaryTiers.filter((_, i) => i !== index);
        try { await setDoc(doc(db, 'settings', 'salaryRules'), { tiers: newTiers }); } 
        catch(e) { console.error("–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Ä—ñ–≤–Ω—è:", e); alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ —Ä—ñ–≤–µ–Ω—å.'); }
    }
    
    async function handleManualReport(event) {
        event.preventDefault();
        const btn = event.target.querySelector('button[type="submit"]');
        btn.disabled = true; btn.textContent = '–í—ñ–¥–ø—Ä–∞–≤–∫–∞...';
        const startDate = document.getElementById('report-start-date').value;
        const endDate = document.getElementById('report-end-date').value;
        const salonId = document.getElementById('report-salon-filter').value;

        if (!startDate || !endDate) {
            alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –æ–±–∏–¥–≤—ñ –¥–∞—Ç–∏.');
            btn.disabled = false; btn.textContent = '–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–≤—ñ—Ç';
            return;
        }
        try {
            const generateReport = httpsCallable(functions, 'generateAndSendReport');
            const result = await generateReport({ startDate, endDate, salonId });
            alert(result.data.message);
        } catch (error) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –≤–∏–∫–ª–∏–∫—É —Ö–º–∞—Ä–Ω–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó:", error);
            alert(`–ü–æ–º–∏–ª–∫–∞: ${error.message}`);
        } finally {
            btn.disabled = false;
            btn.textContent = '–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–≤—ñ—Ç';
        }
    }
    
    async function handleChangePassword(event) {
        event.preventDefault();
        const newPasswordInput = document.getElementById('new-password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const statusEl = document.getElementById('password-change-status');
        
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        if (newPassword.length < 6) {
            statusEl.textContent = '–ü–∞—Ä–æ–ª—å –º–∞—î –±—É—Ç–∏ –Ω–µ –º–µ–Ω—à–µ 6 —Å–∏–º–≤–æ–ª—ñ–≤.';
            statusEl.style.color = 'var(--danger-color)';
            return;
        }

        if (newPassword !== confirmPassword) {
            statusEl.textContent = '–ü–∞—Ä–æ–ª—ñ –Ω–µ —Å–ø—ñ–≤–ø–∞–¥–∞—é—Ç—å.';
            statusEl.style.color = 'var(--danger-color)';
            return;
        }

        const user = auth.currentUser;
        if (!user) {
            statusEl.textContent = '–ü–æ–º–∏–ª–∫–∞: –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π.';
            statusEl.style.color = 'var(--danger-color)';
            return;
        }

        statusEl.textContent = '–ó–º—ñ–Ω–∞ –ø–∞—Ä–æ–ª—é...';
        statusEl.style.color = 'var(--gray-text)';

        try {
            await updatePassword(user, newPassword);
            statusEl.textContent = '–ü–∞—Ä–æ–ª—å —É—Å–ø—ñ—à–Ω–æ –∑–º—ñ–Ω–µ–Ω–æ!';
            statusEl.style.color = 'var(--success-color)';
            newPasswordInput.value = '';
            confirmPasswordInput.value = '';
        } catch (error) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –∑–º—ñ–Ω–∏ –ø–∞—Ä–æ–ª—è:", error);
            if (error.code === 'auth/requires-recent-login') {
                statusEl.textContent = '–¶—è –æ–ø–µ—Ä–∞—Ü—ñ—è –≤–∏–º–∞–≥–∞—î –Ω–µ—â–æ–¥–∞–≤–Ω—å–æ–≥–æ –≤—Ö–æ–¥—É. –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–π–¥—ñ—Ç—å —ñ —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.';
            } else {
                statusEl.textContent = `–ü–æ–º–∏–ª–∫–∞: ${error.message}`;
            }
            statusEl.style.color = 'var(--danger-color)';
        }
    }
    // #endregion

    async function handleLogin(e) { 
        e.preventDefault();
        const email = document.getElementById('email').value.trim(); 
        const password = document.getElementById('password').value; 
        try { 
            await signInWithEmailAndPassword(auth, email, password);
        } catch (err) { 
            document.getElementById('login-error').innerText = "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π email –∞–±–æ –ø–∞—Ä–æ–ª—å.";
        } 
    }
</script>
</body>
</html>
