<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Lashroom by Kalancha CRM</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="robots" content="noindex, nofollow">
    <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
    
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core/locales/uk.global.js'></script>

    <style>
        :root {
            --main-bg: #f4f7fa;
            --panel-bg: #ffffff;
            --text-color: #1a1a1a;
            --gray-text: #6c757d;
            --border-color: #e9ecef;
            --primary-color: #2c3e50;
            --primary-hover: #34495e;
            --danger-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        body { font-family: 'Inter', Arial, sans-serif; background: var(--main-bg); margin: 0; padding: 0; color: var(--text-color); font-size: 16px; }
        * { box-sizing: border-box; }
        .auth-bg { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);}
        .auth-card { background: var(--panel-bg); padding: 40px 32px; border-radius: 12px; box-shadow: var(--shadow); width: 360px; max-width: 96vw; text-align: center; }
        .auth-card h1 { font-size: 1.8rem; margin: 0 0 24px 0; }
        .auth-card input { width: 100%; margin-bottom: 16px; padding: 12px 14px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; outline: none; transition: border-color .2s; }
        .auth-card input:focus { border-color: var(--primary-color); }
        .auth-card button { width: 100%; background: var(--primary-color); color: #fff; border: none; font-weight: 600; transition:.2s; cursor:pointer; padding: 12px 14px; border-radius: 8px; font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px;}
        .auth-card button:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .error-msg { color: var(--danger-color); margin-bottom: 12px; min-height: 1.2em; font-weight: 600;}
        
        .crm-layout { display: flex; height: 100vh; }
        .crm-nav { background: var(--primary-color); color: #ecf0f1; width: 240px; flex-shrink: 0; display: flex; flex-direction: column; padding: 1.5rem 0; box-shadow: 5px 0px 15px rgba(0,0,0,0.05); z-index: 10; }
        .crm-nav h1 { font-size: 1.5rem; text-align: center; margin: 0 0 2rem 0; color: #fff; letter-spacing: 1px; }
        .crm-nav ul { list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto; }
        .crm-nav li { padding: 1rem 1.5rem; cursor: pointer; border-left: 4px solid transparent; transition: all .2s; }
        .crm-nav li:hover { background-color: rgba(255,255,255,0.05); }
        .crm-nav li.active { background-color: rgba(255,255,255,0.1); border-left-color: var(--success-color); font-weight: 600; }
        .crm-nav .user-info { padding: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); text-align: center; flex-shrink: 0; }
        .crm-nav .user-info span { display: block; word-wrap: break-word; font-size: 0.9rem; margin-bottom: 1rem; }
        .crm-nav .user-info button { width: 100%; background: rgba(255,255,255,0.1); border: 1px solid #fff; color: #fff; padding: 0.75rem; border-radius: 6px; cursor: pointer; }
        .crm-nav .user-info button:hover { background: var(--danger-color); border-color: var(--danger-color); }

        .crm-main { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .crm-header { background: var(--panel-bg); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .crm-header h2 { font-size: 1.5rem; margin: 0; }
        .crm-content { flex-grow: 1; padding: 2rem; overflow-y: auto; display: flex; justify-content: center; }
        .content-wrapper { width: 100%; max-width: 1200px; }

        .content-card { background: var(--panel-bg); padding: 2rem; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 2rem; }
        .content-card h2, .content-card h3 { margin-top: 0; color: var(--primary-color); }
        .item-list { padding: 0; list-style: none; margin: 0; }
        .item-list li { display: flex; justify-content: space-between; align-items:center; padding: 1rem; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s; }
        .item-list li:hover { background-color: #f8f9fa; }
        .item-list li.is-frozen { opacity: 0.5; background-color: #f8f9fa; }
        .item-list li:last-child { border-bottom: none; }
        .actions { display: flex; gap: 0.5rem; align-items: center; }
        
        .btn, button { font-family: 'Inter', Arial, sans-serif; cursor: pointer; border-radius: 6px; padding: 0.5rem 1rem; font-weight: 600; text-decoration: none; display: inline-block; text-align: center; transition: all .2s; }
        .btn-edit, .btn-delete { border: 1px solid; background-color: transparent; }
        .btn-edit { color: var(--gray-text); border-color: var(--gray-text); }
        .btn-edit:hover { background-color: var(--gray-text); color: #fff; }
        .btn-delete { color: var(--danger-color); border-color: var(--danger-color); }
        .btn-delete:hover { background-color: var(--danger-color); color: #fff; }
        .btn-complete-payment { background-color: transparent; color: var(--success-color); border-color: var(--success-color); }
        .btn-complete-payment:hover { background-color: var(--success-color); color: #fff; }
        
        .form-group { margin-bottom: 1.5rem; }
        .form-group input, .form-group select, .form-group textarea { appearance: none; -webkit-appearance: none; width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; background-color: #fff; transition: border-color .2s; }
        .form-group select { background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%236c757d%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto; padding-right: 2.5em; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--primary-color); outline: none; }
        .form-row { display: flex; gap: 1rem; align-items: flex-end; }
        form button[type="submit"] { background: var(--primary-color); color: #fff; border: none; }
        form button[type="submit"]:hover { background: var(--primary-hover); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-panel { background: #fff; padding: 2rem; border-radius: 8px; width: 550px; max-width: 90vw; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h2 { margin: 0; }
        .close-btn { font-size: 1.5rem; background: none; border: none; cursor: pointer; }
        
        .payment-summary p { margin: 0.5rem 0; display: flex; justify-content: space-between; font-size: 1.1rem;}
        .payment-summary p.total { font-weight: bold; font-size: 1.2rem; border-top: 1px solid var(--border-color); padding-top: 0.5rem; margin-top: 0.5rem;}
        .payment-summary p.remaining { color: var(--danger-color); font-weight: bold; font-size: 1.3rem;}

        .services-layout { display: grid; grid-template-columns: 300px 1fr; gap: 2rem; align-items: start; }
        .category-list-item { cursor: pointer; }
        .category-list-item.selected { font-weight: bold; background-color: var(--main-bg); }
        .price-display { text-align: right; } .price-display .old-price { text-decoration: line-through; color: var(--gray-text); margin-right: 0.5rem; font-size: 0.9em; } .price-display .new-price { font-weight: bold; }
        
        .category-checkbox-group { max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); padding: 1rem; border-radius: 8px; }
        .category-checkbox-group label { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; font-weight: normal; }
        .category-checkbox-group input[type="checkbox"] { appearance: auto; -webkit-appearance: auto; width: auto; }
        
        #final-price-display { font-size: 1.5rem; font-weight: bold; text-align: right; margin-top: 1rem; padding-top: 1rem; border-top: 2px solid var(--primary-color);}
        
        .salary-report-card { background: #fff; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .salary-report-card h3 { margin: 0 0 1rem 0; }
        .salary-report-card p { margin: 0.5rem 0; display: flex; justify-content: space-between; }
        .salary-report-card .total-salary { font-weight: bold; font-size: 1.2rem; color: var(--danger-color); border-top: 1px solid var(--border-color); padding-top: 0.5rem; margin-top: 0.5rem;}
        
        /* [НОВА ФІШКА: Видача ЗП] - Стилі для карток видачі ЗП */
        .payout-card {
            background: #fff;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .payout-card h3 {
            margin: 0 0 1.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .payout-card-details p {
            margin: 0.75rem 0;
            display: flex;
            justify-content: space-between;
            font-size: 1.1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        .payout-card-details p:last-child {
            border-bottom: none;
        }
        .payout-card-details strong {
            font-weight: 600;
        }
        .payout-card-details .balance-due {
            font-size: 1.3rem;
            color: var(--danger-color);
            font-weight: bold;
        }
        .payout-action-form {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid var(--main-bg);
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .status-badge { padding: 0.2em 0.6em; border-radius: 10px; font-size: 0.8em; color: white; }
        .status-completed { background-color: var(--success-color); }
        .status-upcoming { background-color: var(--gray-text); }
        .status-partially-paid { background-color: var(--warning-color); }

        #calendar-container { display: flex; flex-direction: column; gap: 1rem; }
        #calendar { height: 80vh; }
        .fc-event { font-size: 0.8em; cursor: pointer; }
        .fc-event-main-frame { text-wrap: wrap; }
        .fc-event.past-event { background-color: #dbe4f0 !important; border-color: #dbe4f0 !important; color: #6c757d;}
        .fc-event-title { font-weight: 600; }
        .fc-event-service { font-size: 0.9em; opacity: 0.8; }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 1.5rem; } th, td { text-align: left; padding: 0.75rem; border-bottom: 1px solid var(--border-color); } th { background-color: var(--main-bg); }
        
        .client-search-container, .service-search-container { position: relative; }
        #client-search-results, #service-search-results { position: absolute; background: white; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; width: 100%; z-index: 100; max-height: 200px; overflow-y: auto; }
        #client-search-results div, #service-search-results div { padding: 0.75rem; cursor: pointer; }
        #client-search-results div:hover, #service-search-results div:hover { background-color: var(--main-bg); }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;}
        .stat-card { background-color: var(--main-bg); padding: 1.5rem; border-radius: 8px; text-align: center;}
        .stat-card .value { font-size: 2rem; font-weight: 600; color: var(--primary-color); }
        .stat-card .label { font-size: 0.9rem; color: var(--gray-text); }

        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem; text-align: center; }
        .summary-card { background-color: var(--main-bg); padding: 1rem; border-radius: 8px; }
        .summary-card .value { font-size: 2rem; font-weight: 600; color: var(--primary-color); }
        .summary-card .label { font-size: 0.9rem; color: var(--gray-text); margin-top: 0.25rem; }
        
        #salary-group-tiers-table .form-row { margin-bottom: 0.5rem; }
        #salary-group-tiers-table input { font-size: 0.9em; padding: 0.5rem; }
        #notepad-entries li { padding: 1rem; border-bottom: 1px solid var(--border-color); }
        #notepad-entries small { color: var(--gray-text); }
    </style>
</head>
<body>
<div id="app"></div>

<div class="modal-overlay" id="payment-modal">
    <div class="modal-panel" style="width: 450px;">
        <div class="modal-header">
            <h2>Внести оплату</h2>
            <button class="close-btn">&times;</button>
        </div>
        <div id="payment-summary" class="payment-summary">
            <p><span>Повна вартість:</span> <strong id="payment-total-price">0 zł</strong></p>
            <p><span>Вже сплачено:</span> <strong id="payment-total-paid">0 zł</strong></p>
            <p class="remaining"><span>Залишилось до сплати:</span> <strong id="payment-remaining">0 zł</strong></p>
        </div>
        <hr style="margin: 1.5rem 0;">
        <form id="payment-form">
            <input type="hidden" id="payment-appointment-id">
            <div class="form-row">
                <div class="form-group" style="flex:2;">
                    <label for="payment-amount">Сума до сплати зараз</label>
                    <input type="number" id="payment-amount" required min="0.01" step="any">
                </div>
                <div class="form-group" style="flex:1;">
                    <label for="payment-modal-type">Тип оплати</label>
                     <select id="payment-modal-type">
                        <option value="cash">Готівка</option>
                        <option value="card">Картка</option>
                        <option value="blik">Blik</option>
                     </select>
                </div>
            </div>
            <button type="submit">Підтвердити оплату</button>
        </form>
    </div>
</div>

<div class="modal-overlay" id="appointment-action-modal">
    <div class="modal-panel">
        <div class="modal-header">
            <h2 id="action-modal-title">Деталі запису</h2>
             <button class="close-btn">&times;</button>
        </div>
        <div id="action-modal-details">
        </div>
        <div id="action-modal-buttons" style="margin-top: 1.5rem; display: flex; flex-direction: column; gap: 0.5rem;">
        </div>
    </div>
</div>

<div class="modal-overlay" id="edit-payments-modal">
    <div class="modal-panel" style="width: 500px;">
        <div class="modal-header">
            <h2>Редагувати оплати</h2>
            <button class="close-btn">&times;</button>
        </div>
        <form id="edit-payments-form">
            <input type="hidden" id="edit-payments-appointment-id">
            <p>Ви можете змінити тип оплати або видалити платіж.</p>
            <ul id="edit-payments-list" class="item-list"></ul>
            <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
                <button type="button" id="cancel-edit-payments-btn" class="btn btn-edit">Скасувати</button>
                <button type="submit" class="btn">Зберегти зміни</button>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="payout-history-modal">
    <div class="modal-panel" style="width: 600px;">
        <div class="modal-header">
            <h2 id="payout-history-modal-title">Історія виплат</h2>
            <button class="close-btn">&times;</button>
        </div>
        <ul id="payout-history-list" class="item-list"></ul>
    </div>
</div>

<div class="modal-overlay" id="salary-group-modal">
    <div class="modal-panel" style="width: 550px;">
        <div class="modal-header">
            <h2 id="salary-group-modal-title">Створити групу</h2>
            <button class="close-btn">&times;</button>
        </div>
        <form id="salary-group-form">
            <input type="hidden" id="edit-salary-group-id">
            <div class="form-group">
                <label for="salary-group-name">Назва групи</label>
                <input type="text" id="salary-group-name" required>
             </div>
            <h3>Рівні зарплати</h3>
            <div id="salary-group-tiers-table"></div>
            <button type="button" class="btn" id="add-tier-to-group-btn" style="margin-bottom: 1.5rem;">+ Додати рівень</button>
            <hr>
            <button type="submit" class="btn" style="margin-top: 1.5rem;">Зберегти групу</button>
        </form>
    </div>
</div>

<div class="modal-overlay" id="confirm-modal">
    <div class="modal-panel" style="width: 400px; text-align: center;">
        <div class="modal-header" style="justify-content: center;">
            <h2 id="confirm-modal-title">Підтвердження дії</h2>
        </div>
        <p id="confirm-modal-message" style="margin-bottom: 2rem; font-size: 1.1rem;"></p>
        <div style="display: flex; justify-content: center; gap: 1rem;">
            <button id="confirm-modal-cancel-btn" class="btn btn-edit">Скасувати</button>
            <button id="confirm-modal-confirm-btn" class="btn btn-delete">Підтвердити</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="confirm-reason-modal">
    <div class="modal-panel" style="width: 450px; text-align: center;">
        <div class="modal-header" style="justify-content: center;">
            <h2 id="confirm-reason-modal-title">Підтвердження дії</h2>
        </div>
        <p id="confirm-reason-modal-message" style="margin-bottom: 1rem; font-size: 1.1rem;"></p>
        <div class="form-group" style="text-align: left;">
            <label for="confirm-reason-input">Причина (необов'язково)</label>
            <textarea id="confirm-reason-input" rows="3" placeholder="Вкажіть причину видалення..."></textarea>
        </div>
        <div style="display: flex; justify-content: center; gap: 1rem;">
            <button id="confirm-reason-modal-cancel-btn" class="btn btn-edit">Скасувати</button>
            <button id="confirm-reason-modal-confirm-btn" class="btn btn-delete">Підтвердити</button>
        </div>
    </div>
</div>

<div id="notification-toast" style="position: fixed; bottom: 20px; right: 20px; background-color: var(--success-color); color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: var(--shadow); z-index: 2000; opacity: 0; display: none; transition: opacity 0.5s ease-in-out;">
    <span id="notification-message"></span>
</div>


<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, updateDoc, getDocs, getDoc, Timestamp, setDoc, query, where, arrayUnion, increment, collectionGroup, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";

    const firebaseConfig = { apiKey: "AIzaSyBoGeREvdgrVSm-S4f3cW0HyB7Us9yh_us", authDomain: "bykalancha.firebaseapp.com", projectId: "bykalancha", storageBucket: "bykalancha.appspot.com", messagingSenderId: "196166318613", appId: "1:196166318613:web:0067f9de531e290e43ec1c", measurementId: "G-V72ECFLKFE" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const functions = getFunctions(app, 'europe-central2');
    const appContainer = document.getElementById('app');

    let state = {
        user: null,
        salons: [],
        expenses: [],
        salonExpenses: [],
        productSales: [], 
        advances: [],
        salaryGroups: [],
        notepadEntries: [],
        staff: [],
        auditLog: [],
        selectedCategoryId: null,
        categories: [],
        services: [],
        masters: [],
        appointments: [],
        clients: [],
        currentView: 'calendar',
        preselectedAppointment: null,
        calendarSelectedMasterId: 'all',
        calendarSelectedSalonId: 'all',
        editingAppointmentId: null,
        selectedClientForAppointment: null,
        selectedServiceForAppointment: null,
        viewingClientId: null,
        viewingMasterId: null,
        viewingMasterAdvances: [],
        viewingStaffId: null,
        viewingStaffBonuses: [],
        viewingStaffAdvances: [],
        staffPayouts: [],
        appointmentsPage: 1,
        appointmentsListDate: new Date(),
    };
    let listenersAreActive = false;
    let masterAdvancesUnsubscribe = null;
    let staffSubcollectionUnsubscribers = [];
    let mainUnsubscribers = [];
    
    // #region UI Helper Functions (Notifications & Confirmations)
    function showNotification(message, type = 'success') {
        const toast = document.getElementById('notification-toast');
        if (!toast) return;
        const messageEl = document.getElementById('notification-message');
        
        messageEl.textContent = message;
        toast.style.backgroundColor = type === 'success' ? 'var(--success-color)' : 'var(--danger-color)';
        toast.style.display = 'block';
        setTimeout(() => toast.style.opacity = 1, 10);
        
        setTimeout(() => {
            toast.style.opacity = 0;
            setTimeout(() => {
                toast.style.display = 'none';
            }, 500);
        }, 3000);
    }

    function showConfirmModal(message, onConfirm) {
        const confirmModal = document.getElementById('confirm-modal');
        if (!confirmModal) return;
        
        const messageEl = document.getElementById('confirm-modal-message');
        const confirmBtn = document.getElementById('confirm-modal-confirm-btn');
        const cancelBtn = document.getElementById('confirm-modal-cancel-btn');
        
        messageEl.textContent = message;
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        
        const hideModal = () => {
            confirmModal.style.display = 'none';
        };

        newConfirmBtn.onclick = () => {
            hideModal();
            onConfirm();
        };
        cancelBtn.onclick = hideModal;
        
        confirmModal.style.display = 'flex';
    }

    function showConfirmWithReasonModal(message, onConfirm) {
        const modal = document.getElementById('confirm-reason-modal');
        if (!modal) return;
        
        const messageEl = document.getElementById('confirm-reason-modal-message');
        const confirmBtn = document.getElementById('confirm-reason-modal-confirm-btn');
        const cancelBtn = document.getElementById('confirm-reason-modal-cancel-btn');
        const reasonInput = document.getElementById('confirm-reason-input');
        messageEl.textContent = message;
        reasonInput.value = ''; 
        
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        const hideModal = () => {
            modal.style.display = 'none';
        };

        newConfirmBtn.onclick = () => {
            hideModal();
            const reason = reasonInput.value.trim();
            onConfirm(reason); 
        };
        
        cancelBtn.onclick = hideModal;
        
        modal.style.display = 'flex';
    }
    // #endregion

    async function handleLogin(e) { 
        e.preventDefault();
        const email = document.getElementById('email').value.trim(); 
        const password = document.getElementById('password').value; 
        try { 
            await signInWithEmailAndPassword(auth, email, password);
        } catch (err) { 
            document.getElementById('login-error').innerText = "Неправильний email або пароль.";
        } 
    }

    onAuthStateChanged(auth, async (user) => {
    if (user) {
        if (listenersAreActive) return;
        appContainer.innerHTML = '<h1>Завантаження...</h1>';
        
        const userDocRef = doc(db, "users", user.uid);
        const userDocSnap = await getDoc(userDocRef);

        state.user = { 
            uid: user.uid, 
            email: user.email, 
            role: userDocSnap.exists() ? userDocSnap.data().role : 'master',
            salonId: userDocSnap.exists() ? userDocSnap.data().salonId : null
        };

        renderAppLayout(state.user);
        setupRealtimeListeners();
    } else {
        // [ПОЧАТОК ВИПРАВЛЕННЯ] Повна очистка при виході
        
        // Відписуємося від всіх основних слухачів
        mainUnsubscribers.forEach(unsub => unsub());
        mainUnsubscribers = [];

        // Відписуємося від специфічних слухачів (якщо вони є)
        if(masterAdvancesUnsubscribe) masterAdvancesUnsubscribe();
        staffSubcollectionUnsubscribers.forEach(unsub => unsub());
        staffSubcollectionUnsubscribers = [];

        listenersAreActive = false;
        renderLoginView();
        // [КІНЕЦЬ ВИПРАВЛЕННЯ]
    }
});

    function setupRealtimeListeners() {
    if (listenersAreActive) return;
    
    // Повна очистка всіх попередніх підписок при запуску
    mainUnsubscribers.forEach(unsub => unsub());
    mainUnsubscribers = [];

    const collections = { 
        salons: 'salons',
        categories: 'serviceCategories', 
        services: 'services', 
        masters: 'masters',
        appointments: 'appointments', 
        clients: 'clients',
        expenses: 'expenses',
        salonExpenses: 'salonExpenses',
        notepadEntries: 'notepadEntries',
        productSales: 'productSales',
        staff: 'staff',
        auditLog: 'auditLog',
        salaryGroups: 'salaryGroups'
    };

    const userRole = state.user.role;
    const userSalonId = state.user.salonId;
    
    Object.entries(collections).forEach(([stateKey, colName]) => {
        // Пропускаємо завантаження даних, до яких немає доступу
        if ((colName === 'expenses' || colName === 'auditLog' || colName === 'salaryGroups') && userRole !== 'admin') {
            return;
        }

        let q;
        let baseQuery = collection(db, colName);
        const collectionsToFilterBySalon = ['appointments', 'salonExpenses', 'productSales', 'staff'];

        // Застосовуємо фільтрацію по салону для salon_admin
        if (userRole === 'salon_admin') {
            if (collectionsToFilterBySalon.includes(colName)) {
                q = query(baseQuery, where("salonId", "==", userSalonId));
            } else if (colName === 'masters') {
                q = query(baseQuery, where("salonIds", "array-contains", userSalonId));
            } else {
                q = query(baseQuery);
            }
        } else {
            q = query(baseQuery);
        }
        
        // Сортування на рівні запиту залишаємо тільки для appointments, де поле дати стабільне
        if (colName === 'appointments') {
             q = query(q, orderBy("dateTime", "desc"));
        }

        const unsubscribe = onSnapshot(q, snapshot => {
            let docs = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
            
            // Сортуємо дані по даті в браузері, щоб обробити і 'date', і 'timestamp'
            if (['auditLog', 'expenses', 'productSales', 'salonExpenses', 'notepadEntries'].includes(colName)) {
                docs.sort((a, b) => {
                    const timeA = (a.timestamp || a.date)?.toDate().getTime() || 0;
                    const timeB = (b.timestamp || b.date)?.toDate().getTime() || 0;
                    return timeB - timeA;
                });
            }
            
            state[stateKey] = docs;
            
            // Сортування за іменем для довідників
            if (['categories', 'masters', 'clients', 'staff', 'salons'].includes(stateKey)) {
                state[stateKey].sort((a,b) => a.name.localeCompare(b.name));
            }

            if (state.user) {
                renderView(state.currentView);
            }
        }, error => {
            console.error(`Error fetching ${colName}:`, error);
        });

        // Зберігаємо функцію відписки, щоб потім її викликати при виході з системи
        mainUnsubscribers.push(unsubscribe);
    });

    // Окремий слухач для авансів (collectionGroup)
    const isAdminOrSalonAdmin = userRole === 'admin' || userRole === 'salon_admin';
    if (isAdminOrSalonAdmin) {
        const unsubAdvances = onSnapshot(query(collectionGroup(db, 'advances')), snapshot => {
            state.advances = snapshot.docs.map(d => d.data());
            if (state.user && state.currentView === 'calendar') {
                renderDailySummary();
            }
        });
        mainUnsubscribers.push(unsubAdvances);
    }
    
    listenersAreActive = true;
}

    // #region Core App Logic & Audit
    async function logAndExecute(action, details, operationFn) {
        try {
            const operationResult = await operationFn();
            await addDoc(collection(db, 'auditLog'), {
                action: action,
                details: details,
                userEmail: state.user.email,
                timestamp: Timestamp.now()
            });
            return operationResult;
        } catch (error) {
            console.error(`Error during logged action "${action}":`, error);
            throw error;
        }
    }

    function renderLoginView() {
        appContainer.innerHTML = `<div class="auth-bg"><div class="auth-card"><h1>Вхід у CRM</h1><div id="login-error" class="error-msg"></div><input id="email" type="email" placeholder="Email" autocomplete="username" autofocus><input id="password" type="password" placeholder="Пароль" autocomplete="current-password"><button id="login-btn">Увійти</button></div></div>`;
        document.getElementById('login-btn').onclick = handleLogin;
    }

    function renderAppLayout(user) {
        let adminTabs = '';
        if (user.role === 'admin') {
            adminTabs = `
                <li data-view="salary">Звіт по ЗП</li>
                <li data-view="payouts">Видача ЗП</li> <li data-view="expenses">Загальні витрати</li>
                <li data-view="settings">Налаштування</li>
                <li data-view="staff">Персонал</li>
                <li data-view="auditLog">Журнал дій</li>
            `;
        }

        let shopTab = '';
        if (user.role === 'admin' || user.role === 'salon_admin') {
            // [НОВА ФІШКА: Видача ЗП] - Додаємо таб для salon_admin, якщо його ще немає в adminTabs
            const payoutTabForSalonAdmin = user.role === 'salon_admin' ? '<li data-view="payouts">Видача ЗП</li>' : '';
            shopTab = `
                <li data-view="shop">Магазин</li>
                ${payoutTabForSalonAdmin}
            `;
        }
        
        const allUserTabs = `
            <li data-view="salonExpenses">Витрати в салоні</li>
            <li data-view="notepad">Блокнот</li>
        `;
        
        appContainer.innerHTML = `
        <div class="crm-layout">
            <nav class="crm-nav" id="main-nav">
                <h1>Lashroom CRM</h1>
                <ul>
                    <li data-view="calendar">Календар</li>
                    <li data-view="appointments">Запис</li>
                    <li data-view="clients">Клієнти</li>
                    <li data-view="services">Послуги</li>
                    <li data-view="masters">Майстри</li>
                    ${shopTab}
                    ${allUserTabs}
                    ${adminTabs}
                </ul>
                <div class="user-info">
                    <span>${user.email} (${user.role})</span>
                    <button id="logout-btn" class="btn">Вийти</button>
                </div>
            </nav>
            <main class="crm-main">
                <header class="crm-header">
                    <h2 id="header-title"></h2>
                </header>
                <div class="crm-content">
                    <div class="content-wrapper" id="content-wrapper"></div>
                </div>
            </main>
        </div>`;

        document.getElementById('logout-btn').onclick = () => {
            listenersAreActive = false;
            if(masterAdvancesUnsubscribe) masterAdvancesUnsubscribe();
            staffSubcollectionUnsubscribers.forEach(unsub => unsub());
            staffSubcollectionUnsubscribers = [];
            signOut(auth);
        };
        document.getElementById('main-nav').onclick = (event) => {
            const target = event.target.closest('li');
            if (target) renderView(target.dataset.view);
        };
        document.getElementById('payment-modal').querySelector('.close-btn').onclick = () => {
            document.getElementById('payment-modal').style.display = 'none';
        };
        document.getElementById('payment-form').onsubmit = handleConfirmPayment;

        // [НОВА ФІШКА: Видача ЗП]
        document.getElementById('payout-history-modal').querySelector('.close-btn').onclick = () => {
            document.getElementById('payout-history-modal').style.display = 'none';
        };

        document.getElementById('salary-group-modal').querySelector('.close-btn').onclick = () => {
            document.getElementById('salary-group-modal').style.display = 'none';
        };
        
        const actionModal = document.getElementById('appointment-action-modal');
        if(actionModal) {
            actionModal.querySelector('.close-btn').onclick = () => {
                actionModal.style.display = 'none';
            };
        }
        
        const editPaymentsModal = document.getElementById('edit-payments-modal');
        if (editPaymentsModal) {
            editPaymentsModal.querySelector('.close-btn').onclick = () => {
                editPaymentsModal.style.display = 'none';
            };
            document.getElementById('cancel-edit-payments-btn').onclick = () => {
                editPaymentsModal.style.display = 'none';
            };
            document.getElementById('edit-payments-form').onsubmit = handleUpdatePayments;
        }

        renderView(state.currentView);
    }

    function renderView(viewName) {
        if (!state.user) return;
        
        const masterViews = ['calendar', 'appointments', 'notepad', 'salonExpenses'];
        if (state.user.role === 'master' && !masterViews.includes(viewName)) {
             viewName = 'calendar';
        }
        
        const salonAdminForbiddenViews = ['settings', 'salary', 'expenses', 'staff', 'auditLog'];
        if (state.user.role === 'salon_admin' && salonAdminForbiddenViews.includes(viewName)) {
             // salon_admin може бачити 'payouts'
             if(viewName !== 'payouts') {
                viewName = 'calendar';
             }
        }

        if (state.currentView === 'appointments' && viewName !== 'appointments') {
            state.editingAppointmentId = null;
            state.selectedClientForAppointment = null;
            state.selectedServiceForAppointment = null;
        }
        state.currentView = viewName;
        if(viewName !== 'clientDetail') { state.viewingClientId = null; }
        if(viewName !== 'masterDetail') {
            if (masterAdvancesUnsubscribe) {
                masterAdvancesUnsubscribe();
                masterAdvancesUnsubscribe = null;
            }
            state.viewingMasterId = null;
        }
        if(viewName !== 'staffDetail') {
            state.viewingStaffId = null;
            staffSubcollectionUnsubscribers.forEach(unsub => unsub());
            staffSubcollectionUnsubscribers = [];
        }
        if(viewName !== 'appointments') { state.appointmentsPage = 1; }

        const headerTitle = document.getElementById('header-title');
        if(headerTitle) {
            const viewTitles = { calendar: 'Календар', appointments: 'Запис', clients: 'Клієнти', services: 'Послуги та Категорії', masters: 'Майстри', shop: 'Магазин', salary: 'Звіт по Зарплаті', payouts: 'Видача ЗП', expenses: 'Загальні витрати', salonExpenses: 'Витрати в салоні', notepad: 'Блокнот', settings: 'Налаштування', clientDetail: 'Історія Клієнта', masterDetail: 'Картка Майстра', staff: 'Персонал', staffDetail: 'Картка Співробітника', auditLog: 'Журнал дій' };
            headerTitle.textContent = viewTitles[viewName] || 'Dashboard';
        }

        const navList = document.querySelector('#main-nav ul');
        if (!navList) return;
        navList.querySelectorAll('li').forEach(li => li.classList.remove('active'));
        const activeView = ['clientDetail', 'masterDetail', 'staffDetail'].includes(viewName) ? viewName.replace('Detail', 's') : viewName;
        const activeLi = navList.querySelector(`li[data-view="${activeView}"]`);
        if(activeLi) activeLi.classList.add('active');
        
        const contentWrapper = document.getElementById('content-wrapper');
        if(!contentWrapper) return;

        switch (viewName) {
            case 'calendar': renderCalendarView(contentWrapper); break;
            case 'appointments': renderAppointmentsView(contentWrapper); break;
            case 'clients': renderClientsView(contentWrapper); break;
            case 'clientDetail': renderClientDetailView(contentWrapper); break;
            case 'services': renderServicesView(contentWrapper); break;
            case 'masters': renderMastersView(contentWrapper); break;
            case 'masterDetail': renderMasterDetailView(contentWrapper); break;
            case 'salary': renderSalaryView(contentWrapper); break;
            case 'payouts': renderPayoutsView(contentWrapper); break; // [НОВА ФІШКА: Видача ЗП]
            case 'expenses': renderExpensesView(contentWrapper); break;
            case 'salonExpenses': renderSalonExpensesView(contentWrapper); break;
            case 'notepad': renderNotepadView(contentWrapper); break;
            case 'shop': renderShopView(contentWrapper); break;
            case 'settings': renderSettingsView(contentWrapper); break;
            case 'staff': renderStaffView(contentWrapper); break;
            case 'staffDetail': renderStaffDetailView(contentWrapper); break;
            case 'auditLog': renderAuditLogView(contentWrapper); break;
            default:
                contentWrapper.innerHTML = `<h2>Невідомий розділ</h2>`;
        }
    }
    // #endregion

    // [НОВА ФІШКА: Видача ЗП] - Весь новий блок логіки для видачі зарплати
    // #region Payouts View
    function renderPayoutsView(container) {
        const today = new Date();
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
        const todayStr = today.toISOString().split('T')[0];

        container.innerHTML = `
            <div class="content-card">
                <h2>Керування видачею зарплати</h2>
                <p>Цей інструмент дозволяє розрахувати та видати зарплату майстрам за довільний період, а також відстежувати баланс.</p>
                <form id="calculate-payouts-form">
                    <div class="form-row">
                        <div class="form-group" style="flex:1;"><label for="payout-start-date">Період З</label><input type="date" id="payout-start-date" value="${firstDayOfMonth}"></div>
                        <div class="form-group" style="flex:1;"><label for="payout-end-date">Період По</label><input type="date" id="payout-end-date" value="${todayStr}"></div>
                    </div>
                    <button type="submit" class="btn" style="width: 100%;">Розрахувати</button>
                </form>
            </div>
            <div id="payouts-container" style="margin-top: 2rem;"></div>
        `;
        document.getElementById('calculate-payouts-form').onsubmit = handleCalculatePayouts;
        document.getElementById('payouts-container').onclick = (e) => {
            const issueBtn = e.target.closest('.btn-issue-payout');
            const historyBtn = e.target.closest('.btn-payout-history');

            if (issueBtn) {
                handleIssuePayout(issueBtn.dataset);
            }
            if (historyBtn) {
                showPayoutHistory(historyBtn.dataset);
            }
        };
    }

    async function handleCalculatePayouts(event) {
        event.preventDefault();
        const container = document.getElementById('payouts-container');
        container.innerHTML = '<p>Розрахунок... Це може зайняти деякий час.</p>';
        const startDate = document.getElementById('payout-start-date').value;
        const endDate = document.getElementById('payout-end-date').value;
        
        if (!startDate || !endDate) {
            return showNotification("Будь ласка, оберіть період.", "error");
        }

        try {
            // Крок 1: Отримуємо нараховані суми, використовуючи існуючу хмарну функцію.
            // Примітка: Це не ідеально, тому що ми парсимо текст. В майбутньому краще створити
            // окрему функцію, яка повертатиме JSON.
            const generateReport = httpsCallable(functions, 'generateAndSendReport');
            const result = await generateReport({ startDate, endDate, salonId: 'all', isManualCalculation: true });
            const reportText = result.data.reportBody;
            const masterReportsText = reportText.split('--- ДЕТАЛІЗАЦІЯ ПО ЗАРПЛАТІ МАЙСТРІВ ---')[1].split('--- ДЕТАЛІЗАЦІЯ ПО ЗАРПЛАТІ ПЕРСОНАЛУ ---')[0];
            const masterReportParts = masterReportsText.split('----------------------------').filter(part => part.trim() !== '');

            const masterAccruals = {};
            masterReportParts.forEach(part => {
                if (!part.includes('Майстер:')) return;
                const nameMatch = part.match(/Майстер: (.*)/);
                const salaryMatch = part.match(/Нараховано ЗП .*?: (.*) zł/);
                const bonusMatch = part.match(/Нарахування .*?: \+(.*) zł/);

                if (nameMatch && (salaryMatch || bonusMatch)) {
                    const name = nameMatch[1].trim();
                    const salaryFromBase = salaryMatch ? parseFloat(salaryMatch[1]) : 0;
                    const bonus = bonusMatch ? parseFloat(bonusMatch[1]) : 0;
                    masterAccruals[name] = salaryFromBase + bonus;
                }
            });

            // Крок 2: Отримуємо дані про вже здійснені виплати для кожного майстра
            let html = '';
            const activeMasters = state.masters.filter(m => !m.isFrozen);

            for (const master of activeMasters) {
                const accruedTotal = masterAccruals[master.name] || 0;

                const payoutsQuery = query(
                    collection(db, 'masters', master.id, 'payouts'),
                    where("periodStart", "==", startDate),
                    where("periodEnd", "==", endDate)
                );
                const querySnapshot = await getDocs(payoutsQuery);
                let alreadyPaid = 0;
                querySnapshot.forEach(doc => {
                    alreadyPaid += doc.data().amount;
                });
                
                const balance = accruedTotal - alreadyPaid;

                html += `
                    <div class="payout-card">
                        <h3>
                            <span>${master.name}</span>
                            <button class="btn btn-edit btn-payout-history"
                                data-master-id="${master.id}"
                                data-master-name="${master.name}"
                                data-period-start="${startDate}"
                                data-period-end="${endDate}"
                            >Історія</button>
                        </h3>
                        <div class="payout-card-details">
                            <p><span>Нараховано за період:</span> <strong>${accruedTotal.toFixed(2)} zł</strong></p>
                            <p><span>Вже виплачено за цей період:</span> <strong style="color: var(--success-color);">${alreadyPaid.toFixed(2)} zł</strong></p>
                            <p><span>Залишок до виплати:</span> <strong class="balance-due">${balance.toFixed(2)} zł</strong></p>
                        </div>
                        <div class="payout-action-form">
                            <div class="form-group" style="flex: 2; margin-bottom: 0;">
                                <input type="number" class="payout-amount-input" placeholder="Сума до видачі" min="0.01" step="any" max="${balance.toFixed(2)}">
                            </div>
                            <button class="btn btn-issue-payout" style="flex: 1;"
                                data-master-id="${master.id}"
                                data-master-name="${master.name}"
                                data-period-start="${startDate}"
                                data-period-end="${endDate}"
                                data-balance="${balance.toFixed(2)}"
                            >Видати</button>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html || '<p>Немає даних для розрахунку по майстрах за обраний період.</p>';

        } catch (error) {
            console.error("Помилка розрахунку видач:", error);
            container.innerHTML = `<p style="color: var(--danger-color);">Помилка розрахунку: ${error.message}</p>`;
        }
    }

    async function handleIssuePayout(dataset) {
        const { masterId, masterName, periodStart, periodEnd, balance } = dataset;
        const cardElement = document.querySelector(`.btn-issue-payout[data-master-id="${masterId}"]`).closest('.payout-card');
        const amountInput = cardElement.querySelector('.payout-amount-input');
        const amount = parseFloat(amountInput.value);

        if (isNaN(amount) || amount <= 0) {
            return showNotification("Введіть коректну суму.", "error");
        }
        if (amount > parseFloat(balance) + 0.01) { // 0.01 для врахування похибки float
            return showNotification("Сума видачі не може перевищувати залишок.", "error");
        }

        const payoutData = {
            amount: amount,
            payoutDate: Timestamp.now(),
            periodStart: periodStart,
            periodEnd: periodEnd,
            authorEmail: state.user.email
        };

        // Використовуємо транзакцію для надійності, хоча в даному випадку це просто додавання
        // одного документа. Це стає критично, якщо потрібно оновлювати інші документи одночасно.
        const action = () => addDoc(collection(db, 'masters', masterId, 'payouts'), payoutData);
        try {
            await logAndExecute('Видача зарплати', { masterName: masterName, amount: amount, period: `${periodStart} - ${periodEnd}` }, action);
            showNotification(`Суму ${amount.toFixed(2)} zł видано майстру ${masterName}.`, 'success');
            // Оновлюємо дані, повторно викликавши розрахунок
            document.getElementById('calculate-payouts-form').dispatchEvent(new Event('submit', { cancelable: true }));
        } catch (e) {
            showNotification('Не вдалося провести виплату.', 'error');
            console.error(e);
        }
    }
    
    async function showPayoutHistory(dataset) {
        const { masterId, masterName, periodStart, periodEnd } = dataset;
        const modal = document.getElementById('payout-history-modal');
        const title = document.getElementById('payout-history-modal-title');
        const list = document.getElementById('payout-history-list');

        title.textContent = `Історія виплат: ${masterName}`;
        list.innerHTML = '<li>Завантаження...</li>';
        modal.style.display = 'flex';

        try {
            const historyQuery = query(
                collection(db, 'masters', masterId, 'payouts'),
                where("periodStart", "==", periodStart),
                where("periodEnd", "==", periodEnd),
                orderBy("payoutDate", "desc")
            );
            const querySnapshot = await getDocs(historyQuery);
            if (querySnapshot.empty) {
                list.innerHTML = '<li>За цей період виплат не було.</li>';
                return;
            }

            let historyHtml = '';
            querySnapshot.forEach(doc => {
                const data = doc.data();
                const date = data.payoutDate.toDate().toLocaleString('uk-UA');
                historyHtml += `
                    <li>
                        <div>
                            <strong>${data.amount.toFixed(2)} zł</strong><br>
                            <small>Автор: ${data.authorEmail}</small>
                        </div>
                        <small>${date}</small>
                    </li>
                `;
            });
            list.innerHTML = historyHtml;

        } catch (error) {
            list.innerHTML = '<li>Не вдалося завантажити історію.</li>';
            console.error("Error fetching payout history:", error);
        }
    }
    // #endregion

    // #region Staff Views
    function renderStaffView(container) {
        const salonOptions = state.salons.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        const staffListHtml = state.staff.map(person => {
            const salon = state.salons.find(s => s.id === person.salonId);
            return `
                <li class="staff-member-item ${person.isFrozen ? 'is-frozen' : ''}" data-id="${person.id}" style="cursor: pointer;">
                    <div>
                        <strong>${person.name} ${person.isFrozen ? '(Заморожений)' : ''}</strong><br>
                        <small>Ставка: ${person.fixedSalary || 0} zł (${salon ? salon.name : 'Салон не вказано'})</small>
                    </div>
                    <div class="actions">
                        <button class="btn btn-edit">Деталі</button>
                    </div>
                </li>`;
        }).join('');

        container.innerHTML = `
            <div class="content-card">
                <h2>Додати співробітника</h2>
                <form id="add-staff-form">
                    <div class="form-group">
                        <label for="staff-name">Ім'я</label>
                        <input type="text" id="staff-name" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex:1;">
                            <label for="staff-salary">Фіксована ставка (zł/міс)</label>
                            <input type="number" id="staff-salary" required min="0">
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label for="staff-salon">Салон</label>
                            <select id="staff-salon" required>
                                <option value="">Оберіть салон</option>
                                ${salonOptions}
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn">Додати</button>
                </form>
            </div>
            <div class="content-card" style="margin-top: 2rem;">
                <h2>Список персоналу</h2>
                <ul id="staff-list" class="item-list">
                    ${staffListHtml || '<li>Персонал ще не додано.</li>'}
                </ul>
            </div>
        `;

        document.getElementById('add-staff-form').onsubmit = handleAddStaff;
        document.getElementById('staff-list').onclick = (e) => {
            const item = e.target.closest('.staff-member-item');
            if (item) {
                state.viewingStaffId = item.dataset.id;
                renderView('staffDetail');
            }
        };
    }

    async function handleAddStaff(event) {
        event.preventDefault();
        const name = document.getElementById('staff-name').value.trim();
        const fixedSalary = parseFloat(document.getElementById('staff-salary').value);
        const salonId = document.getElementById('staff-salon').value;

        if (!name || !salonId || isNaN(fixedSalary)) {
            return showNotification("Будь ласка, заповніть усі поля коректно.", "error");
        }

        const action = () => addDoc(collection(db, 'staff'), {
            name,
            fixedSalary,
            salonId,
            isFrozen: false
        });

        try {
            await logAndExecute('Створено співробітника', { name, salary: fixedSalary }, action);
            event.target.reset();
        } catch (e) {
            showNotification("Не вдалося додати співробітника.", "error");
        }
    }

    function renderStaffDetailView(container) {
    const staffId = state.viewingStaffId;
    const person = state.staff.find(p => p.id === staffId);

    if (!person) {
        container.innerHTML = `<div class="content-card"><h2>Співробітника не знайдено</h2></div>`;
        return;
    }

    const salonOptions = state.salons.map(s => `<option value="${s.id}" ${person.salonId === s.id ? 'selected' : ''}>${s.name}</option>`).join('');

    container.innerHTML = `
        <div class="content-card">
            <button id="back-to-staff-list" class="btn" style="margin-bottom: 1rem;">&larr; Назад до списку</button>
            <h2>Редагувати: ${person.name}</h2>
            <form id="edit-staff-form">
                <input type="hidden" id="edit-staff-id" value="${person.id}">
                <div class="form-group">
                    <label for="edit-staff-name">Ім'я</label>
                    <input type="text" id="edit-staff-name" value="${person.name}" required>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex:1;">
                        <label for="edit-staff-salary">Фіксована ставка (zł/міс)</label>
                        <input type="number" id="edit-staff-salary" value="${person.fixedSalary || 0}" required min="0">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label for="edit-staff-salon">Салон</label>
                        <select id="edit-staff-salon" required>${salonOptions}</select>
                    </div>
                </div>
                <div class="form-group category-checkbox-group" style="max-height: none; padding: 0.5rem;">
                    <label><input type="checkbox" id="edit-staff-frozen" ${person.isFrozen ? 'checked' : ''}> Заморозити співробітника</label>
                </div>
                <button type="submit" class="btn">Зберегти зміни</button>
                <button type="button" id="delete-staff-btn" class="btn btn-delete" style="margin-left: 1rem;">Видалити</button>
            </form>
        </div>
        <div class="services-layout" style="margin-top: 2rem; grid-template-columns: 350px 1fr; ">
            <div class="content-card">
                <h3>Операції з зарплатою</h3>
                <form id="add-payment-form" class="form-group">
                    <div class="form-group">
                        <label for="payment-type">Тип</label>
                        <select id="payment-type">
                            <option value="payout">Нарахувати ЗП</option>
                            <option value="advance">Аванс</option>
                            <option value="bonus">Премія</option>
                        </select>
                    </div>
                    <div class="form-group" id="payout-period-group">
                        <label for="payout-period">Період (Місяць та Рік)</label>
                        <input type="month" id="payout-period">
                    </div>
                    <div class="form-group">
                        <label for="payment-amount">Сума (zł)</label>
                        <input type="number" id="payment-amount" required min="1">
                    </div>
                    <div class="form-group" id="payment-description-group" style="display:none;">
                        <label for="payment-description">Опис</label>
                        <textarea id="payment-description" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn">Провести операцію</button>
                </form>
            </div>
            <div id="history-container">
                <div class="content-card">
                    <h3>Історія нарахувань та виплат</h3>
                    <ul id="payouts-history-list" class="item-list"><li>Завантаження...</li></ul>
                </div>
            </div>
        </div>
    `;

    document.getElementById('back-to-staff-list').onclick = () => renderView('staff');
    document.getElementById('edit-staff-form').onsubmit = handleUpdateStaff;
    document.getElementById('delete-staff-btn').onclick = () => handleDeleteStaff(person.id, person.name);
    const paymentTypeSelect = document.getElementById('payment-type');
    const payoutPeriodGroup = document.getElementById('payout-period-group');
    const paymentDescriptionGroup = document.getElementById('payment-description-group');
    const paymentAmountInput = document.getElementById('payment-amount');

    paymentTypeSelect.onchange = (e) => {
        const isPayout = e.target.value === 'payout';
        payoutPeriodGroup.style.display = isPayout ? 'block' : 'none';
        paymentDescriptionGroup.style.display = isPayout ? 'none' : 'block';
        paymentAmountInput.readOnly = isPayout;
        if (isPayout) {
            paymentAmountInput.value = person.fixedSalary || 0;
        } else {
            paymentAmountInput.value = '';
        }
    };
    paymentTypeSelect.dispatchEvent(new Event('change'));

    document.getElementById('add-payment-form').onsubmit = handleAddStaffPayment;
    
    // Очищуємо старі слухачі перед тим, як встановити нові
    staffSubcollectionUnsubscribers.forEach(unsub => unsub());
    staffSubcollectionUnsubscribers = [];

    // Встановлюємо слухачі для ВСІХ типів історії
    setupSubcollectionListener('payouts', 'payouts-history-list', 'staffPayouts', renderPayoutHistoryList);
    setupSubcollectionListener('advances', 'payouts-history-list', 'viewingStaffAdvances', renderPayoutHistoryList);
    setupSubcollectionListener('bonuses', 'payouts-history-list', 'viewingStaffBonuses', renderPayoutHistoryList);
    
    // ВІДСУТНІЙ ЕЛЕМЕНТ: ОБРОБНИК КЛІКІВ ДЛЯ КНОПКИ ВИДАЛЕННЯ
    document.getElementById('payouts-history-list').onclick = (e) => {
        const deleteBtn = e.target.closest('.btn-delete-staff-payment');
        if (deleteBtn) {
            handleDeleteStaffPayment(deleteBtn.dataset);
        }
    };
}

    function setupSubcollectionListener(subcollectionName, listElementId, stateKey, renderer) {
    const staffId = state.viewingStaffId;
    if (!staffId) return;

    // Помилка була тут - ми видалили рядки, що все очищували

    const collectionRef = collection(db, 'staff', staffId, subcollectionName);
    const unsubscribe = onSnapshot(query(collectionRef, orderBy("date", "desc")), (snapshot) => {
        state[stateKey] = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        renderer(listElementId, state[stateKey]);
    });
    staffSubcollectionUnsubscribers.push(unsubscribe);
}

    function renderPayoutHistoryList(elementId, items) {
    const listEl = document.getElementById(elementId);
    if (!listEl) return;

    // Додаємо тип операції для кожної групи елементів, щоб знати, з якої колекції видаляти
    const allItems = [
        ...(state.staffPayouts || []).map(p => ({...p, itemType: 'payouts', displayType: 'Нарахування ЗП'})),
        ...(state.viewingStaffAdvances || []).map(a => ({...a, itemType: 'advances', displayType: 'Аванс', amount: -a.amount})),
        ...(state.viewingStaffBonuses || []).map(b => ({...b, itemType: 'bonuses', displayType: 'Премія'}))
    ].sort((a,b) => b.date.toDate() - a.date.toDate());
    
    if (allItems.length === 0) {
        listEl.innerHTML = `<li>Історія порожня.</li>`;
        return;
    }

    listEl.innerHTML = allItems.map(item => {
        // Формуємо кнопку видалення тільки для адміна
        const deleteButtonHtml = state.user.role === 'admin' 
            ? `<button class="btn btn-delete btn-delete-staff-payment" 
                        data-id="${item.id}" 
                        data-subcollection="${item.itemType}"
                        style="margin-left: 1rem;">
                        Видалити
                 </button>`
            : '';

        return `
            <li style="color: ${item.amount < 0 ? 'var(--danger-color)' : 'var(--text-color)'}">
                <div>
                    <strong>${item.displayType} ${item.period ? `(${item.period})` : ''}</strong><br>
                    <small>${item.date.toDate().toLocaleDateString('uk-UA')} ${item.description ? ` - ${item.description}` : ''}</small>
                </div>
                <div class="actions">
                    <strong>${item.amount.toFixed(2)} zł</strong>
                    ${deleteButtonHtml}
                </div>
            </li>`;
    }).join('');
}

    async function handleUpdateStaff(event) {
        event.preventDefault();
        const staffId = document.getElementById('edit-staff-id').value;
        const name = document.getElementById('edit-staff-name').value.trim();
        const fixedSalary = parseFloat(document.getElementById('edit-staff-salary').value);
        const salonId = document.getElementById('edit-staff-salon').value;
        const isFrozen = document.getElementById('edit-staff-frozen').checked;
        if (!name || !salonId || isNaN(fixedSalary)) {
            return showNotification("Будь ласка, заповніть усі поля коректно.", "error");
        }
        const action = () => updateDoc(doc(db, 'staff', staffId), { name, fixedSalary, salonId, isFrozen });
        try {
            await logAndExecute('Оновлено дані співробітника', { staffId, name }, action);
            showNotification('Дані оновлено!');
        } catch (e) {
            showNotification('Не вдалося оновити дані.', "error");
        }
    }

    async function handleDeleteStaffPayment(dataset) {
    console.log('Функцію handleDeleteStaffPayment викликано з даними:', dataset); // ДІАГНОСТИКА
    
    const { id, subcollection } = dataset;
    const staffId = state.viewingStaffId;

    console.log(`Намагаюся видалити документ за шляхом: staff/${staffId}/${subcollection}/${id}`); // ДІАГНОСТИКА

    if (!id || !subcollection || !staffId) {
        console.error('Помилка: не вистачає даних для видалення (id, subcollection або staffId)!');
        return;
    }

    showConfirmWithReasonModal(`Ви впевнені, що хочете видалити цей запис з історії? Цю дію не можна скасувати.`, async (reason) => {
        const action = () => deleteDoc(doc(db, 'staff', staffId, subcollection, id));
        const logDetails = { staffId, subcollection, docId: id };
        if (reason) logDetails.reason = reason;
        
        try {
            await logAndExecute('Видалено запис історії персоналу', logDetails, action);
            showNotification('Запис видалено.');
        } catch (e) {
            // Цей блок покаже нам помилку, якщо вона є
            console.error("!!! ПОМИЛКА ПРИ ВИДАЛЕННІ !!!", e); 
            showNotification('Не вдалося видалити запис. Помилка: ' + e.message, "error");
        }
    });
}

    async function handleAddStaffPayment(event) {
        event.preventDefault();
        const staffId = state.viewingStaffId;
        const person = state.staff.find(p => p.id === staffId);
        const type = document.getElementById('payment-type').value;
        const amount = parseFloat(document.getElementById('payment-amount').value);
        const description = document.getElementById('payment-description').value.trim();
        const period = document.getElementById('payout-period').value;

        if (isNaN(amount) || amount <= 0) return showNotification('Введіть коректну суму.', "error");

        let subcollectionName = `${type}s`;
        let data = { amount, date: Timestamp.now() };
        let logAction = '';
        let logDetails = { staffId, name: person.name, amount };

        if (type === 'payout') {
            if (!period) return showNotification('Будь ласка, оберіть період для нарахування ЗП.', 'error');
            data.period = period;
            logAction = 'Нараховано ЗП';
            logDetails.period = period;
        } else {
            if (description) data.description = description;
            logAction = type === 'bonus' ? 'Нараховано премію' : 'Видано аванс';
            if (description) logDetails.description = description;
        }
        
        const action = () => addDoc(collection(db, 'staff', staffId, subcollectionName), data);

        try {
            await logAndExecute(logAction, logDetails, action);
            event.target.reset();
            document.getElementById('payment-type').dispatchEvent(new Event('change'));
            showNotification('Операцію успішно проведено!');
        } catch (e) {
            showNotification(`Не вдалося провести операцію.`, "error");
        }
    }
    // #endregion

    // #region Audit Log View
    function renderAuditLogView(container) {
        const logEntriesHtml = state.auditLog.map(log => {
            const detailsArray = Object.entries(log.details || {}).map(([key, value]) => {
                let displayKey = key;
                switch(key) {
                    case 'name': displayKey = "Ім'я"; break;
                    case 'amount': displayKey = 'Сума'; break;
                    case 'serviceId': displayKey = 'ID Послуги'; break;
                    case 'masterId': displayKey = 'ID Майстра'; break;
                    case 'staffId': displayKey = 'ID Співробітника'; break;
                    case 'appointmentId': displayKey = 'ID Запису'; break;
                    case 'description': displayKey = 'Опис'; break;
                    case 'clientName': displayKey = 'Ім\'я клієнта'; break;
                    case 'reason': displayKey = 'Причина'; break;
                }
                return `${displayKey}: ${value}`;
            });

            return `
                <li>
                    <div style="flex-grow: 1; word-break: break-word;">
                        <strong>${log.action}</strong><br>
                        <small>${log.userEmail} - ${log.timestamp ? log.timestamp.toDate().toLocaleString('uk-UA') : 'Дата невідома'}</small>
                        ${detailsArray.length > 0 ? `<br><small style="color: var(--gray-text);">${detailsArray.join('; ')}</small>` : ''}
                    </div>
                </li>
            `;
        }).join('');

        container.innerHTML = `
            <div class="content-card">
                <h2>Журнал дій</h2>
                <p>Тут відображаються останні дії, виконані в системі.</p>
                <ul id="audit-log-list" class="item-list">
                    ${logEntriesHtml || '<li>Журнал дій порожній.</li>'}
                </ul>
            </div>
        `;
    }
    // #endregion

    // #region Daily Summary
    async function renderDailySummary() {
    const dateInput = document.getElementById('summary-date-picker');
    const salonInput = document.getElementById('summary-salon-filter');
    const advancesEl = document.getElementById('summary-advances');
    const salonExpensesEl = document.getElementById('summary-salon-expenses');
    const productSalesEl = document.getElementById('summary-product-sales');
    if (!dateInput || !salonInput || !advancesEl || !salonExpensesEl || !productSalesEl) return;

    const selectedDate = new Date(dateInput.value);
    const selectedSalonId = salonInput.value;
    const startOfDay = new Date(selectedDate);
    startOfDay.setHours(0, 0, 0, 0);
    
    const endOfDay = new Date(selectedDate);
    endOfDay.setHours(23, 59, 59, 999);
    
    let relevantAppointments = state.appointments.filter(app => {
        if (!app.dateTime) return false;
        const appointmentDate = app.dateTime.toDate();
        return appointmentDate >= startOfDay && appointmentDate <= endOfDay;
    });

    if (selectedSalonId !== 'all') {
        relevantAppointments = relevantAppointments.filter(app => app.salonId === selectedSalonId);
    }

    let total = 0, cash = 0, card = 0, blik = 0;
    let servicesWithPayment = 0;

    relevantAppointments.forEach(app => {
        if (app.payments && app.payments.length > 0) {
            servicesWithPayment++;
            app.payments.forEach(p => {
                if (p.type !== 'settlement') {
                    total += p.amount;
                    if(p.type === 'cash') cash += p.amount;
                    else if(p.type === 'card') card += p.amount;
                    else if(p.type === 'blik') blik += p.amount;
                }
            });
        }
    });
    
    let productSalesCash = 0, productSalesCard = 0, productSalesBlik = 0;
    let filteredProductSales = state.productSales.filter(s => {
        if (!s.timestamp && !s.date) return false;
        const saleDate = (s.timestamp || s.date).toDate();
        return saleDate >= startOfDay && saleDate <= endOfDay;
    });
    if (selectedSalonId !== 'all') {
        filteredProductSales = filteredProductSales.filter(s => s.salonId === selectedSalonId);
    }
    filteredProductSales.forEach(sale => {
        if (sale.paymentType === 'cash') productSalesCash += sale.amount;
        else if (sale.paymentType === 'card') productSalesCard += sale.amount;
        else if (sale.paymentType === 'blik') productSalesBlik += sale.amount;
    });

    const totalProductSales = productSalesCash + productSalesCard + productSalesBlik;
    total += totalProductSales;
    cash += productSalesCash;
    card += productSalesCard;
    blik += productSalesBlik;

    // --- НОВА ЛОГІКА ДЛЯ ЗАВАНТАЖЕННЯ АВАНСІВ ---
    let totalAdvances = 0;
    try {
        const advancePromises = [];
        const mastersForSalon = state.masters.filter(m => selectedSalonId === 'all' || (m.salonIds && m.salonIds.includes(selectedSalonId)));
        const staffForSalon = state.staff.filter(p => selectedSalonId === 'all' || p.salonId === selectedSalonId);

        mastersForSalon.forEach(master => {
            const q = query(collection(db, 'masters', master.id, 'advances'), where('date', '>=', startOfDay), where('date', '<=', endOfDay));
            advancePromises.push(getDocs(q));
        });
        staffForSalon.forEach(person => {
            const q = query(collection(db, 'staff', person.id, 'advances'), where('date', '>=', startOfDay), where('date', '<=', endOfDay));
            advancePromises.push(getDocs(q));
        });

        const querySnapshots = await Promise.all(advancePromises);
        querySnapshots.forEach(snap => {
            snap.forEach(doc => {
                totalAdvances += doc.data().amount;
            });
        });
    } catch (e) {
        console.error("Помилка завантаження авансів для підсумку:", e);
    }
    // --- КІНЕЦЬ НОВОЇ ЛОГІКИ ---

    let totalSalonExpenses = 0;
    let filteredSalonExpenses = state.salonExpenses.filter(e => {
        if (!e.timestamp && !e.date) return false;
        const expenseDate = (e.timestamp || e.date).toDate();
        return expenseDate >= startOfDay && expenseDate <= endOfDay;
    });
    if (selectedSalonId !== 'all') {
        filteredSalonExpenses = filteredSalonExpenses.filter(e => e.salonId === selectedSalonId);
    }
    filteredSalonExpenses.forEach(expense => {
        totalSalonExpenses += expense.amount;
    });

    document.getElementById('summary-total').textContent = `${total.toFixed(0)} zł`;
    document.getElementById('summary-cash').textContent = `${cash.toFixed(0)} zł`;
    document.getElementById('summary-card').textContent = `${card.toFixed(0)} zł`;
    document.getElementById('summary-blik').textContent = `${blik.toFixed(0)} zł`;
    advancesEl.textContent = `-${totalAdvances.toFixed(0)} zł`;
    salonExpensesEl.textContent = `-${totalSalonExpenses.toFixed(0)} zł`;
    productSalesEl.textContent = `${totalProductSales.toFixed(0)} zł`;
    document.getElementById('summary-services-count').textContent = servicesWithPayment;
}
    // #endregion

    // #region Calendar View & Modals
    function renderCalendarView(container) {
        // [ДОДАЙТЕ ЦЕЙ БЛОК НА ПОЧАТКУ ФУНКЦІЇ]
        const userRole = state.user.role;
        const userSalonId = state.user.salonId;
        const isSalonAdmin = userRole === 'salon_admin';
        // [КІНЕЦЬ БЛОКУ]
        const salonOptions = state.salons.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        container.innerHTML = `
            <div class="content-card">
                <div id="calendar-container">
                    <div class="form-row">
                        <div class="form-group" style="flex:1;">
                            <label for="calendar-master-filter">Майстер:</label>
                            <select id="calendar-master-filter"></select>
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label for="calendar-salon-filter">Салон:</label>
                            <select id="calendar-salon-filter" ${isSalonAdmin ? 'disabled' : ''}>
                                <option value="all">Всі салони</option>
                                ${salonOptions}
                            </select>
                        </div>
                    </div>
                    <div id="calendar"></div>
                </div>
            </div>
            <div class="content-card">
                <h2>Підсумок за день</h2>
                <div class="form-row" style="margin-bottom: 2rem;">
                    <div class="form-group" style="flex:1;">
                        <label for="summary-date-picker">Оберіть дату</label>
                        <input type="date" id="summary-date-picker">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label for="summary-salon-filter">Оберіть салон</label>
                        <select id="summary-salon-filter" ${isSalonAdmin ? 'disabled' : ''}>
                            <option value="all">Всі салони</option>
                            ${salonOptions}
                        </select>
                    </div>
                </div>
                <div class="summary-grid">
                    <div class="summary-card"><div class="value" id="summary-total">0 zł</div><div class="label">Загальний дохід</div></div>
                    <div class="summary-card"><div class="value" id="summary-cash">0 zł</div><div class="label">💵 Готівкою</div></div>
                    <div class="summary-card"><div class="value" id="summary-card">0 zł</div><div class="label">💳 Карткою</div></div>
                    <div class="summary-card"><div class="value" id="summary-blik">0 zł</div><div class="label">📱 Blik</div></div>
                    <div class="summary-card"><div class="value" id="summary-product-sales">0 zł</div><div class="label">🛍️ Продаж товарів</div></div>
                    <div class="summary-card"><div class="value" id="summary-advances">0 zł</div><div class="label">💸 Видано авансів</div></div>
                    <div class="summary-card"><div class="value" id="summary-salon-expenses">0 zł</div><div class="label">Витрати салону</div></div>
                    <div class="summary-card"><div class="value" id="summary-services-count">0</div><div class="label">Кількість оплат</div></div>
                </div>
            </div>`;
        
        const calendarEl = document.getElementById('calendar');
        const masterFilter = document.getElementById('calendar-master-filter');
        const salonFilter = document.getElementById('calendar-salon-filter');
        
        const activeMasters = state.masters.filter(m => !m.isFrozen);
        masterFilter.innerHTML = '<option value="all">Всі майстри</option>' + activeMasters.map(m => `<option value="${m.id}" ${state.calendarSelectedMasterId === m.id ? 'selected' : ''}>${m.name}</option>`).join('');
        salonFilter.value = state.calendarSelectedSalonId;
        if (isSalonAdmin) {
            salonFilter.value = userSalonId;
            state.calendarSelectedSalonId = userSalonId;
            document.getElementById('summary-salon-filter').value = userSalonId;
        }
        if (!calendarEl || !masterFilter || !salonFilter) return;

        const colorPalette = ['#3788d8', '#e25141', '#4caf50', '#ff9800', '#9c27b0', '#795548', '#607d8b'];
        const calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'uk', initialView: 'timeGridWeek',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'timeGridWeek,timeGridDay' },
            editable: false, selectable: true, nowIndicator: true,
            events: function(fetchInfo, successCallback, failureCallback) {
                let filteredAppointments = state.appointments;
                if (state.calendarSelectedMasterId !== 'all') {
                    filteredAppointments = filteredAppointments.filter(app => app.masterId === state.calendarSelectedMasterId);
                }
                if (state.calendarSelectedSalonId !== 'all') {
                    filteredAppointments = filteredAppointments.filter(app => app.salonId === state.calendarSelectedSalonId);
                }
                const events = filteredAppointments.map(app => {
                    const masterIndex = state.masters.findIndex(m => m.id === app.masterId);
                    const endTime = new Date(app.dateTime.toDate().getTime() + (app.duration || 60) * 60000);
                    let backgroundColor = colorPalette[masterIndex % colorPalette.length];
                    if (app.isInternal) { backgroundColor = 'var(--warning-color)'; } 
                    else if (app.status === 'completed') { backgroundColor = 'var(--success-color)'; } 
                    else if (app.status === 'partially_paid') { backgroundColor = 'var(--warning-color)'; }
                    return { id: app.id, title: app.clientName, start: app.dateTime.toDate(), end: endTime, resourceId: app.masterId, backgroundColor, borderColor: backgroundColor, extendedProps: { appointment: app } };
                });
                successCallback(events);
            },
            eventContent: function(arg) {
                const appointment = arg.event.extendedProps.appointment;
                const service = state.services.find(s => s.id === appointment.serviceId);
                const salon = state.salons.find(s => s.id === appointment.salonId);
                const html = `<div class="fc-event-main-frame"><div class="fc-event-title">${appointment.clientName} ${appointment.isInternal ? ' (для своїх)' : ''}</div><div class="fc-event-service">${service?.name || ''}</div><div class="fc-event-service" style="opacity: 0.7;"><strong>${salon?.name || 'Не вказано'}</strong></div></div>`;
                return { html: html };
            },
            eventDidMount: function(info) {
                if (info.event.start < new Date() && info.event.extendedProps.appointment.status !== 'completed') {
                    info.el.style.opacity = '0.6';
                }
            },
            eventClick: function(info) {
                const appointment = info.event.extendedProps.appointment;
                if (appointment) {
                    showActionModal(appointment);
                }
            },
            select: function(selectionInfo) {
                state.preselectedAppointment = { dateTime: selectionInfo.start };
                if (state.calendarSelectedMasterId !== 'all') { state.preselectedAppointment.masterId = state.calendarSelectedMasterId; }
                renderView('appointments');
            }
        });
        calendar.render();
        masterFilter.onchange = (e) => { state.calendarSelectedMasterId = e.target.value; renderView('calendar'); };
        salonFilter.onchange = (e) => { state.calendarSelectedSalonId = e.target.value; renderView('calendar'); };
        const summaryDatePicker = document.getElementById('summary-date-picker');
        const summarySalonFilter = document.getElementById('summary-salon-filter');
        summaryDatePicker.valueAsDate = new Date(); 
        summaryDatePicker.onchange = () => renderDailySummary();
        summarySalonFilter.onchange = () => renderDailySummary();
        renderDailySummary();
    }

    function openPaymentModal(appointment) {
        const totalPrice = appointment.finalPrice || 0;
        const totalPaid = appointment.totalPaid || 0;
        const remaining = totalPrice - totalPaid;
        document.getElementById('payment-appointment-id').value = appointment.id;
        document.getElementById('payment-total-price').textContent = `${totalPrice.toFixed(0)} zł`;
        document.getElementById('payment-total-paid').textContent = `${totalPaid.toFixed(0)} zł`;
        document.getElementById('payment-remaining').textContent = `${remaining.toFixed(0)} zł`;
        const amountInput = document.getElementById('payment-amount');
        amountInput.value = remaining > 0 ? remaining.toFixed(2) : '0.00';
        amountInput.max = remaining.toFixed(2);
        document.getElementById('payment-modal').style.display = 'flex';
    }

    function showActionModal(appointment) {
        const modal = document.getElementById('appointment-action-modal');
        const detailsEl = document.getElementById('action-modal-details');
        const buttonsEl = document.getElementById('action-modal-buttons');
        const service = state.services.find(s => s.id === appointment.serviceId);
        const master = state.masters.find(m => m.id === appointment.masterId);
        const salon = state.salons.find(s => s.id === appointment.salonId);
        
        let statusText = 'Очікує';
        if (appointment.status === 'completed') {
            statusText = appointment.isInternal ? 'Взаєморозрахунок проведено' : 'Завершено та оплачено';
        } else if (appointment.status === 'partially_paid') {
            const remaining = (appointment.finalPrice || 0) - (appointment.totalPaid || 0);
            statusText = `Частково оплачено (ще ${remaining.toFixed(0)} zł)`;
        }
        
        let clientInfoHtml = `<p><strong>Клієнт:</strong> ${appointment.clientName}</p>`;
        if(appointment.isInternal){
            clientInfoHtml = `<p><strong>Клієнт-майстер:</strong> ${appointment.clientName}</p>`;
        }

        detailsEl.innerHTML = `
            ${clientInfoHtml}
            <p><strong>Послуга:</strong> ${service?.name || 'Невідома послуга'}</p>
            <p><strong>Майстер:</strong> ${master?.name || 'Невідомий майстер'}</p>
            <p><strong>Салон:</strong> ${salon?.name || 'Не вказано'}</p>
            <p><strong>Дата:</strong> ${appointment.dateTime.toDate().toLocaleString('uk-UA')}</p>
            <p><strong>Сума:</strong> ${appointment.finalPrice.toFixed(0)} zł</p>
            <p><strong>Статус:</strong> ${statusText}</p>
        `;
        
        if (appointment.additionalCharge && appointment.additionalCharge.amount > 0) {
            detailsEl.innerHTML += `<p><strong>Додаткова плата:</strong> ${appointment.additionalCharge.amount.toFixed(0)} zł (${appointment.additionalCharge.description || 'без опису'})</p>`;
        }

        if (appointment.payments && appointment.payments.length > 0) {
            const paymentTypes = { cash: 'Готівка', card: 'Картка', blik: 'Blik', settlement: 'Взаєморозрахунок' };
            let paymentsHtml = '<hr style="margin: 1rem 0;"><p><strong>Історія оплат:</strong></p><ul style="padding-left: 20px; margin: 0;">';
            appointment.payments.forEach(p => {
                const paymentTypeStr = paymentTypes[p.type] || p.type;
                paymentsHtml += `<li>${p.amount.toFixed(0)} zł (${paymentTypeStr})</li>`;
            });
            paymentsHtml += '</ul>';
            detailsEl.innerHTML += paymentsHtml;
        }
        
        let buttonsHtml = '';
        const remainingToPay = (appointment.finalPrice || 0) - (appointment.totalPaid || 0);
        
        if (appointment.isInternal && appointment.status !== 'completed') {
            buttonsHtml += `<button class="btn btn-complete-payment" data-action="settle">Провести по взаєморозрахунку</button>`;
        } else if (!appointment.isInternal && appointment.status !== 'completed' && remainingToPay > 0.001) {
            buttonsHtml += `<button class="btn btn-complete-payment" data-action="pay">Внести / Додати оплату</button>`;
        }

        if (appointment.payments && appointment.payments.length > 0) {
             buttonsHtml += `<button class="btn btn-edit" data-action="edit-payments">✏️ Редагувати оплати</button>`;
        }

        buttonsHtml += `<button class="btn btn-edit" data-action="edit">Редагувати / Перенести</button>`;
        buttonsHtml += `<button class="btn btn-delete" data-action="cancel">Скасувати запис</button>`;
        buttonsEl.innerHTML = buttonsHtml;

        buttonsEl.onclick = function(event) {
            const button = event.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;
            modal.style.display = 'none';
            if (action === 'pay') { openPaymentModal(appointment); } 
            else if (action === 'settle') { handleSettleInternalService(appointment); } 
            else if (action === 'edit') { handleEditAppointment(appointment.id); } 
            else if (action === 'cancel') { handleCancelAppointment(appointment.id, appointment.clientName); } 
            else if (action === 'edit-payments') { showEditPaymentsModal(appointment); }
        };

        modal.querySelector('.close-btn').onclick = () => modal.style.display = 'none';
        modal.style.display = 'flex';
    }

    async function handleSettleInternalService(appointment) {
        const amount = appointment.finalPrice * 0.5;
        const newPayment = {
            amount: amount,
            type: 'settlement',
            date: Timestamp.now(),
            receivingMasterId: appointment.clientId 
        };
        const action = () => updateDoc(doc(db, 'appointments', appointment.id), {
            payments: arrayUnion(newPayment),
            totalPaid: increment(amount),
            status: 'completed'
        });
        try {
            await logAndExecute('Проведено взаєморозрахунок', { appointmentId: appointment.id, clientName: appointment.clientName, amount }, action);
            showNotification('Взаєморозрахунок успішно проведено!');
        } catch (e) {
            showNotification('Не вдалося провести взаєморозрахунок.', 'error');
            console.error(e);
        }
    }

    function showEditPaymentsModal(appointment) {
        const modal = document.getElementById('edit-payments-modal');
        const listEl = document.getElementById('edit-payments-list');
        document.getElementById('edit-payments-appointment-id').value = appointment.id;
        listEl.innerHTML = '';
        if (!appointment.payments || appointment.payments.length === 0) {
            listEl.innerHTML = '<li>Оплат ще не було.</li>';
        } else {
            appointment.payments.forEach((payment, index) => {
                const li = document.createElement('li');
                li.dataset.index = index;
                const isSettlement = payment.type === 'settlement';
                li.innerHTML = `
                    <div style="flex-grow: 1;"><strong>${payment.amount.toFixed(2)} zł</strong></div>
                    <div style="flex-grow: 1.5;">
                        <select class="payment-type-selector" ${isSettlement ? 'disabled' : ''}>
                            <option value="cash" ${payment.type === 'cash' ? 'selected' : ''}>Готівка</option>
                            <option value="card" ${payment.type === 'card' ? 'selected' : ''}>Картка</option>
                            <option value="blik" ${payment.type === 'blik' ? 'selected' : ''}>Blik</option>
                            ${isSettlement ? `<option value="settlement" selected>Взаєморозрахунок</option>` : ''}
                        </select>
                    </div>
                    <div class="actions">
                        <button type="button" class="btn btn-delete btn-delete-single-payment">Видалити</button>
                    </div>
                `;
                li.querySelector('.btn-delete-single-payment').onclick = () => {
                    showConfirmModal('Ви впевнені, що хочете видалити цей платіж?', () => {
                        li.remove();
                    });
                };
                listEl.appendChild(li);
            });
        }
        modal.style.display = 'flex';
    }

    async function handleUpdatePayments(event) {
        event.preventDefault();
        const appointmentId = document.getElementById('edit-payments-appointment-id').value;
        const appointment = state.appointments.find(a => a.id === appointmentId);
        if (!appointment) return showNotification('Помилка: запис не знайдено.', 'error');
        
        const newPayments = [];
        let newTotalPaid = 0;
        document.querySelectorAll('#edit-payments-list li').forEach(li => {
            const originalPayment = appointment.payments[li.dataset.index];
            const newType = li.querySelector('.payment-type-selector').value;
            newPayments.push({ ...originalPayment, type: newType });
            newTotalPaid += originalPayment.amount;
        });
        
        const finalPrice = appointment.finalPrice || 0;
        let newStatus = (newTotalPaid > 0) ? 'partially_paid' : 'upcoming';
        
        if (appointment.isInternal) {
            if (newTotalPaid > 0) newStatus = 'completed';
        } else {
            if (newTotalPaid >= finalPrice - 0.001) newStatus = 'completed';
        }
        
        const action = () => updateDoc(doc(db, 'appointments', appointmentId), { payments: newPayments, totalPaid: newTotalPaid, status: newStatus });
        
        try {
            await logAndExecute('Оновлено оплати запису', { appointmentId, clientName: appointment.clientName }, action);
            showNotification('Оплати успішно оновлено!');
            document.getElementById('edit-payments-modal').style.display = 'none';
        } catch (e) {
            showNotification("Не вдалося оновити оплати.", "error");
        }
    }

    async function handleCancelAppointment(appointmentId, clientName) {
        showConfirmWithReasonModal('Ви впевнені, що хочете скасувати цей запис?', async (reason) => {
            const action = () => deleteDoc(doc(db, 'appointments', appointmentId));
            const logDetails = { appointmentId, clientName };
            if (reason) logDetails.reason = reason;
            try {
                await logAndExecute('Скасовано запис', logDetails, action);
                document.getElementById('appointment-action-modal').style.display = 'none';
                showNotification('Запис успішно скасовано.');
            } catch (e) {
                showNotification('Не вдалося скасувати запис.', "error");
            }
        });
    }

    function handleEditAppointment(appointmentId) {
        state.editingAppointmentId = appointmentId;
        renderView('appointments');
    }
    // #endregion
    
    // #region Clients Views
    function renderClientsView(container) {
        container.innerHTML = `<div class="content-card"><h2>База клієнтів</h2><div class="form-group"><input type="text" id="client-search" placeholder="Пошук за іменем або телефоном..."></div><ul id="clients-list" class="item-list"></ul></div>`;
        const searchInput = document.getElementById('client-search');
        searchInput.oninput = () => displayClients(searchInput.value);
        displayClients();
    }

    function displayClients(searchTerm = '') {
        const listEl = document.getElementById('clients-list');
        if (!listEl) return;
        const normalizedSearch = searchTerm.toLowerCase().trim();
        const filteredClients = searchTerm ? state.clients.filter(client => client.name.toLowerCase().includes(normalizedSearch) || (client.phone && client.phone.includes(normalizedSearch))) : state.clients;
        
        listEl.innerHTML = filteredClients.length > 0 ? '' : '<li>Клієнтів не знайдено.</li>';
        
        filteredClients.forEach(client => {
            const li = document.createElement('li');
            li.innerHTML = `
                <div><strong>${client.name}</strong><br><small>${client.phone || 'Телефон не вказано'}</small></div>
                <div class="actions">
                    <button class="btn btn-complete-payment btn-book-appointment" data-id="${client.id}" data-name="${client.name}" data-phone="${client.phone || ''}">Записати</button>
                    <button class="btn-edit btn-view-history" data-id="${client.id}">Історія</button>
                </div>`;
            listEl.appendChild(li);
        });
        
        listEl.onclick = (e) => {
            if(e.target.classList.contains('btn-view-history')) {
                state.viewingClientId = e.target.dataset.id;
                renderView('clientDetail');
            }
            if(e.target.classList.contains('btn-book-appointment')) {
                const clientData = e.target.dataset;
                state.selectedClientForAppointment = { id: clientData.id, name: clientData.name, phone: clientData.phone };
                renderView('appointments');
            }
        };
    }

    function renderClientDetailView(container) {
        const client = state.clients.find(c => c.id === state.viewingClientId);
        if(!client) {
            container.innerHTML = `<div class="content-card"><h2>Клієнта не знайдено</h2><p><button id="back-to-clients-btn" class="btn">Назад до списку</button></p></div>`;
            document.getElementById('back-to-clients-btn').onclick = () => renderView('clients');
            return;
        }

        const clientAppointments = state.appointments.filter(app => app.clientId === client.id).sort((a,b) => b.dateTime.toDate() - a.dateTime.toDate());
        const totalVisits = clientAppointments.length;
        const totalSpent = clientAppointments.reduce((sum, app) => sum + (app.totalPaid || 0), 0);
        const firstVisit = totalVisits > 0 ? clientAppointments[clientAppointments.length - 1].dateTime.toDate().toLocaleDateString('uk-UA') : 'Немає візитів';
        
        let historyHtml = clientAppointments.map(app => {
            const service = state.services.find(s => s.id === app.serviceId);
            const master = state.masters.find(m => m.id === app.masterId);
            const salon = state.salons.find(s => s.id === app.salonId); 
            const date = app.dateTime.toDate().toLocaleString('uk-UA', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            
            let statusBadge;
            if (app.status === 'completed') { statusBadge = `<span class="status-badge status-completed">Оплачено</span>`; } 
            else if (app.status === 'partially_paid') {
                const remaining = (app.finalPrice || 0) - (app.totalPaid || 0);
                statusBadge = `<span class="status-badge status-partially-paid">Частково (ще ${remaining.toFixed(0)} zł)</span>`;
            } else { statusBadge = `<span class="status-badge status-upcoming">Очікує</span>`; }

            return `<tr><td>${date}</td><td>${service?.name || 'Н/Д'}</td><td>${master?.name || 'Н/Д'}</td><td>${salon?.name || 'Н/Д'}</td><td>${app.finalPrice.toFixed(0)} zł</td><td>${statusBadge}</td></tr>`;
        }).join('');

        container.innerHTML = `
            <div class="content-card">
                <button id="back-to-clients-btn" class="btn" style="margin-bottom: 2rem;">&larr; Назад до списку клієнтів</button>
                <h2>${client.name}</h2>
                <p><strong>Телефон:</strong> ${client.phone || 'не вказано'}</p>
                <div class="stats-grid">
                    <div class="stat-card"><div class="value">${totalVisits}</div><div class="label">Всього візитів</div></div>
                    <div class="stat-card"><div class="value">${totalSpent.toFixed(0)} zł</div><div class="label">Всього витрачено</div></div>
                    <div class="stat-card"><div class="value">${firstVisit}</div><div class="label">Перший візит</div></div>
                </div>
            </div>
            <div class="content-card">
                <h3>Історія відвідувань</h3>
                <table>
                    <thead><tr><th>Дата</th><th>Послуга</th><th>Майстер</th><th>Салон</th><th>Сума</th><th>Статус</th></tr></thead>
                    <tbody>${historyHtml.length > 0 ? historyHtml : `<tr><td colspan="6" style="text-align:center;">Історія відвідувань порожня.</td></tr>`}</tbody>
                </table>
            </div>`;

        document.getElementById('back-to-clients-btn').onclick = () => renderView('clients');
    }
    // #endregion

    // #region Appointments View
    function renderAppointmentsView(container) {
        const isEditMode = !!state.editingAppointmentId;
        let appointmentToEdit = null;
        if (isEditMode) {
            appointmentToEdit = state.appointments.find(a => a.id === state.editingAppointmentId);
        }
        
        const salonOptions = state.salons.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        container.innerHTML = `
            <div class="content-card">
                <h2 id="appointment-form-title">${isEditMode ? 'Редагувати запис' : 'Новий запис'}</h2>
                <form id="appointment-form">
                     <div class="form-group category-checkbox-group" style="max-height: none; padding: 0.5rem; margin-bottom: 1rem;">
                        <label><input type="checkbox" id="internal-service-checkbox"> Внутрішня послуга (для майстра)</label>
                    </div>
                    <div id="regular-client-fields">
                        <div class="form-group client-search-container">
                            <label for="client-search-input">Пошук / Ім'я клієнта</label>
                            <input type="text" id="client-search-input" autocomplete="off" required>
                            <div id="client-search-results" style="display: none;"></div>
                        </div>
                        <div class="form-group" id="client-phone-group" style="display: none;">
                            <label for="client-phone-input">Телефон нового клієнта</label>
                            <input type="tel" id="client-phone-input">
                        </div>
                    </div>
                    <div id="master-client-fields" style="display: none;">
                         <div class="form-group">
                            <label for="master-as-client-select">Клієнт-майстер</label>
                            <select id="master-as-client-select" class="form-group"></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="appointment-datetime">Дата і час</label>
                        <input type="datetime-local" id="appointment-datetime" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex:1;"><label for="appointment-category">Категорія послуг</label><select id="appointment-category" required></select></div>
                        <div class="form-group service-search-container" style="flex:1;"><label for="appointment-service-search">Послуга</label><input type="text" id="appointment-service-search" placeholder="Почніть вводити назву..." autocomplete="off" required><div id="service-search-results" style="display: none;"></div></div>
                    </div>
                    <div class="form-group"><label for="appointment-master">Майстер</label><select id="appointment-master" required></select></div>
                    <div class="form-group"><label for="appointment-salon">Салон</label><select id="appointment-salon" required><option value="">Оберіть салон</option>${salonOptions}</select></div>
                    <div class="form-row">
                        <div class="form-group" style="flex:2;"><label for="manual-discount-value">Додаткова знижка</label><input type="number" id="manual-discount-value" placeholder="0" min="0"></div>
                        <div class="form-group" style="flex:1;"><label for="manual-discount-type">Тип</label><select id="manual-discount-type"><option value="percent">%</option><option value="fixed">zł</option></select></div>
                    </div>
                     <div class="form-row">
                        <div class="form-group" style="flex:1;"><label for="additional-charge-amount">Додаткова плата (zł)</label><input type="number" id="additional-charge-amount" placeholder="0" min="0"></div>
                        <div class="form-group" style="flex:2;"><label for="additional-charge-description">Опис дод. плати</label><input type="text" id="additional-charge-description" placeholder="напр. Миття голови"></div>
                    </div>
                    <div id="final-price-display">Сума до оплати: 0 zł</div>
                    <button type="submit" id="appointment-submit-btn" class="btn" style="margin-top: 1rem;">${isEditMode ? 'Зберегти зміни' : 'Створити запис'}</button>
                    ${isEditMode ? `<button type="button" id="appointment-cancel-edit-btn" class="btn" style="margin-top: 0.5rem; background-color: var(--gray-text);">Скасувати редагування</button>` : ''}
                </form>
            </div>
            ${!isEditMode ? `
            <div class="content-card" style="margin-top: 2rem;">
                <h2>Незавершені записи</h2>
                <div class="form-group">
                    <label for="appointments-date-filter">Оберіть дату</label>
                    <input type="date" id="appointments-date-filter">
                </div>
                <ul id="daily-appointments-list" class="item-list"></ul>
                <div id="pagination-controls" style="text-align: center; margin-top: 1rem;"></div>
            </div>` : ''}
        `;
        setupAppointmentsLogic();

        if (isEditMode && appointmentToEdit) {
            const d = new Date(appointmentToEdit.dateTime.toDate().getTime() - (appointmentToEdit.dateTime.toDate().getTimezoneOffset() * 60000));
            document.getElementById('appointment-datetime').value = d.toISOString().slice(0, 16);
            document.getElementById('manual-discount-value').value = appointmentToEdit.manualDiscount?.value || 0;
            document.getElementById('manual-discount-type').value = appointmentToEdit.manualDiscount?.type || 'percent';
            if (appointmentToEdit.additionalCharge) {
                document.getElementById('additional-charge-amount').value = appointmentToEdit.additionalCharge.amount || 0;
                document.getElementById('additional-charge-description').value = appointmentToEdit.additionalCharge.description || '';
            }
            const internalCheckbox = document.getElementById('internal-service-checkbox');
            internalCheckbox.checked = appointmentToEdit.isInternal || false;
            internalCheckbox.dispatchEvent(new Event('change'));
            if(appointmentToEdit.isInternal) {
                document.getElementById('master-as-client-select').value = appointmentToEdit.clientId;
            } else {
                const client = state.clients.find(c => c.id === appointmentToEdit.clientId);
                document.getElementById('client-search-input').value = client?.name || appointmentToEdit.clientName;
                document.getElementById('client-phone-input').value = client?.phone || '';
                document.getElementById('client-phone-group').style.display = 'block';
            }
            const service = state.services.find(s => s.id === appointmentToEdit.serviceId);
            if (service) {
                state.selectedServiceForAppointment = service;
                document.getElementById('appointment-service-search').value = service.name;
                const categorySelect = document.getElementById('appointment-category');
                categorySelect.value = service.categoryId;
                categorySelect.dispatchEvent(new Event('change'));
                setTimeout(() => {
                    document.getElementById('appointment-master').value = appointmentToEdit.masterId;
                    if (appointmentToEdit.salonId) {
                        document.getElementById('appointment-salon').value = appointmentToEdit.salonId;
                    }
                    updateFinalPrice();
                }, 100);
            }
        } else if (!isEditMode && state.selectedClientForAppointment) {
            const clientSearchInput = document.getElementById('client-search-input');
            const clientPhoneInput = document.getElementById('client-phone-input');
            const clientPhoneGroup = document.getElementById('client-phone-group');
            clientSearchInput.value = state.selectedClientForAppointment.name;
            clientSearchInput.disabled = true;
            clientPhoneInput.value = state.selectedClientForAppointment.phone || '';
            clientPhoneGroup.style.display = 'block';
        } else if (state.preselectedAppointment) {
            const { dateTime, masterId } = state.preselectedAppointment;
            const d = new Date(dateTime.getTime() - (dateTime.getTimezoneOffset() * 60000));
            document.getElementById('appointment-datetime').value = d.toISOString().slice(0, 16);
            if (masterId) {
                const master = state.masters.find(m => m.id === masterId);
                const firstCategoryId = master?.categoryIds?.[0];
                if (firstCategoryId) {
                    const categorySelect = document.getElementById('appointment-category');
                    categorySelect.value = firstCategoryId;
                    categorySelect.dispatchEvent(new Event('change'));
                    setTimeout(() => {
                        document.getElementById('appointment-master').value = masterId;
                    }, 100);
                }
            }
            state.preselectedAppointment = null;
        } else {
            const dateFilter = document.getElementById('appointments-date-filter');
            dateFilter.valueAsDate = state.appointmentsListDate;
            dateFilter.onchange = () => {
                state.appointmentsListDate = dateFilter.valueAsDate;
                state.appointmentsPage = 1;
                renderDailyAppointmentsList();
            };
            renderDailyAppointmentsList();
        }
    }

    function setupAppointmentsLogic() {
        document.getElementById('appointment-form').onsubmit = handleSaveAppointment;
        if (state.editingAppointmentId) {
            document.getElementById('appointment-cancel-edit-btn').onclick = () => {
                state.editingAppointmentId = null;
                renderView('calendar');
            };
        } 
        const internalCheckbox = document.getElementById('internal-service-checkbox');
        const regularClientFields = document.getElementById('regular-client-fields');
        const masterClientFields = document.getElementById('master-client-fields');
        const masterAsClientSelect = document.getElementById('master-as-client-select');
        const clientSearchInput = document.getElementById('client-search-input');
        const masterOptions = state.masters.filter(m => !m.isFrozen).map(m => `<option value="${m.id}">${m.name}</option>`).join('');
        masterAsClientSelect.innerHTML = `<option value="">Оберіть майстра-клієнта</option>${masterOptions}`;
        internalCheckbox.onchange = () => {
            const isInternal = internalCheckbox.checked;
            regularClientFields.style.display = isInternal ? 'none' : 'block';
            masterClientFields.style.display = isInternal ? 'block' : 'none';
            clientSearchInput.required = !isInternal;
            masterAsClientSelect.required = isInternal;
        };
        internalCheckbox.dispatchEvent(new Event('change'));

        const searchResultsEl = document.getElementById('client-search-results');
        const phoneGroup = document.getElementById('client-phone-group');
        const phoneInput = document.getElementById('client-phone-input');

        clientSearchInput.oninput = () => {
            state.selectedClientForAppointment = null;
            phoneGroup.style.display = 'block'; phoneInput.required = true;
            const searchTerm = clientSearchInput.value.toLowerCase().trim();
            if (searchTerm.length < 2) { searchResultsEl.style.display = 'none'; return; }
            const results = state.clients.filter(c => c.name.toLowerCase().includes(searchTerm) || (c.phone && c.phone.includes(searchTerm)));
            searchResultsEl.innerHTML = results.length > 0 ? results.map(c => `<div data-id="${c.id}" data-name="${c.name}" data-phone="${c.phone}">${c.name} - ${c.phone}</div>`).join('') : '';
            searchResultsEl.style.display = results.length > 0 ? 'block' : 'none';
        };
        searchResultsEl.onclick = (e) => {
            if(e.target.dataset.id) {
                state.selectedClientForAppointment = { id: e.target.dataset.id, name: e.target.dataset.name, phone: e.target.dataset.phone };
                clientSearchInput.value = state.selectedClientForAppointment.name;
                phoneInput.value = state.selectedClientForAppointment.phone;
                searchResultsEl.style.display = 'none'; phoneGroup.style.display = 'block';
            }
        };
        clientSearchInput.onblur = () => { setTimeout(() => searchResultsEl.style.display = 'none', 200); };
        
        populateAppointmentFormDropdowns();

        const categorySelect = document.getElementById('appointment-category');
        const serviceSearchInput = document.getElementById('appointment-service-search');
        const serviceSearchResultsEl = document.getElementById('service-search-results');
        
        categorySelect.onchange = () => {
            state.selectedServiceForAppointment = null;
            serviceSearchInput.value = '';
            const categoryId = categorySelect.value;
            const masterSelect = document.getElementById('appointment-master');
            const activeMasters = state.masters.filter(m => !m.isFrozen);
            const selectedCategoryName = state.categories.find(c => c.id === categoryId)?.name;
            const mastersForCategory = activeMasters.filter(m => (m.categoryIds?.includes(categoryId)) || (m.specialization && selectedCategoryName && Array.isArray(m.specialization) && m.specialization.includes(selectedCategoryName)));
            masterSelect.innerHTML = '<option value="">Оберіть майстра</option>' + mastersForCategory.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
            updateFinalPrice();
        };

        const showServiceList = (searchTerm = '') => {
            const categoryId = categorySelect.value;
            if (!categoryId) { serviceSearchResultsEl.style.display = 'none'; return; }
            const servicesForCategory = state.services.filter(s => s.categoryId === categoryId);
            const normalizedSearch = searchTerm.toLowerCase().trim();
            const results = servicesForCategory.filter(s => s.name.toLowerCase().includes(normalizedSearch));
            serviceSearchResultsEl.innerHTML = results.length > 0 ? results.map(s => `<div data-id="${s.id}">${s.name}</div>`).join('') : '<li>Послуг не знайдено</li>';
            serviceSearchResultsEl.style.display = 'block';
        };

        serviceSearchInput.onfocus = () => {
            if (!categorySelect.value) { showNotification("Спочатку оберіть категорію", "error"); return; }
            showServiceList(serviceSearchInput.value);
        };
        serviceSearchInput.oninput = () => {
            state.selectedServiceForAppointment = null;
            showServiceList(serviceSearchInput.value);
        };
        serviceSearchResultsEl.onclick = (e) => {
            const serviceId = e.target.dataset.id;
            if(serviceId) {
                const selectedService = state.services.find(s => s.id === serviceId);
                state.selectedServiceForAppointment = selectedService;
                serviceSearchInput.value = selectedService.name;
                serviceSearchResultsEl.style.display = 'none';
                updateFinalPrice();
            }
        };
        serviceSearchInput.onblur = () => {
            setTimeout(() => {
                serviceSearchResultsEl.style.display = 'none';
                if (!state.selectedServiceForAppointment) { serviceSearchInput.value = ''; } 
                else { serviceSearchInput.value = state.selectedServiceForAppointment.name; }
            }, 200);
        };

        ['appointment-master', 'appointment-salon', 'manual-discount-value', 'manual-discount-type', 'additional-charge-amount'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.oninput = updateFinalPrice;
        });
    }

    function renderDailyAppointmentsList() {
        const listEl = document.getElementById('daily-appointments-list');
        const paginationControls = document.getElementById('pagination-controls');
        if (!listEl) return;

        const selectedDate = state.appointmentsListDate;
        const startOfDay = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate());
        const endOfDay = new Date(startOfDay.getTime() + 24 * 60 * 60 * 1000 - 1);
        
        const dailyUnpaidAppointments = state.appointments.filter(app => {
            if (!app.dateTime) return false;
            const appDate = app.dateTime.toDate();
            return app.status !== 'completed' && appDate >= startOfDay && appDate <= endOfDay;
        }).sort((a, b) => a.dateTime.toDate() - b.dateTime.toDate());
        
        if (state.appointmentsPage === 1) {
            listEl.innerHTML = '';
            if (dailyUnpaidAppointments.length === 0) {
                listEl.innerHTML = '<li>На цю дату немає незавершених записів.</li>';
                if (paginationControls) paginationControls.innerHTML = '';
                return;
            }
        }

        const itemsPerPage = 10;
        const startIndex = (state.appointmentsPage - 1) * itemsPerPage;
        const paginatedAppointments = dailyUnpaidAppointments.slice(startIndex, startIndex + itemsPerPage);
        
        paginatedAppointments.forEach(appointment => {
            const service = state.services.find(s => s.id === appointment.serviceId)?.name || 'Послуга';
            const master = state.masters.find(m => m.id === appointment.masterId)?.name || 'Майстер';
            const time = appointment.dateTime.toDate().toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });
            
            const remaining = (appointment.finalPrice || 0) - (appointment.totalPaid || 0);
            const priceText = appointment.status === 'partially_paid' ? `Залишилось: ${remaining.toFixed(0)} zł` : `<strong>${appointment.finalPrice.toFixed(0)} zł</strong>`;
            
            const li = document.createElement('li');
            
            let actionButtonHtml = '';
            if (appointment.isInternal) {
                actionButtonHtml = `<button class="btn btn-complete-payment btn-settle">Взаєморозрахунок</button>`;
            } else {
                actionButtonHtml = `<button class="btn btn-complete-payment btn-pay">Оплатити</button>`;
            }

            li.innerHTML = `
                <div><strong>${time} - ${appointment.clientName}</strong><br><small>${service} (${master})</small></div>
                <div class="actions">${priceText}${actionButtonHtml}</div>`;
            
            if (appointment.isInternal) {
                li.querySelector('.btn-settle').onclick = () => handleSettleInternalService(appointment);
            } else {
                li.querySelector('.btn-pay').onclick = () => openPaymentModal(appointment);
            }
            
            listEl.appendChild(li);
        });
        
        if (paginationControls) {
            paginationControls.innerHTML = '';
            if (dailyUnpaidAppointments.length > startIndex + itemsPerPage) {
                const loadMoreBtn = document.createElement('button');
                loadMoreBtn.className = 'btn';
                loadMoreBtn.innerText = 'Завантажити ще';
                loadMoreBtn.onclick = () => { 
                    state.appointmentsPage++;
                    renderDailyAppointmentsList(); 
                };
                paginationControls.appendChild(loadMoreBtn);
            }
        }
    }

    function populateAppointmentFormDropdowns() { 
        const categorySelect = document.getElementById('appointment-category');
        if (categorySelect) { 
            categorySelect.innerHTML = '<option value="">Оберіть категорію</option>' + state.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        } 
    }

    function updateFinalPrice() { 
        const service = state.selectedServiceForAppointment;
        const masterId = document.getElementById('appointment-master').value; 
        const manualDiscountValue = parseFloat(document.getElementById('manual-discount-value').value) || 0; 
        const manualDiscountType = document.getElementById('manual-discount-type').value; 
        const additionalChargeAmount = parseFloat(document.getElementById('additional-charge-amount').value) || 0;
        const priceDisplay = document.getElementById('final-price-display');
        
        if (!service || !masterId) { 
            priceDisplay.innerText = `Сума до оплати: 0 zł`;
            return 0; 
        } 

        const category = state.categories.find(c => c.id === service.categoryId);
        const master = state.masters.find(m => m.id === masterId); 
        let price = service.price;
        const discountPercent = service.discount > 0 ? service.discount : (category?.discount || 0); 
        price *= (1 - discountPercent / 100);
        
        const markupPercent = master.priceModifier || 0;
        price *= (1 + markupPercent / 100);
        
        if (manualDiscountType === 'percent') { 
            price *= (1 - manualDiscountValue / 100);
        } else { 
            price -= manualDiscountValue;
        } 
        
        price += additionalChargeAmount;
        priceDisplay.innerText = `Сума до оплати: ${price.toFixed(0)} zł`;
        return price;
    }

    async function handleSaveAppointment(event) {
        event.preventDefault();
        const isEditMode = !!state.editingAppointmentId;
        const isInternal = document.getElementById('internal-service-checkbox').checked;
        const service = state.selectedServiceForAppointment;
        const masterId = document.getElementById('appointment-master').value;
        const dateTimeString = document.getElementById('appointment-datetime').value;
        const salonId = document.getElementById('appointment-salon').value;
        
        if (!service || !masterId || !dateTimeString || !salonId) {
            return showNotification("Будь ласка, заповніть усі поля, включно з послугою та салоном.", "error");
        }

        const master = state.masters.find(m => m.id === masterId);
        if (!master) {
            return showNotification("Помилка: не знайдено майстра!", "error");
        }

        const priceModifier = master.priceModifier || 0;
        const salaryBase = service.price * (1 + priceModifier / 100);
        const finalPrice = updateFinalPrice();
        const additionalChargeAmount = parseFloat(document.getElementById('additional-charge-amount').value) || 0;
        const additionalChargeDescription = document.getElementById('additional-charge-description').value.trim();
        
        let appointmentData = { 
            dateTime: Timestamp.fromDate(new Date(dateTimeString)), 
            serviceId: service.id, 
            masterId, 
            salonId, 
            duration: service.duration || 60, 
            manualDiscount: { value: parseFloat(document.getElementById('manual-discount-value').value) || 0, type: document.getElementById('manual-discount-type').value }, 
            additionalCharge: { amount: additionalChargeAmount, description: additionalChargeDescription }, 
            finalPrice, 
            salaryBase, 
            isInternal: isInternal 
        };
        let logDetails = { service: service.name, master: master.name };

        try {
            if (isInternal) {
                const receivingMasterId = document.getElementById('master-as-client-select').value;
                if (!receivingMasterId) { return showNotification("Будь ласка, оберіть майстра-клієнта.", "error"); }
                if (receivingMasterId === masterId) { return showNotification("Майстер не може надавати послугу самому собі.", "error"); }
                const receivingMaster = state.masters.find(m => m.id === receivingMasterId);
                appointmentData.clientId = receivingMasterId;
                appointmentData.clientName = `${receivingMaster.name} (Майстер)`;
                logDetails.clientName = appointmentData.clientName;
            } else {
                const clientName = document.getElementById('client-search-input').value.trim();
                logDetails.clientName = clientName;
                let clientId;
                let clientPhone = document.getElementById('client-phone-input').value.trim();
                if (state.selectedClientForAppointment) {
                    clientId = state.selectedClientForAppointment.id;
                } else {
                    if (!clientPhone) return showNotification("Для нового клієнта необхідно вказати номер телефону.", "error");
                    const normalizedPhone = clientPhone.replace(/[\s-()]/g, '');
                    const existingClient = state.clients.find(c => c.name.toLowerCase() === clientName.toLowerCase() && c.phone.replace(/[\s-()]/g, '') === normalizedPhone);
                    if (existingClient) { clientId = existingClient.id; } 
                    else {
                         const newClientAction = () => addDoc(collection(db, 'clients'), { name: clientName, phone: clientPhone, createdAt: Timestamp.now() });
                         const newClientRef = await logAndExecute('Створено клієнта', { name: clientName, phone: clientPhone }, newClientAction);
                         clientId = newClientRef.id;
                    }
                }
                appointmentData.clientId = clientId;
                appointmentData.clientName = clientName;
            }

            if (isEditMode) {
                const action = () => updateDoc(doc(db, 'appointments', state.editingAppointmentId), appointmentData);
                await logAndExecute('Оновлено запис', { ...logDetails, appointmentId: state.editingAppointmentId }, action);
                showNotification('Запис успішно оновлено!');
                state.editingAppointmentId = null;
                renderView('calendar');
            } else {
                const fullAppointmentData = { ...appointmentData, status: 'upcoming', totalPaid: 0, payments: [], createdAt: Timestamp.now() };
                const createAppAction = () => addDoc(collection(db, 'appointments'), fullAppointmentData);
                await logAndExecute('Створено запис', logDetails, createAppAction);
                showNotification('Запис успішно створено!');
                event.target.reset();
                state.selectedClientForAppointment = null;
                state.selectedServiceForAppointment = null;
                document.getElementById('internal-service-checkbox').checked = false;
                document.getElementById('internal-service-checkbox').dispatchEvent(new Event('change'));
                const clientSearchInput = document.getElementById('client-search-input');
                if(clientSearchInput) clientSearchInput.disabled = false;
                document.getElementById('client-phone-group').style.display = 'none';
                updateFinalPrice();
            }
        } catch (e) {
            showNotification('Не вдалося зберегти запис.', "error");
        }
    }
     
    async function handleConfirmPayment(event) {
        event.preventDefault();
        const appointmentId = document.getElementById('payment-appointment-id').value;
        const paymentType = document.getElementById('payment-modal-type').value;
        const amountToPay = parseFloat(document.getElementById('payment-amount').value);
        if (!appointmentId || !amountToPay || amountToPay <= 0) {
            return showNotification('Будь ласка, введіть коректну суму.', "error");
        }

        const appointmentRef = doc(db, 'appointments', appointmentId);
        try {
            const appointmentSnap = await getDoc(appointmentRef);
            if (!appointmentSnap.exists()) { throw new Error("Запис не знайдено"); }
            const appointmentData = appointmentSnap.data();
            const currentTotalPaid = appointmentData.totalPaid || 0;
            const finalPrice = appointmentData.finalPrice;
            
            const processPayment = async () => {
                const newPayment = { amount: amountToPay, type: paymentType, date: Timestamp.now() };
                const newTotalPaid = currentTotalPaid + amountToPay;
                const newStatus = (newTotalPaid >= finalPrice - 0.001) ? 'completed' : 'partially_paid';
                const action = () => updateDoc(appointmentRef, { payments: arrayUnion(newPayment), totalPaid: increment(amountToPay), status: newStatus, ...(newStatus === 'completed' && !appointmentData.completedAt && { completedAt: Timestamp.now() }) });
                await logAndExecute('Проведено оплату', { appointmentId, clientName: appointmentData.clientName, amount: amountToPay, type: paymentType }, action);
                document.getElementById('payment-modal').style.display = 'none';
            };

            if (amountToPay > (finalPrice - currentTotalPaid) + 0.01) { 
                showConfirmModal(`Сума оплати (${amountToPay.toFixed(2)} zł) більша за залишок (${(finalPrice - currentTotalPaid).toFixed(2)} zł). Продовжити?`, processPayment);
            } else {
                await processPayment();
            }
        } catch (e) {
            showNotification('Не вдалося провести оплату. Помилка: ' + e.message, "error");
        }
    }
    // #endregion

    // #region Masters View
    function renderMastersView(container) {
    const salonCheckboxes = state.salons.map(s => 
        `<label><input type="checkbox" class="new-master-salon-cb" value="${s.id}"> ${s.name}</label>`
    ).join('');
    
    const editSalonCheckboxes = state.salons.map(s => 
        `<label><input type="checkbox" class="edit-master-salon-cb" value="${s.id}"> ${s.name}</label>`
    ).join('');

    container.innerHTML = `
        <div class="content-card">
            <h2>Додати нового майстра</h2>
            <form id="add-master-form">
                <div class="form-group"><label for="new-master-name">Ім'я та прізвище</label><input type="text" id="new-master-name" required></div>
                
                <div class="form-group">
                    <label>Салони, де працює майстер</label>
                    <div id="new-master-salons" class="category-checkbox-group">${salonCheckboxes}</div>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex:1;"><label for="new-master-tier">Ранг</label><input type="text" id="new-master-tier" placeholder="напр. Топ-майстер"></div>
                    <div class="form-group" style="flex:1;"><label for="new-master-modifier">Націнка (%)</label><input type="number" id="new-master-modifier" value="0" min="0"></div>
                </div>
                <div class="form-group"><label>Спеціалізації</label><div id="new-master-categories" class="category-checkbox-group"></div></div>
                <button class="btn" type="submit">Додати майстра</button>
            </form>
        </div>
        <div class="content-card" style="margin-top: 2rem;">
            <h2>Список майстрів</h2>
            <ul id="masters-list" class="item-list"></ul>
        </div>
        <div class="modal-overlay" id="edit-master-modal">
            <div class="modal-panel">
                <div class="modal-header"><h2>Редагувати майстра</h2><button class="close-btn">&times;</button></div>
                <form id="edit-master-form">
                    <input type="hidden" id="edit-master-id">
                    <div class="form-group"><label for="edit-master-name">Ім'я та прізвище</label><input type="text" id="edit-master-name" required></div>
                    
                    <div class="form-group">
                        <label>Салони, де працює майстер</label>
                        <div id="edit-master-salons" class="category-checkbox-group">${editSalonCheckboxes}</div>
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="flex:1;"><label for="edit-master-tier">Ранг</label><input type="text" id="edit-master-tier"></div>
                        <div class="form-group" style="flex:1;"><label for="edit-master-modifier">Націнка (%)</label><input type="number" id="edit-master-modifier" min="0"></div>
                    </div>
                    <div class="form-group"><label>Спеціалізації</label><div id="edit-master-categories" class="category-checkbox-group"></div></div>
                    <div class="form-group category-checkbox-group" style="max-height: none; padding: 0.5rem;"><label><input type="checkbox" id="edit-master-frozen"> Заморозити майстра</label></div>
                    <button type="submit" class="btn">Зберегти зміни</button>
                </form>
            </div>
        </div>`;
        
    document.getElementById('add-master-form').onsubmit = handleAddMaster; 
    document.querySelector('#edit-master-modal .close-btn').onclick = () => document.getElementById('edit-master-modal').style.display = 'none'; 
    document.getElementById('edit-master-form').onsubmit = handleUpdateMaster; 
    populateCategoryCheckboxes('new-master-categories'); 
    
    const listEl = document.getElementById('masters-list'); 
    listEl.innerHTML = state.masters.length > 0 ? '' : '<li>Немає майстрів.</li>'; 
    state.masters.forEach(master => { 
        const li = document.createElement('li');
        li.className = master.isFrozen ? 'is-frozen' : '';
        const masterSalons = (master.salonIds || []).map(id => state.salons.find(s => s.id === id)?.name || '').filter(Boolean).join(', ');
        li.innerHTML = `
            <div class="master-info-clickable" data-id="${master.id}" style="flex-grow: 1; cursor: pointer;">
                <strong>${master.name}</strong> ${master.tier ? `(${master.tier})` : ''} <br>
                <small>Салони: ${masterSalons || 'Не вказано'}</small>
            </div>
            <div class="actions">
                <button class="btn btn-edit" data-id="${master.id}" data-action="edit-profile">Ред.</button>
            </div>`;
        listEl.appendChild(li); 
    }); 
    
    listEl.onclick = (event) => { 
        const button = event.target.closest('button[data-action="edit-profile"]');
        if (button) { 
            event.stopPropagation(); 
            showEditMasterModal(button.dataset.id); 
        } else { 
            const masterItem = event.target.closest('.master-info-clickable');
            if (masterItem) { 
                state.viewingMasterId = masterItem.dataset.id; 
                renderView('masterDetail'); 
            } 
        } 
    };
}

    function renderMasterDetailView(container) {
        const masterId = state.viewingMasterId;
        const master = state.masters.find(m => m.id === masterId);
        if (!master) {
            container.innerHTML = `<div class="content-card"><h2>Майстра не знайдено</h2><p><button id="detail-view-back-btn" class="btn">Назад до списку</button></p></div>`;
            container.onclick = (event) => { if (event.target.id === 'detail-view-back-btn') { renderView('masters'); } };
            return;
        }
        const categoriesList = (master.categoryIds || []).map(id => state.categories.find(c => c.id === id)?.name).filter(Boolean).join(', ') || 'Не вказано';
        container.innerHTML = `
            <div class="content-card">
                <button id="detail-view-back-btn" class="btn" style="margin-bottom: 2rem; width: auto; background-color: var(--gray-text);">&larr; Назад до списку майстрів</button>
                <h2>${master.name} ${master.tier ? `(${master.tier})` : ''}</h2>
                <p><strong>Спеціалізації:</strong> ${categoriesList}</p>
            </div>
            <div class="content-card">
                <h3>Видача авансу</h3>
            <form id="add-advance-form">
                <div class="form-row">
                    <div class="form-group" style="flex:2;"><label for="advance-amount">Сума авансу (zł)</label><input type="number" id="advance-amount" min="1" required></div>
                    <div class="form-group" style="flex:1;"><label for="advance-payment-type">Тип оплати</label><select id="advance-payment-type" required><option value="cash">Готівка</option><option value="card">Картка</option></select></div>
                </div>
            <div class="form-group"><label for="advance-description">Опис (необов'язково)</label><textarea id="advance-description" rows="2"></textarea></div>
            <button type="submit" class="btn">Видати аванс</button>
            </form>
            </div>
            <div class="content-card"><h3>Історія авансів</h3><ul id="master-advances-list" class="item-list"><li>Завантаження...</li></ul></div>
        `;
        
        container.onclick = function(event) {
            if (event.target.closest('#detail-view-back-btn')) { renderView('masters'); return; }
            const deleteButton = event.target.closest('.btn-delete-advance');
            if (deleteButton) { handleDeleteAdvance(deleteButton.dataset.id, master.name, deleteButton.dataset.amount, deleteButton.dataset.description); return; }
        };

        document.getElementById('add-advance-form').onsubmit = handleAddAdvance;
        
        const advancesCollectionRef = collection(db, 'masters', masterId, 'advances');
        masterAdvancesUnsubscribe = onSnapshot(query(advancesCollectionRef, orderBy("date", "desc")), (snapshot) => {
            state.viewingMasterAdvances = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const listEl = document.getElementById('master-advances-list');
            if (listEl) {
                listEl.innerHTML = state.viewingMasterAdvances.length === 0 ? '<li>Авансів ще не було.</li>' : state.viewingMasterAdvances.map(adv => `
                    <li>
                        <div><span>${adv.date.toDate().toLocaleString('uk-UA')}</span>${adv.description ? `<br><small style="color: var(--gray-text);">${adv.description}</small>` : ''}</div>
                        <div class="actions"><strong>${adv.amount} zł</strong><button class="btn btn-delete btn-delete-advance" data-id="${adv.id}" data-amount="${adv.amount}" data-description="${adv.description || ''}">Видалити</button></div>
                    </li>
                `).join('');
            }
        });
    }

    async function handleAddAdvance(event) {
        event.preventDefault();
        const masterId = state.viewingMasterId;
        const master = state.masters.find(m => m.id === masterId);
        const amountInput = document.getElementById('advance-amount');
        const descriptionInput = document.getElementById('advance-description');
        const amount = parseFloat(amountInput.value);
        const description = descriptionInput.value.trim();
        
        if (!masterId || !amount || amount <= 0) { return showNotification('Будь ласка, введіть коректну суму.', "error"); }
        
        const paymentType = document.getElementById('advance-payment-type').value;
        const data = { amount: amount, date: Timestamp.now(), paymentType: paymentType };
        if (description) { data.description = description; }
        
        const action = () => addDoc(collection(db, 'masters', masterId, 'advances'), data);
        
        try {
            await logAndExecute('Видано аванс майстру', { masterId, name: master.name, amount, description }, action);
            amountInput.value = '';
            descriptionInput.value = '';
        } catch (e) {
            showNotification("Помилка при видачі авансу.", "error");
        }
    }

    async function handleDeleteAdvance(advanceId, masterName, amount, description) {
        const masterId = state.viewingMasterId;
        if (!masterId || !advanceId) return;

        showConfirmWithReasonModal('Ви впевнені, що хочете видалити цей аванс?', async (reason) => {
            const action = () => deleteDoc(doc(db, 'masters', masterId, 'advances', advanceId));
            const logDetails = { masterId, name: masterName, amount: parseFloat(amount), description };
            if (reason) logDetails.reason = reason;
            try { await logAndExecute('Видалено аванс майстра', logDetails, action); } 
            catch (e) { showNotification("Помилка при видаленні авансу.", "error"); }
        });
    }

    function populateCategoryCheckboxes(elementId, checkedIds = []) { 
        const container = document.getElementById(elementId); 
        if (!container) return;
        container.innerHTML = state.categories.length ? '' : 'Спочатку додайте категорії'; 
        state.categories.forEach(category => { 
            const isChecked = checkedIds.includes(category.id); 
            container.innerHTML += `<label><input type="checkbox" value="${category.id}" ${isChecked ? 'checked' : ''}> ${category.name}</label>`; 
        });
    }
    
    async function handleAddMaster(event) { 
    event.preventDefault();
    const name = document.getElementById('new-master-name').value.trim(); 
    const salonIds = Array.from(document.querySelectorAll('#new-master-salons input:checked')).map(el => el.value);
    const tier = document.getElementById('new-master-tier').value.trim(); 
    const priceModifier = parseFloat(document.getElementById('new-master-modifier').value) || 0;
    const categoryIds = Array.from(document.querySelectorAll('#new-master-categories input:checked')).map(el => el.value); 
    
    if (!name || salonIds.length === 0) return showNotification("Введіть ім'я та оберіть хоча б один салон.", "error");
    
    const action = () => addDoc(collection(db, 'masters'), { name, salonIds, tier, priceModifier, categoryIds, isFrozen: false, timestamp: Timestamp.now() });
    try { 
        await logAndExecute('Створено майстра', { name }, action);
        event.target.reset();
    } catch (e) { showNotification('Не вдалося додати майстра.', "error"); } 
}

function showEditMasterModal(id) { 
    const master = state.masters.find(m => m.id === id);
    if (!master) return showNotification('Майстра не знайдено!', "error"); 
    
    const modal = document.getElementById('edit-master-modal'); 
    modal.style.display = 'flex'; 
    document.getElementById('edit-master-id').value = id; 
    document.getElementById('edit-master-name').value = master.name;
    document.getElementById('edit-master-tier').value = master.tier || ''; 
    document.getElementById('edit-master-modifier').value = master.priceModifier || 0; 
    document.getElementById('edit-master-frozen').checked = master.isFrozen || false; 
    
    document.querySelectorAll('.edit-master-salon-cb').forEach(cb => {
        cb.checked = (master.salonIds || []).includes(cb.value);
    });
    populateCategoryCheckboxes('edit-master-categories', master.categoryIds || []);
}
    
async function handleUpdateMaster(event) { 
    event.preventDefault();
    const id = document.getElementById('edit-master-id').value; 
    const name = document.getElementById('edit-master-name').value.trim(); 
    const salonIds = Array.from(document.querySelectorAll('#edit-master-salons input:checked')).map(el => el.value);
    const tier = document.getElementById('edit-master-tier').value.trim(); 
    const priceModifier = parseFloat(document.getElementById('edit-master-modifier').value) || 0;
    const categoryIds = Array.from(document.querySelectorAll('#edit-master-categories input:checked')).map(el => el.value); 
    const isFrozen = document.getElementById('edit-master-frozen').checked; 
    
    if (!name || salonIds.length === 0) return showNotification("Ім'я та салон не можуть бути порожніми.", "error");

    const action = () => updateDoc(doc(db, 'masters', id), { name, salonIds, tier, priceModifier, categoryIds, isFrozen });
    try { 
        await logAndExecute('Оновлено дані майстра', { masterId: id, name }, action);
        document.getElementById('edit-master-modal').style.display = 'none';
    } catch(e) { showNotification('Не вдалося оновити.', "error"); } 
}
    // #endregion

    // #region Services View
    function renderServicesView(container) { 
        container.innerHTML = `
            <div class="services-layout">
                <div class="content-card">
                    <h2>Категорії</h2>
                    <form id="add-category-form" class="form-group">
                        <input type="text" id="new-category-name" placeholder="Нова категорія..." required>
                        <button class="btn" type="submit" style="width:100%; margin-top:0.5rem;">Додати</button>
                    </form>
                    <ul id="categories-list" class="item-list"></ul>
                </div>
                <div id="services-container">
                    <div class="content-card"><p>Оберіть категорію зліва.</p></div>
                </div>
            </div>
            <div class="modal-overlay" id="edit-category-modal">
                <div class="modal-panel">
                    <div class="modal-header"><h2>Редагувати категорію</h2><button class="close-btn">&times;</button></div>
                    <form id="edit-category-form">
                        <input type="hidden" id="edit-category-id">
                        <div class="form-group"><label for="edit-category-name">Назва категорії</label><input type="text" id="edit-category-name" required></div>
                        <div class="form-group"><label for="edit-category-discount">Акційна знижка (%)</label><input type="number" id="edit-category-discount" min="0" max="100" value="0"></div>
                        <button type="submit">Зберегти зміни</button>
                    </form>
                </div>
            </div>
            <div class="modal-overlay" id="edit-service-modal">
                <div class="modal-panel">
                    <div class="modal-header"><h2 id="service-modal-title">Послуга</h2><button class="close-btn">&times;</button></div>
                    <form id="edit-service-form">
                        <input type="hidden" id="edit-service-id">
                        <div class="form-group"><label for="edit-service-name">Назва</label><input type="text" id="edit-service-name" required></div>
                        <div class="form-row">
                            <div class="form-group" style="flex:1;"><label for="edit-service-duration">Тривалість (хв)</label><input type="number" id="edit-service-duration" required min="0"></div>
                            <div class="form-group" style="flex:1;"><label for="edit-service-price">Ціна (zł)</label><input type="number" id="edit-service-price" required min="0"></div>
                        </div>
                        <div class="form-group"><label for="edit-service-discount">Персональна знижка (%)</label><input type="number" id="edit-service-discount" min="0" max="100" value="0"></div>
                        <button type="submit">Зберегти</button>
                    </form>
                </div>
            </div>`; 
        setupCategoriesLogic(); 
        if (state.selectedCategoryId) { 
            renderServicesForCategory();
        } 
    }
    
    function setupCategoriesLogic() { 
        document.getElementById('add-category-form').onsubmit = handleAddCategory; 
        document.getElementById('edit-category-modal').querySelector('.close-btn').onclick = () => document.getElementById('edit-category-modal').style.display = 'none';
        document.getElementById('edit-category-form').onsubmit = handleUpdateCategory; 
        const categoriesListEl = document.getElementById('categories-list'); 
        categoriesListEl.innerHTML = state.categories.length > 0 ? '' : '<li>Немає категорій.</li>';
        state.categories.forEach(category => { 
            const li = document.createElement('li'); 
            li.className = 'category-list-item'; 
            li.dataset.id = category.id; 
            if (category.id === state.selectedCategoryId) li.classList.add('selected'); 
            li.innerHTML = `<span>${category.name} ${category.discount ? `<strong style="color:var(--danger-color);">-`+category.discount+'%</strong>' : ''}</span><div class="actions"><button class="btn btn-edit" data-id="${category.id}" data-name="${category.name}" data-discount="${category.discount || 0}">✏️</button><button class="btn btn-delete" data-id="${category.id}" data-name="${category.name}">🗑️</button></div>`; 
            categoriesListEl.appendChild(li); 
        });
        
        categoriesListEl.onclick = (event) => { 
            const target = event.target; 
            const deleteBtn = target.closest('.btn-delete'); 
            if (deleteBtn) { handleDeleteCategory(deleteBtn.dataset.id, deleteBtn.dataset.name);
            } else if (target.closest('.btn-edit')) { 
                const btn = target.closest('.btn-edit'); 
                showEditCategoryModal(btn.dataset.id, btn.dataset.name, btn.dataset.discount); 
            } else if (target.closest('.category-list-item')) { 
                state.selectedCategoryId = target.closest('.category-list-item').dataset.id;
                renderView('services'); 
            } 
        }; 
    }

    function renderServicesForCategory() { 
        const categoryId = state.selectedCategoryId; 
        const servicesContainer = document.getElementById('services-container');
        const category = state.categories.find(c => c.id === categoryId); 
        const categoryName = category ? category.name : '';
        servicesContainer.innerHTML = `<div class="content-card"><div style="display:flex; justify-content:space-between; align-items:center;"><h2>Послуги: ${categoryName}</h2><button id="add-service-btn" class="btn">Додати послугу</button></div><ul id="services-list" class="item-list"></ul></div>`; 
        document.getElementById('add-service-btn').onclick = () => showServiceModal();
        const servicesListEl = document.getElementById('services-list'); 
        const filteredServices = state.services.filter(s => s.categoryId === categoryId).sort((a,b)=>a.name.localeCompare(b.name)); 
        servicesListEl.innerHTML = filteredServices.length > 0 ? '' : '<li>Немає послуг в цій категорії.</li>'; 
        filteredServices.forEach(service => { 
            const finalDiscount = (service.discount > 0) ? service.discount : (category?.discount || 0); 
            const discountedPrice = service.price * (1 - finalDiscount / 100); 
            const li = document.createElement('li'); 
            li.innerHTML = `<div><strong>${service.name}</strong><br><small>${service.duration || 'N/A'} хв. ${service.discount > 0 ? `(Знижка ${service.discount}%)` : ''}</small></div><div class="price-display">${finalDiscount > 0 ? `<span class="old-price">${service.price} zł</span>` : ''}<span class="new-price">${discountedPrice.toFixed(0)} zł</span></div><div class="actions"><button class="btn-edit btn-edit-service" data-id="${service.id}" data-name="${service.name}" data-duration="${service.duration}" data-price="${service.price}" data-discount="${service.discount || 0}">✏️</button><button class="btn btn-delete btn-delete-service" data-id="${service.id}" data-name="${service.name}">🗑️</button></div>`; 
            servicesListEl.appendChild(li); 
        });
        servicesListEl.onclick = (event) => { 
            const target = event.target.closest('button'); 
            if (!target) return; 
            const deleteBtn = target.closest('.btn-delete-service'); 
            if (deleteBtn) handleDeleteService(deleteBtn.dataset.id, deleteBtn.dataset.name);
            if (target.classList.contains('btn-edit-service')) { showServiceModal(target.dataset.id, target.dataset); }
        }; 
    }

    async function handleAddCategory(event) { 
        event.preventDefault(); 
        const nameInput = document.getElementById('new-category-name');
        const name = nameInput.value.trim(); 
        if (!name) return; 
        const action = () => addDoc(collection(db, 'serviceCategories'), { name, discount: 0 });
        try { 
            await logAndExecute('Створено категорію', { name }, action); 
            nameInput.value = ''; 
        } catch (e) { showNotification('Не вдалося додати.', "error"); } 
    }

    async function handleDeleteCategory(id, name) { 
        showConfirmWithReasonModal(`Видалити категорію "${name}" та всі послуги в ній?`, async (reason) => { 
            try { 
                const q = query(collection(db, 'services'), where('categoryId', '==', id)); 
                const snapshot = await getDocs(q); 
                const deletePromises = []; 
                snapshot.forEach(doc => deletePromises.push(deleteDoc(doc.ref))); 
                await Promise.all(deletePromises); 
                const logDetails = { categoryId: id, name }; 
                if (reason) logDetails.reason = reason; 
                await logAndExecute('Видалено категорію', logDetails, () => deleteDoc(doc(db, 'serviceCategories', id))); 
                if (state.selectedCategoryId === id) { state.selectedCategoryId = null; } 
            } catch (e) { showNotification('Не вдалося видалити.', "error"); } 
        });
    }

    function showEditCategoryModal(id, name, discount) { 
        const modal = document.getElementById('edit-category-modal'); 
        modal.style.display = 'flex'; 
        document.getElementById('edit-category-id').value = id;
        document.getElementById('edit-category-name').value = name; 
        document.getElementById('edit-category-discount').value = discount || 0; 
    }

    async function handleUpdateCategory(event) { 
        event.preventDefault();
        const id = document.getElementById('edit-category-id').value; 
        const name = document.getElementById('edit-category-name').value.trim(); 
        const discount = parseFloat(document.getElementById('edit-category-discount').value) || 0;
        if (!name) return showNotification('Назва не може бути порожньою.', "error"); 
        
        const action = () => updateDoc(doc(db, 'serviceCategories', id), { name, discount });
        try { 
            await logAndExecute('Оновлено категорію', { categoryId: id, name }, action); 
            document.getElementById('edit-category-modal').style.display = 'none';
        } catch(e) { showNotification('Не вдалося оновити.', "error"); } 
    }

    function showServiceModal(id = null, data = {}) { 
        const modal = document.getElementById('edit-service-modal');
        modal.style.display = 'flex'; 
        modal.querySelector('h2').textContent = id ? 'Редагувати послугу' : 'Додати нову послугу'; 
        document.getElementById('edit-service-id').value = id || '';
        document.getElementById('edit-service-name').value = data.name || ''; 
        document.getElementById('edit-service-duration').value = data.duration || ''; 
        document.getElementById('edit-service-price').value = data.price || ''; 
        document.getElementById('edit-service-discount').value = data.discount || 0;
        document.getElementById('edit-service-form').onsubmit = id ? handleUpdateService : handleAddService; 
        document.querySelector('#edit-service-modal .close-btn').onclick = () => modal.style.display = 'none';
    }

    async function handleAddService(event) { 
        event.preventDefault(); 
        if (!state.selectedCategoryId) return showNotification('Спочатку оберіть категорію!', "error"); 
        
        const name = document.getElementById('edit-service-name').value.trim();
        const duration = parseInt(document.getElementById('edit-service-duration').value); 
        const price = parseFloat(document.getElementById('edit-service-price').value); 
        const discount = parseFloat(document.getElementById('edit-service-discount').value) || 0;
        
        if (!name || !(duration>=0) || !(price>=0)) return showNotification('Заповніть усі поля коректно.', "error");
        
        const action = () => addDoc(collection(db, 'services'), { name, duration, price, discount, categoryId: state.selectedCategoryId });
        try { 
            await logAndExecute('Створено послугу', { name, categoryId: state.selectedCategoryId }, action); 
            document.getElementById('edit-service-modal').style.display = 'none';
        } catch (e) { showNotification('Не вдалося додати.', "error"); } 
    }

    async function handleUpdateService(event) { 
        event.preventDefault();
        const id = document.getElementById('edit-service-id').value; 
        const name = document.getElementById('edit-service-name').value.trim(); 
        const duration = parseInt(document.getElementById('edit-service-duration').value); 
        const price = parseFloat(document.getElementById('edit-service-price').value);
        const discount = parseFloat(document.getElementById('edit-service-discount').value) || 0; 
        
        if (!name || !(duration>=0) || !(price>=0)) return showNotification('Заповніть усі поля коректно.', "error");
        
        const action = () => updateDoc(doc(db, 'services', id), { name, duration, price, discount });
        try { 
            await logAndExecute('Оновлено послугу', { serviceId: id, name }, action); 
            document.getElementById('edit-service-modal').style.display = 'none';
        } catch(e) { showNotification('Не вдалося оновити.', "error"); } 
    }

    async function handleDeleteService(id, name) { 
        showConfirmWithReasonModal(`Видалити послугу "${name}"?`, async (reason) => { 
            const action = () => deleteDoc(doc(db, 'services', id)); 
            const logDetails = { serviceId: id, name }; 
            if (reason) logDetails.reason = reason; 
            try { 
                await logAndExecute('Видалено послугу', logDetails, action); 
            } catch (e) { showNotification('Не вдалося видалити.', "error"); } 
        });
    }
    // #endregion

    // #region Salary, Expenses, Notepad & Settings
    function renderSalaryView(container) {
        const masterOptions = state.masters.filter(m => !m.isFrozen).map(m => `<option value="${m.id}">${m.name}</option>`).join('');
        const salonOptions = state.salons.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        const today = new Date();
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
        const todayStr = today.toISOString().split('T')[0];
        container.innerHTML = `
            <div class="content-card">
                <h2>Розрахунок зарплати</h2>
                <form id="calculate-salary-form">
                    <div class="form-row">
                        <div class="form-group" style="flex:1;"><label for="salary-start-date">З</label><input type="date" id="salary-start-date" value="${firstDayOfMonth}"></div>
                        <div class="form-group" style="flex:1;"><label for="salary-end-date">По</label><input type="date" id="salary-end-date" value="${todayStr}"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex:1;"><label for="salary-master-filter">Майстер</label><select id="salary-master-filter"><option value="all">Всі майстри</option>${masterOptions}</select></div>
                        <div class="form-group" style="flex:1;"><label for="salary-salon-filter">Салон</label><select id="salary-salon-filter"><option value="all">Всі салони (Разом)</option>${salonOptions}</select></div>
                    </div>
                    <button type="submit" class="btn" style="width: 100%;">Розрахувати</button>
                </form>
            </div>
            <div id="salary-report" style="margin-top: 2rem;"></div>`;
        document.getElementById('calculate-salary-form').onsubmit = handleCalculateSalary;
    }
    
    async function handleCalculateSalary(event) {
        event.preventDefault();
        const reportContainer = document.getElementById('salary-report');
        reportContainer.innerHTML = '<p>Розрахунок...</p>';
        const startDate = document.getElementById('salary-start-date').value;
        const endDate = document.getElementById('salary-end-date').value;
        const selectedMasterId = document.getElementById('salary-master-filter').value;
        const selectedSalonId = document.getElementById('salary-salon-filter').value;
        try {
            const generateReport = httpsCallable(functions, 'generateAndSendReport');
            const result = await generateReport({ startDate, endDate, salonId: selectedSalonId, isManualCalculation: true });
            const reportText = result.data.reportBody;
            const masterReports = reportText.split('--- ДЕТАЛІЗАЦІЯ ПО ЗАРПЛАТІ МАЙСТРІВ ---')[1].split('--- ДЕТАЛІЗАЦІЯ ПО ЗАРПЛАТІ ПЕРСОНАЛУ ---')[0];
            const masterReportParts = masterReports.split('----------------------------').filter(part => part.trim() !== '');
            let reportHtml = '';
            masterReportParts.forEach(part => {
                if (!part.includes('Майстер:')) return;
                const name = part.match(/Майстер: (.*)/)[1];
                const group = part.match(/\(Група: (.*)\)/)[1];
                const base = part.match(/База для ЗП .*?: (.*) zł/)[1];
                const rate = part.match(/Ставка: (.*)%/)[1];
                const salaryFromBase = part.match(/Нараховано ЗП .*?: (.*) zł/)[1];
                const bonus = part.match(/Нарахування .*?: \+(.*) zł/)[1];
                const advances = part.match(/Аванси: -(.*) zł/)[1];
                const settlements = part.match(/Взаєморозрахунок .*?: -(.*) zł/)[1];
                const toPay = part.match(/ДО ВИПЛАТИ: (.*) zł/)[1];
                
                if (selectedMasterId === 'all' || state.masters.find(m => m.name === name)?.id === selectedMasterId) {
                     reportHtml += `
                        <div class="salary-report-card">
                            <h3>${name}</h3>
                            <p><span>Група зарплати:</span> <strong>${group}</strong></p>
                            <p><span>База для нарахування ЗП:</span> <strong>${base} zł</strong></p>
                            <p><span>Ставка:</span> <strong>${rate}%</strong></p>
                            <p><span>Нарахована ЗП (від бази):</span> <span>${salaryFromBase} zł</span></p>
                            <p><span>Нарахування (внутр. послуги):</span> <span style="color: var(--success-color);">+${bonus} zł</span></p>
                            <p><span>Видано авансів:</span> <span style="color: var(--danger-color);">- ${advances} zł</span></p>
                            <p><span>Взаєморозрахунок (списання):</span> <span style="color: var(--danger-color);">- ${settlements} zł</span></p>
                            <p class="total-salary"><span>До виплати:</span> <strong>${toPay} zł</strong></p>
                        </div>`;
                }
            });
            reportContainer.innerHTML = reportHtml || '<p>За обраними фільтрами немає даних для розрахунку.</p>';
        } catch (error) {
            console.error("Помилка розрахунку ЗП:", error);
            reportContainer.innerHTML = `<p style="color: var(--danger-color);">Помилка: ${error.message}</p>`;
        }
    }

    function renderExpensesView(container) {
        container.innerHTML = `
            <div class="content-card">
                <h2>Додати загальну витрату</h2>
                <form id="add-expense-form">
                    <div class="form-row">
                        <div class="form-group" style="flex:2;"><label for="expense-description">Опис</label><input type="text" id="expense-description" required></div>
                        <div class="form-group" style="flex:1;"><label for="expense-amount">Сума (zł)</label><input type="number" id="expense-amount" required min="0" step="0.01"></div>
                        <div class="form-group" style="flex:1;"><label for="expense-date">Дата</label><input type="date" id="expense-date" required></div>
                    </div>
                    <button type="submit" class="btn">Додати витрату</button>
                </form>
            </div>
            <div class="content-card" style="margin-top:2rem;"><h2>Історія загальних витрат</h2><ul id="expenses-list" class="item-list"></ul></div>`;
        
        document.getElementById('add-expense-form').onsubmit = handleAddExpense;
        document.getElementById('expense-date').valueAsDate = new Date();
        const listEl = document.getElementById('expenses-list');
        listEl.innerHTML = '';
        if (state.expenses.length === 0) { listEl.innerHTML = '<li>Витрат ще не було.</li>'; } 
        else {
            state.expenses.forEach(expense => {
                const li = document.createElement('li');
                li.innerHTML = `<div><strong>${expense.description}</strong><br><small>${expense.timestamp.toDate().toLocaleDateString('uk-UA')}</small></div><div class="actions"><strong>${expense.amount.toFixed(2)} zł</strong><button class="btn btn-delete" data-id="${expense.id}" data-description="${expense.description}">🗑️</button></div>`;
                listEl.appendChild(li);
            });
        }
        listEl.onclick = (e) => { const deleteBtn = e.target.closest('.btn-delete'); if (deleteBtn) { handleDeleteExpense(deleteBtn.dataset.id, deleteBtn.dataset.description); } };
    }

    async function handleAddExpense(event) {
        event.preventDefault();
        const description = document.getElementById('expense-description').value.trim();
        const amount = parseFloat(document.getElementById('expense-amount').value);
        const date = document.getElementById('expense-date').value;
        if (!description || !amount || !date) { return showNotification("Будь ласка, заповніть усі поля.", "error"); }
        const action = () => addDoc(collection(db, 'expenses'), { description, amount, timestamp: Timestamp.fromDate(new Date(date)) });
        try {
            await logAndExecute('Додано загальну витрату', { description, amount }, action);
            event.target.reset();
            document.getElementById('expense-date').valueAsDate = new Date();
        } catch (e) { showNotification("Не вдалося додати витрату.", "error"); }
    }

    async function handleDeleteExpense(id, description) {
        showConfirmWithReasonModal('Ви впевнені, що хочете видалити цю витрату?', async (reason) => {
            const action = () => deleteDoc(doc(db, 'expenses', id));
            const logDetails = { expenseId: id, description };
            if (reason) logDetails.reason = reason;
            try { await logAndExecute('Видалено загальну витрату', logDetails, action); } 
            catch(e) { showNotification("Не вдалося видалити витрату.", "error"); }
        });
    }

    function renderSalonExpensesView(container) {
    const isSalonAdmin = state.user.role === 'salon_admin';
    const userSalonId = state.user.salonId;

    // Фільтруємо опції салонів, якщо це адмін салону
    const salonOptions = (isSalonAdmin ? state.salons.filter(s => s.id === userSalonId) : state.salons)
        .map(s => `<option value="${s.id}">${s.name}</option>`).join('');

    container.innerHTML = `
        <div class="content-card">
            <h2>Додати витрату в салоні</h2>
            <form id="add-salon-expense-form">
                <div class="form-row">
                    <div class="form-group" style="flex:2;"><label for="salon-expense-description">Опис</label><input type="text" id="salon-expense-description" required></div>
                    <div class="form-group" style="flex:1;"><label for="salon-expense-amount">Сума (zł)</label><input type="number" id="salon-expense-amount" required min="0" step="0.01"></div>
                    <div class="form-group" style="flex:1;"><label for="salon-expense-payment-type">Тип оплати</label><select id="salon-expense-payment-type" required><option value="cash">Готівка</option><option value="card">Картка</option></select></div>
                    <div class="form-group" style="flex:1;"><label for="salon-expense-date">Дата</label><input type="date" id="salon-expense-date" required></div>
                </div>
                <div class="form-group">
                    <label for="salon-expense-salon">Салон</label>
                    <select id="salon-expense-salon" required ${isSalonAdmin ? 'disabled' : ''}>
                        ${!isSalonAdmin ? '<option value="">Оберіть салон</option>' : ''}
                        ${salonOptions}
                    </select>
                </div>
                <button type="submit" class="btn">Додати витрату</button>
            </form>
        </div>
        <div class="content-card" style="margin-top:2rem;"><h2>Історія витрат в салонах</h2><ul id="salon-expenses-list" class="item-list"></ul></div>`;

    document.getElementById('add-salon-expense-form').onsubmit = handleAddSalonExpense;
    document.getElementById('salon-expense-date').valueAsDate = new Date();
    
    // Якщо це адмін салону, встановлюємо його салон за замовчуванням
    if (isSalonAdmin) {
        document.getElementById('salon-expense-salon').value = userSalonId;
    }

    const listEl = document.getElementById('salon-expenses-list');
    listEl.innerHTML = '';
    
    // Список витрат вже автоматично фільтрується в setupRealtimeListeners
    if (state.salonExpenses.length === 0) {
        listEl.innerHTML = '<li>Витрат ще не було.</li>';
    } else {
        state.salonExpenses.forEach(expense => {
            const salon = state.salons.find(s => s.id === expense.salonId);
            const li = document.createElement('li');
            const dateField = expense.date || expense.timestamp;
            const expenseDate = dateField ? dateField.toDate().toLocaleDateString('uk-UA') : 'Дата невідома';
            li.innerHTML = `<div><strong>${expense.description}</strong><br><small>${expenseDate} (${salon ? salon.name : 'Невідомий салон'})</small></div><div class="actions"><strong>${expense.amount.toFixed(2)} zł</strong>${state.user.role === 'admin' ? `<button class="btn btn-delete" data-id="${expense.id}" data-description="${expense.description}">🗑️</button>` : ''}</div>`;
            listEl.appendChild(li);
        });
    }

    listEl.onclick = (e) => {
        const deleteBtn = e.target.closest('.btn-delete');
        if (deleteBtn) {
            handleDeleteSalonExpense(deleteBtn.dataset.id, deleteBtn.dataset.description);
        }
    };
}

    async function handleAddSalonExpense(event) {
    event.preventDefault();
    const description = document.getElementById('salon-expense-description').value.trim();
    const amount = parseFloat(document.getElementById('salon-expense-amount').value);
    const date = document.getElementById('salon-expense-date').value;
    const paymentType = document.getElementById('salon-expense-payment-type').value;

    // Логіка визначення салону в залежності від ролі
    const salonId = state.user.role === 'salon_admin' 
        ? state.user.salonId 
        : document.getElementById('salon-expense-salon').value;

    if (!description || !amount || !date || !salonId) { 
        return showNotification("Будь ласка, заповніть усі поля.", "error"); 
    }

    const salon = state.salons.find(s => s.id === salonId);
    const action = () => addDoc(collection(db, 'salonExpenses'), { 
        description, 
        amount, 
        salonId, 
        paymentType, 
        authorEmail: state.user.email, 
        timestamp: Timestamp.fromDate(new Date(date)) 
    });
    
    try {
        await logAndExecute('Додано витрату салону', { description, amount, salon: salon.name }, action);
        event.target.reset();
        document.getElementById('salon-expense-date').valueAsDate = new Date();
        // Якщо це адмін салону, відновлюємо значення його салону
        if(state.user.role === 'salon_admin'){
            document.getElementById('salon-expense-salon').value = state.user.salonId;
        }
    } catch (e) { 
        showNotification("Не вдалося додати витрату.", "error"); 
    }
}
    
    async function handleDeleteSalonExpense(id, description) {
        showConfirmWithReasonModal('Ви впевнені, що хочете видалити цю витрату?', async (reason) => {
            const action = () => deleteDoc(doc(db, 'salonExpenses', id));
            const logDetails = { expenseId: id, description };
            if (reason) logDetails.reason = reason;
            try { await logAndExecute('Видалено витрату салону', logDetails, action); } 
            catch(e) { showNotification("Не вдалося видалити витрату.", "error"); }
        });
    }

    function renderNotepadView(container) {
        const entriesHtml = state.notepadEntries.map(entry => `
            <li data-id="${entry.id}">
                <div style="flex-grow: 1; word-break: break-word;"><p>${entry.content.replace(/\n/g, '<br>')}</p><small>${entry.authorEmail} - ${entry.timestamp ? entry.timestamp.toDate().toLocaleString('uk-UA') : 'Дата невідома'}</small></div>
                ${state.user.role === 'admin' ? `<div class="actions"><button class="btn btn-delete btn-delete-notepad">🗑️</button></div>` : ''}
            </li>`).join('');
        container.innerHTML = `
            <div class="content-card">
                <h2>Блокнот / Журнал записів</h2>
                <form id="add-notepad-entry-form">
                    <div class="form-group"><label for="notepad-content">Новий запис</label><textarea id="notepad-content" rows="4" required></textarea></div>
                    <button type="submit" class="btn">Додати запис</button>
                </form>
            </div>
            <div class="content-card"><h3>Останні записи</h3><ul id="notepad-entries" class="item-list">${entriesHtml || '<li>Записів ще не немає.</li>'}</ul></div>`;
        document.getElementById('add-notepad-entry-form').onsubmit = handleAddNotepadEntry;
        const listEl = document.getElementById('notepad-entries');
        if (listEl) {
            listEl.onclick = (event) => { const deleteBtn = event.target.closest('.btn-delete-notepad'); if (deleteBtn) { const entryId = deleteBtn.closest('li').dataset.id; handleDeleteNotepadEntry(entryId); } };
        }
    }

    async function handleAddNotepadEntry(event) {
        event.preventDefault();
        const contentInput = document.getElementById('notepad-content');
        const content = contentInput.value.trim();
        if (!content) return;
        const action = () => addDoc(collection(db, 'notepadEntries'), { content, authorEmail: state.user.email, timestamp: Timestamp.now() });
        try {
            await logAndExecute('Додано запис у блокнот', { content: content.substring(0, 50) + '...' }, action);
            contentInput.value = '';
        } catch (e) { showNotification("Не вдалося додати запис.", "error"); }
    }

    async function handleDeleteNotepadEntry(entryId) {
        if (!entryId) return;
        showConfirmWithReasonModal('Ви впевнені, що хочете видалити цей запис?', async (reason) => {
            const action = () => deleteDoc(doc(db, 'notepadEntries', entryId));
            const logDetails = { entryId };
            if (reason) logDetails.reason = reason;
            try { await logAndExecute('Видалено запис з блокноту', logDetails, action); } 
            catch (e) { showNotification("Не вдалося видалити запис.", "error"); }
        });
    }
    
    function renderShopView(container) {
        const salonOptions = state.salons.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        const paymentTypes = { cash: '💵', card: '💳', blik: '📱' };
        const recentSalesHtml = state.productSales.slice(0, 10).map(sale => {
            const salon = state.salons.find(s => s.id === sale.salonId);
            const saleDate = sale.timestamp ? sale.timestamp.toDate().toLocaleString('uk-UA') : 'Дата невідома';
            return `
                <li>
                    <div><strong>${sale.description}</strong><br><small>${saleDate} (${salon ? salon.name : 'Невідомий салон'})</small></div>
                    <div class="actions"><strong>${sale.amount.toFixed(2)} zł</strong><small>(${paymentTypes[sale.paymentType] || 'Н/Д'})</small>${state.user.role === 'admin' ? `<button class="btn btn-delete btn-delete-sale" data-id="${sale.id}" data-description="${sale.description}">🗑️</button>` : ''}</div>
                </li>`;
        }).join('');
        container.innerHTML = `
            <div class="content-card">
                <h2>Продаж товару</h2>
                <form id="add-product-sale-form">
                    <div class="form-group"><label for="product-sale-description">Назва або опис товару</label><input type="text" id="product-sale-description" required></div>
                    <div class="form-row">
                        <div class="form-group" style="flex:1;"><label for="product-sale-amount">Сума продажу (zł)</label><input type="number" id="product-sale-amount" required min="0" step="0.01"></div>
                        <div class="form-group" style="flex:1;"><label for="product-sale-payment-type">Тип оплати</label><select id="product-sale-payment-type" required><option value="cash">Готівка</option><option value="card">Картка</option><option value="blik">Blik</option></select></div>
                        <div class="form-group" style="flex:1;"><label for="product-sale-salon">Салон</label><select id="product-sale-salon" required><option value="">Оберіть салон</option>${salonOptions}</select></div>
                    </div>
                    <button type="submit" class="btn">Зареєструвати продаж</button>
                </form>
            </div>
            <div class="content-card" style="margin-top:2rem;"><h2>Останні продажі</h2><ul id="product-sales-list" class="item-list">${recentSalesHtml || '<li>Продажів ще не було.</li>'}</ul></div>`;
        document.getElementById('add-product-sale-form').onsubmit = handleAddProductSale;
        const salesList = document.getElementById('product-sales-list');
        if(salesList) {
            salesList.onclick = (event) => { const deleteBtn = event.target.closest('.btn-delete-sale'); if(deleteBtn) { handleDeleteProductSale(deleteBtn.dataset.id, deleteBtn.dataset.description); } };
        }
    }

    async function handleAddProductSale(event) {
        event.preventDefault();
        const description = document.getElementById('product-sale-description').value.trim();
        const amount = parseFloat(document.getElementById('product-sale-amount').value);
        const salonId = document.getElementById('product-sale-salon').value;
        const paymentType = document.getElementById('product-sale-payment-type').value;
        if (!description || !amount || amount <= 0 || !salonId || !paymentType) { return showNotification("Будь ласка, заповніть усі поля коректно.", "error"); }
        const salon = state.salons.find(s => s.id === salonId);
        const action = () => addDoc(collection(db, 'productSales'), { description, amount, salonId, paymentType, timestamp: Timestamp.now(), authorEmail: state.user.email });
        try {
            await logAndExecute('Зареєстровано продаж товару', { description, amount, salon: salon.name }, action);
            showNotification('Продаж успішно зареєстровано!');
            event.target.reset();
        } catch (e) { showNotification("Не вдалося зареєструвати продаж.", "error"); }
    }

    async function handleDeleteProductSale(saleId, description) {
        if(!saleId) return;
        showConfirmWithReasonModal('Ви впевнені, що хочете видалити цей продаж? Цю дію не можна скасувати.', async (reason) => {
            const action = () => deleteDoc(doc(db, "productSales", saleId));
            const logDetails = { saleId, description };
            if (reason) logDetails.reason = reason;
            try { await logAndExecute('Видалено продаж товару', logDetails, action); } 
            catch (e) { showNotification('Не вдалося видалити продаж.', "error"); }
        });
    }
    
    function renderSettingsView(container) {
        const salonOptions = state.salons.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        const salaryGroupOptions = state.salaryGroups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
        const groupsListHtml = state.salaryGroups.map(group => `<li data-group-id="${group.id}"><span><strong>${group.name}</strong></span><div class="actions"><button class="btn btn-edit btn-edit-group">Редагувати</button><button class="btn btn-delete btn-delete-group" data-name="${group.name}">Видалити</button></div></li>`).join('');
        const masterAssignmentHtml = state.masters.map(master => `<li data-master-id="${master.id}"><span>${master.name}</span><div class="actions"><select class="master-group-select"><option value="">Не призначено</option>${salaryGroupOptions}</select></div></li>`).join('');
        container.innerHTML = `
            <div class="content-card">
                <h2>Керування групами зарплат</h2><ul id="salary-groups-list" class="item-list">${groupsListHtml || "<li>Немає створених груп</li>"}</ul>
                <button id="add-new-group-btn" class="btn" style="margin-top: 1rem;">Створити нову групу</button>
            </div>
            <div class="content-card"><h2>Призначення груп майстрам</h2><ul id="master-group-assignment-list" class="item-list">${masterAssignmentHtml}</ul></div>
            <div class="content-card">
                <h2>Ручна відправка звіту</h2>
                <form id="manual-report-form">
                    <div class="form-row">
                        <div class="form-group" style="flex:1;"><label for="report-start-date">Дата початку</label><input type="date" id="report-start-date" required></div>
                        <div class="form-group" style="flex:1;"><label for="report-end-date">Дата кінця</label><input type="date" id="report-end-date" required></div>
                    </div>
                    <div class="form-group"><label for="report-salon-filter">Салон</label><select id="report-salon-filter"><option value="all">Всі салони (Разом)</option>${salonOptions}</select></div>
                    <button type="submit" class="btn">Відправити звіт</button>
                </form>
            </div>
            <div class="content-card">
                <h2>Зміна паролю</h2>
                <form id="change-password-form">
                    <div class="form-group"><label for="new-password">Новий пароль</label><input type="password" id="new-password" required minlength="6" autocomplete="new-password"></div>
                    <div class="form-group"><label for="confirm-password">Підтвердіть новий пароль</label><input type="password" id="confirm-password" required minlength="6" autocomplete="new-password"></div>
                    <button type="submit" class="btn">Змінити пароль</button>
                    <p id="password-change-status" style="margin-top: 1rem; color: var(--gray-text);"></p>
                </form>
            </div>`;
        
        document.getElementById('add-new-group-btn').onclick = () => showSalaryGroupModal();
        document.querySelectorAll('.btn-edit-group').forEach(btn => { btn.onclick = () => showSalaryGroupModal(btn.closest('li').dataset.groupId); });
        document.querySelectorAll('.btn-delete-group').forEach(btn => { btn.onclick = () => handleDeleteSalaryGroup(btn.closest('li').dataset.groupId, btn.dataset.name); });
        document.querySelectorAll('.master-group-select').forEach(select => {
            const masterId = select.closest('li').dataset.masterId;
            const master = state.masters.find(m => m.id === masterId);
            if (master && master.salaryGroupId) { select.value = master.salaryGroupId; }
            select.onchange = (e) => handleAssignGroupToMaster(masterId, e.target.value);
        });
        document.getElementById('manual-report-form').onsubmit = handleManualReport;
        document.getElementById('change-password-form').onsubmit = handleChangePassword;
    }

    function showSalaryGroupModal(groupId = null) {
        const modal = document.getElementById('salary-group-modal');
        const form = document.getElementById('salary-group-form');
        const title = document.getElementById('salary-group-modal-title');
        form.reset();
        const group = groupId ? state.salaryGroups.find(g => g.id === groupId) : null;
        title.textContent = group ? 'Редагувати групу' : 'Створити нову групу';
        document.getElementById('edit-salary-group-id').value = groupId || '';
        document.getElementById('salary-group-name').value = group ? group.name : '';
        renderSalaryGroupTiersInModal(group ? group.tiers : [{ threshold: 0, rate: 0 }]);
        document.getElementById('add-tier-to-group-btn').onclick = handleAddTierRowToModal;
        form.onsubmit = handleSaveSalaryGroup;
        modal.style.display = 'flex';
    }

    function renderSalaryGroupTiersInModal(tiers = []) {
        const container = document.getElementById('salary-group-tiers-table');
        container.innerHTML = '';
        tiers.sort((a, b) => a.threshold - b.threshold).forEach(tier => {
            const tierRow = document.createElement('div');
            tierRow.className = 'form-row';
            tierRow.innerHTML = `
                <div class="form-group" style="flex:1;"><label>Сума від (zł)</label><input type="number" class="tier-threshold" value="${tier.threshold}" min="0" required></div>
                <div class="form-group" style="flex:1;"><label>Відсоток (%)</label><input type="number" class="tier-rate" value="${tier.rate}" min="0" max="100" required></div>
                <button type="button" class="btn btn-delete remove-tier-btn">&times;</button>`;
            container.appendChild(tierRow);
        });
        document.querySelectorAll('.remove-tier-btn').forEach(btn => { btn.onclick = () => btn.closest('.form-row').remove(); });
    }

    function handleAddTierRowToModal() {
        const container = document.getElementById('salary-group-tiers-table');
        const tierRow = document.createElement('div');
        tierRow.className = 'form-row';
        tierRow.innerHTML = `
            <div class="form-group" style="flex:1;"><label>Сума від (zł)</label><input type="number" class="tier-threshold" value="0" min="0" required></div>
            <div class="form-group" style="flex:1;"><label>Відсоток (%)</label><input type="number" class="tier-rate" value="0" min="0" max="100" required></div>
            <button type="button" class="btn btn-delete remove-tier-btn">&times;</button>`;
        tierRow.querySelector('.remove-tier-btn').onclick = () => tierRow.remove();
        container.appendChild(tierRow);
    }

    async function handleSaveSalaryGroup(event) {
        event.preventDefault();
        const groupId = document.getElementById('edit-salary-group-id').value;
        const name = document.getElementById('salary-group-name').value.trim();
        if (!name) { return showNotification('Назва групи не може бути порожньою.', "error"); }
        const tiers = [];
        document.querySelectorAll('#salary-group-tiers-table .form-row').forEach(row => {
            const threshold = parseFloat(row.querySelector('.tier-threshold').value);
            const rate = parseFloat(row.querySelector('.tier-rate').value);
            if (!isNaN(threshold) && !isNaN(rate)) { tiers.push({ threshold, rate }); }
        });
        const data = { name, tiers: tiers.sort((a,b) => a.threshold - b.threshold) };
        try {
            if (groupId) {
                const action = () => updateDoc(doc(db, 'salaryGroups', groupId), data);
                await logAndExecute('Оновлено групу зарплат', { groupId, name }, action);
            } else {
                const action = () => addDoc(collection(db, 'salaryGroups'), data);
                await logAndExecute('Створено групу зарплат', { name }, action);
            }
            document.getElementById('salary-group-modal').style.display = 'none';
        } catch (e) { showNotification('Не вдалося зберегти групу.', "error"); }
    }

    async function handleDeleteSalaryGroup(groupId, name) {
        showConfirmWithReasonModal(`Ви впевнені, що хочете видалити групу "${name}"? Майстри, призначені до неї, залишаться без групи.`, async (reason) => {
            const action = () => deleteDoc(doc(db, 'salaryGroups', groupId));
            const logDetails = { groupId, name };
            if (reason) logDetails.reason = reason;
            try { await logAndExecute('Видалено групу зарплат', logDetails, action); } 
            catch(e) { showNotification('Не вдалося видалити групу.', "error"); }
        });
    }
    
    async function handleAssignGroupToMaster(masterId, groupId) {
        const master = state.masters.find(m => m.id === masterId);
        const group = state.salaryGroups.find(g => g.id === groupId);
        const action = () => updateDoc(doc(db, 'masters', masterId), { salaryGroupId: groupId || null });
        try { await logAndExecute('Призначено групу майстру', { master: master.name, group: group?.name || 'Не призначено' }, action); } 
        catch(e) { showNotification('Не вдалося призначити групу.', "error"); }
    }
    
    async function handleManualReport(event) {
        event.preventDefault();
        const btn = event.target.querySelector('button[type="submit"]');
        btn.disabled = true; btn.textContent = 'Відправка...';
        const startDate = document.getElementById('report-start-date').value;
        const endDate = document.getElementById('report-end-date').value;
        const salonId = document.getElementById('report-salon-filter').value;
        if (!startDate || !endDate) {
            showNotification('Будь ласка, оберіть обидві дати.', "error");
            btn.disabled = false; btn.textContent = 'Відправити звіт';
            return;
        }
        try {
            const generateReport = httpsCallable(functions, 'generateAndSendReport');
            const result = await generateReport({ startDate, endDate, salonId });
            await logAndExecute('Сформовано ручний звіт', { period: `${startDate} - ${endDate}` }, () => Promise.resolve());
            showNotification(result.data.message);
        } catch (error) {
            console.error("Помилка виклику хмарної функції:", error);
            showNotification(`Помилка: ${error.message}`, "error");
        } finally {
            btn.disabled = false;
            btn.textContent = 'Відправити звіт';
        }
    }
    
    async function handleChangePassword(event) {
        event.preventDefault();
        const newPasswordInput = document.getElementById('new-password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const statusEl = document.getElementById('password-change-status');
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        if (newPassword.length < 6) { statusEl.textContent = 'Пароль має бути не менше 6 символів.'; statusEl.style.color = 'var(--danger-color)'; return; }
        if (newPassword !== confirmPassword) { statusEl.textContent = 'Паролі не співпадають.'; statusEl.style.color = 'var(--danger-color)'; return; }
        const user = auth.currentUser;
        if (!user) { statusEl.textContent = 'Помилка: користувач не автентифікований.'; statusEl.style.color = 'var(--danger-color)'; return; }
        statusEl.textContent = 'Зміна паролю...';
        statusEl.style.color = 'var(--gray-text)';
        try {
            await logAndExecute('Змінено пароль', { user: user.email }, () => updatePassword(user, newPassword));
            statusEl.textContent = 'Пароль успішно змінено!';
            statusEl.style.color = 'var(--success-color)';
            newPasswordInput.value = '';
            confirmPasswordInput.value = '';
        } catch (error) {
            if (error.code === 'auth/requires-recent-login') { statusEl.textContent = 'Ця операція вимагає нещодавнього входу. Будь ласка, вийдіть і увійдіть знову.'; } 
            else { statusEl.textContent = `Помилка: ${error.message}`; }
            statusEl.style.color = 'var(--danger-color)';
        }
    }
    // #endregion

</script>
</body>
</html>
